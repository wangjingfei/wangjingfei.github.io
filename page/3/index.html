<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-2016-08-14-how-to-support-full-unicode-in-mysql" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-14-how-to-support-full-unicode-in-mysql/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-14-how-to-support-full-unicode-in-mysql/">How to support full Unicode in MySQL databases</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>如果你完全从头建立一个数据库，那么事情简单了很多，直接参考：<a href="/2016/08/14/create-mysql-database-with-utf8mb4.html">创建支持emoji表情的MySQL数据库（utf8mb4）</a>。</p>
<p>如果你的数据库已经在投入使用，那么可以参考文章的以下部分。</p>
<blockquote>
<p><strong>Reference:</strong> <a target="_blank" rel="noopener" href="https://mathiasbynens.be/notes/mysql-utf8mb4">https://mathiasbynens.be/notes/mysql-utf8mb4</a></p>
</blockquote>
<h2 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h2><p><a target="_blank" rel="noopener" href="https://encoding.spec.whatwg.org/#utf-8">The UTF-8 encoding</a> can represent every symbol in the Unicode character set, which ranges from <code>U+000000</code> to <code>U+10FFFF</code>. That’s 1,114,112 possible symbols. (Not all of these Unicode code points have been assigned characters yet, but that doesn’t stop UTF-8 from being able to encode them.)</p>
<p>UTF-8 is a variable-width encoding; it encodes each symbol using <strong>one to four 8-bit bytes</strong>. Symbols with lower numerical code point values are encoded using fewer bytes. This way, UTF-8 is optimized for the common case where ASCII characters and other <a target="_blank" rel="noopener" href="https://mathiasbynens.be/notes/javascript-encoding#bmp">BMP symbols</a> (whose code points range from <code>U+000000</code> to <code>U+00FFFF</code>) are used — while still allowing astral symbols (whose code points range from <code>U+010000</code> to <code>U+10FFFF</code>) to be stored.</p>
<h2 id="MySQL’s-utf8"><a href="#MySQL’s-utf8" class="headerlink" title="MySQL’s utf8"></a>MySQL’s <code>utf8</code></h2><p>MySQL’s utf8 charset only partially implements proper UTF-8 encoding. It can only store UTF-8-encoded symbols that consist of one to three bytes; encoded symbols that take up four bytes aren’t supported.</p>
<p>Since astral symbols (whose code points range from U+010000 to U+10FFFF) each consist of four bytes in UTF-8, you cannot store them using MySQL’s utf8 implementation. And if you are doing so, you’ll get the following warning:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW WARNINGS;</span><br><span class="line">+---------+------+------------------------------------------------------------------------------+</span><br><span class="line">| Level   | Code | Message                                                                      |</span><br><span class="line">+---------+------+------------------------------------------------------------------------------+</span><br><span class="line">| Warning | 1366 | Incorrect string value: &#39;\xF0\x9D\x8C\x86&#39; for column &#39;column_name&#39; at row 1 |</span><br><span class="line">+---------+------+------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>this behavior can lead to data loss, but it gets worse — it can result in security vulnerabilities. Here are some examples, all of which were discovered after publishing this write-up:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://tom.vg/2013/09/wordpress-php-object-injection/">PHP object injection vulnerability in WordPress &lt; 3.6.1</a>, leading to <a target="_blank" rel="noopener" href="https://tom.vg/2013/12/wordpress-rce-exploit/">remote code execution in combination with certain WordPress plugins</a></li>
<li><a target="_blank" rel="noopener" href="https://hackerone.com/reports/2233">Email authentication bypass in Phabricator</a></li>
<li><a target="_blank" rel="noopener" href="https://cedricvb.be/post/wordpress-stored-xss-vulnerability-4-1-2/">Stored XSS in WordPress 4.1.2</a></li>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/netsec/comments/3wt0yk/critical_0day_remote_command_execution/cxz2qtc">Remote command execution in the Joomla! CMS</a></li>
</ol>
<p>MySQL’s <code>utf8</code> encoding is awkwardly named, as it’s different from proper UTF-8 encoding. It doesn’t offer full Unicode support, which can lead to data loss or security vulnerabilities.</p>
<h2 id="MySQL’s-utf8mb4"><a href="#MySQL’s-utf8mb4" class="headerlink" title="MySQL’s utf8mb4"></a>MySQL’s <code>utf8mb4</code></h2><p>Luckily, <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/relnotes/mysql/5.5/en/news-5-5-3.html">MySQL 5.5.3 (released in early 2010)</a> introduced a new encoding called utf8mb4 which maps to proper UTF-8 and thus fully supports Unicode, including astral symbols.</p>
<h3 id="Switching-from-MySQL’s-utf8-to-utf8mb4"><a href="#Switching-from-MySQL’s-utf8-to-utf8mb4" class="headerlink" title="Switching from MySQL’s utf8 to utf8mb4"></a>Switching from MySQL’s <code>utf8</code> to <code>utf8mb4</code></h3><p><strong>Step 1: Create a backup</strong></p>
<p>Create a backup of all the databases on the server you want to upgrade. Safety first!</p>
<p><strong>Step 2: Upgrade the MySQL server</strong></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/mysql/">Upgrade the MySQL server to v5.5.3+</a>, or ask your server administrator to do it for you.</p>
<p><strong>Step 3: Modify databases, tables, and columns</strong></p>
<p>Change the character set and collation properties of the databases, tables, and columns to use <code>utf8mb4</code> instead of <code>utf8</code>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">For</span> <span class="keyword">each</span> database:</span><br><span class="line"><span class="keyword">ALTER</span> DATABASE database_name <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_unicode_ci;</span><br><span class="line"># <span class="keyword">For</span> <span class="keyword">each</span> <span class="keyword">table</span>:</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"># <span class="keyword">For</span> <span class="keyword">each</span> <span class="keyword">column</span>:</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name CHANGE column_name column_name <span class="type">VARCHAR</span>(<span class="number">191</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"># (Don’t blindly <span class="keyword">copy</span><span class="operator">-</span>paste this<span class="operator">!</span> The exact statement depends <span class="keyword">on</span> the <span class="keyword">column</span> type, maximum length, <span class="keyword">and</span> other properties. The above line <span class="keyword">is</span> just an example <span class="keyword">for</span> a `<span class="type">VARCHAR</span>` column.)</span><br></pre></td></tr></table></figure>
<p>Since <code>utf8mb4</code> is fully backwards compatible with <code>utf8</code>, no mojibake or other forms of data loss should occur. (But you have a backup, right?)</p>
<p><strong>Step 4: Check the maximum length of columns and index keys</strong></p>
<p>This is probably the most tedious part of the whole upgrading process.</p>
<p>When converting from <code>utf8</code> to <code>utf8mb4</code>, the maximum length of a column or index key is unchanged in terms of bytes. Therefore, it is smaller in terms of characters, because the maximum length of a character is now four bytes instead of three.</p>
<p>For example, a <code>TINYTEXT</code> column can hold up to 255 bytes, which correlates to 85 three-byte or 63 four-byte characters. Let’s say you have a <code>TINYTEXT</code> column that uses <code>utf8</code> but must be able to contain more than 63 characters. Given this requirement, you can’t convert this column to <code>utf8mb4</code> unless you also change the data type to a longer type such as <code>TEXT</code> — because if you’d try to fill it with four-byte characters, you’d only be able to enter 63 characters, but not more.</p>
<p>The same goes for index keys. The InnoDB storage engine has a maximum index length of 767 bytes, so for <code>utf8</code> or <code>utf8mb4</code> columns, you can index a maximum of 255 or 191 characters, respectively. If you currently have <code>utf8</code> columns with indexes longer than 191 characters, you will need to index a smaller number of characters when using <code>utf8mb4</code>. (Because of this, I had to change some indexed VARCHAR(255) columns to VARCHAR(191).)</p>
<p><strong>Step 5: Modify connection, client, and server character sets</strong></p>
<p>In your application code, set the connection character set to utf8mb4. This can be done by simply replacing any variants of <code>SET NAMES utf8</code> with <code>SET NAMES utf8mb4</code>. If your old <code>SET NAMES</code> statement specified the collation, make sure to change that as well, e.g. <code>SET NAMES utf8 COLLATE utf8_unicode_ci</code> becomes <code>SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci</code>.</p>
<p>Make sure to set the client and server character set as well. I have the following in my MySQL configuration file (/etc/my.cnf):</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">character-set-client-handshake</span> = <span class="literal">FALSE</span></span><br><span class="line"><span class="attr">character-set-server</span> = utf8mb4</span><br><span class="line"><span class="attr">collation-server</span> = utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>

<p>You can easily confirm these settings work correctly:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES WHERE Variable_name LIKE &#39;character\_set\_%&#39; OR Variable_name LIKE &#39;collation%&#39;;</span><br><span class="line">+--------------------------+--------------------+</span><br><span class="line">| Variable_name            | Value              |</span><br><span class="line">+--------------------------+--------------------+</span><br><span class="line">| character_set_client     | utf8mb4            |</span><br><span class="line">| character_set_connection | utf8mb4            |</span><br><span class="line">| character_set_database   | utf8mb4            |</span><br><span class="line">| character_set_filesystem | binary             |</span><br><span class="line">| character_set_results    | utf8mb4            |</span><br><span class="line">| character_set_server     | utf8mb4            |</span><br><span class="line">| character_set_system     | utf8               |</span><br><span class="line">| collation_connection     | utf8mb4_unicode_ci |</span><br><span class="line">| collation_database       | utf8mb4_unicode_ci |</span><br><span class="line">| collation_server         | utf8mb4_unicode_ci |</span><br><span class="line">+--------------------------+--------------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>As you can see, all the relevant options are set to utf8mb4, except for <code>character_set_filesystem</code> which should be binary unless you’re on a file system that supports multi-byte UTF-8-encoded characters in file names, and <code>character_set_system</code> which is always utf8 and can’t be overridden.</p>
<p><strong>Step 6: Repair and optimize all tables</strong></p>
<p>You only need this when you meet some wired bugs. The details are in the reference: <a target="_blank" rel="noopener" href="https://mathiasbynens.be/notes/mysql-utf8mb4">How to support full Unicode in MySQL databases</a></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Never use <code>utf8</code> in MySQL — always use <code>utf8mb4</code> instead. Updating your databases and code might take some time, but it’s definitely worth the effort. Why would you arbitrarily limit the set of symbols that can be used in your database? Why would you lose data every time a user enters an astral symbol as part of a comment or message or whatever it is you store in your database? There’s no reason not to strive for full Unicode support everywhere. Do the right thing, and use utf8mb4. 🍻</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-14-how-to-support-full-unicode-in-mysql/" data-id="cklf7tst6001iz8t4c98ocb7w" data-title="How to support full Unicode in MySQL databases" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Emoji/" rel="tag">Emoji</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/utf8mb4/" rel="tag">utf8mb4</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-14-linux-commands" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-14-linux-commands/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-14-linux-commands/">Linux常用命令</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>注意：</strong>常用命令中，会有一些命令仅限于特定的操作系统使用，如Ubuntu或CentOS等特定的Linux发行版本。</p>
<h2 id="系统相关"><a href="#系统相关" class="headerlink" title="系统相关"></a>系统相关</h2><h3 id="显示当前内核版本"><a href="#显示当前内核版本" class="headerlink" title="显示当前内核版本"></a>显示当前内核版本</h3><p>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-PC:~$ uname -a</span><br><span class="line">Linux fify-PC 4.4.0-31-generic #50-Ubuntu SMP Wed Jul 13 00:07:12 UTC 2016 x86_64 x86_64 x86_64 GNU&#x2F;Linux</span><br></pre></td></tr></table></figure>

<h3 id="显示当前Ubuntu的系统版本"><a href="#显示当前Ubuntu的系统版本" class="headerlink" title="显示当前Ubuntu的系统版本"></a>显示当前Ubuntu的系统版本</h3><p>命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-PC:~$ lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 16.04.1 LTS</span><br><span class="line">Release:        16.04</span><br><span class="line">Codename:       xenial</span><br></pre></td></tr></table></figure>

<h2 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h2><h3 id="显示当前登录的用户名"><a href="#显示当前登录的用户名" class="headerlink" title="显示当前登录的用户名"></a>显示当前登录的用户名</h3><p>命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-PC:~$ whoami</span><br><span class="line">fify</span><br></pre></td></tr></table></figure>
<p>这个命令在组合其他命令一起使用的时候会比较好用，比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker $(whoami)</span><br></pre></td></tr></table></figure>

<h3 id="查看用户所属的组"><a href="#查看用户所属的组" class="headerlink" title="查看用户所属的组"></a>查看用户所属的组</h3><p>可以查看当前用户的组或者指定用户所属的组。</p>
<h4 id="查看当前用户所属的组"><a href="#查看当前用户所属的组" class="headerlink" title="查看当前用户所属的组"></a>查看当前用户所属的组</h4><p>命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groups</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-PC:~$ groups</span><br><span class="line">fify adm cdrom sudo dip plugdev lpadmin sambashare</span><br></pre></td></tr></table></figure>

<h4 id="查看其他用户所属的组"><a href="#查看其他用户所属的组" class="headerlink" title="查看其他用户所属的组"></a>查看其他用户所属的组</h4><p>命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groups fify</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-PC:~$ groups fify</span><br><span class="line">fify : fify adm cdrom sudo dip plugdev lpadmin sambashare docker</span><br></pre></td></tr></table></figure>

<h4 id="以其他用户的身份执行命令"><a href="#以其他用户的身份执行命令" class="headerlink" title="以其他用户的身份执行命令"></a>以其他用户的身份执行命令</h4><p>以下命令以jenkins用户的身份执行<code>jstack 36730</code>命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u jenkins -H jstack 36730</span><br></pre></td></tr></table></figure>

<h2 id="实用工具"><a href="#实用工具" class="headerlink" title="实用工具"></a>实用工具</h2><h3 id="文字处理"><a href="#文字处理" class="headerlink" title="文字处理"></a>文字处理</h3><h4 id="替换某行中间的文字"><a href="#替换某行中间的文字" class="headerlink" title="替换某行中间的文字"></a>替换某行中间的文字</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e <span class="string">&#x27;s/\(.*\)wrapper.daemonize=FALSE\(.*\)/\1wrapper.daemonize=TRUE\2/g&#x27;</span> -i mycat</span><br></pre></td></tr></table></figure>
<p>替换mycat文件中包含<code>wrapper.daemonize=FALSE</code>的行，并把<code>wrapper.daemonize=FALSE</code>替换为<code>wrapper.daemonize=TRUE</code>。</p>
<h4 id="查看文件的第m-n行"><a href="#查看文件的第m-n行" class="headerlink" title="查看文件的第m-n行"></a>查看文件的第m-n行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;5,10p&#x27;</span> filename</span><br></pre></td></tr></table></figure>
<p>这样你就可以只查看文件的第5行到第10行。</p>
<h4 id="删除文件的某一行"><a href="#删除文件的某一行" class="headerlink" title="删除文件的某一行"></a>删除文件的某一行</h4><p>删除文件的第三行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;3d&#x27;</span> 1.txt</span><br></pre></td></tr></table></figure>
<p>删除文件的第三至第五行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;3,5d&#x27;</span> 1.txt</span><br></pre></td></tr></table></figure>
<p>删除符合特定正则表达式的行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;/^Love/d&#x27;</span> 1.txt</span><br></pre></td></tr></table></figure>
<h4 id="在sed正则表达式匹配中使用Lazy策略："><a href="#在sed正则表达式匹配中使用Lazy策略：" class="headerlink" title="在sed正则表达式匹配中使用Lazy策略："></a>在<code>sed</code>正则表达式匹配中使用Lazy策略：</h4><p><code>sed</code>命令的正则表达式并不支持懒匹配，但是我们可以通过绕过的方法来做。比如我要查找以下内容中”和”之间的单词：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;departmentId&quot; bigint(20) NOT NULL,</span><br><span class="line">&quot;departmentName&quot; varchar(128) COLLATE utf8mb4_unicode_ci DEFAULT NULL,</span><br><span class="line">&quot;monthly&quot; varchar(10) COLLATE utf8mb4_unicode_ci NOT NULL,</span><br><span class="line">&quot;positionName&quot; varchar(100) COLLATE utf8mb4_unicode_ci DEFAULT NULL,</span><br><span class="line">&quot;staffId&quot; varchar(40) COLLATE utf8mb4_unicode_ci NOT NULL,</span><br></pre></td></tr></table></figure>
<p>那么我们可以通过`”[^&quot;]*”查找””之间的内容。如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -e <span class="string">&#x27;s/&quot;\([^&quot;]*\)&quot;[^,]*,/\1,/g&#x27;</span></span><br></pre></td></tr></table></figure>
<p>可以获取到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;departmentId&quot;,</span><br><span class="line">&quot;departmentName&quot;,</span><br><span class="line">&quot;monthly&quot;,</span><br><span class="line">&quot;positionName&quot;,</span><br><span class="line">&quot;staffId&quot;,</span><br></pre></td></tr></table></figure>

<h3 id="文件工具"><a href="#文件工具" class="headerlink" title="文件工具"></a>文件工具</h3><h4 id="获取目录中最新的文件"><a href="#获取目录中最新的文件" class="headerlink" title="获取目录中最新的文件"></a>获取目录中最新的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls *.war -Art | tail -n 1</span><br></pre></td></tr></table></figure>

<h4 id="查看文件类型"><a href="#查看文件类型" class="headerlink" title="查看文件类型"></a>查看文件类型</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file xxxx.jpg</span><br></pre></td></tr></table></figure>

<p><code>file</code>命令不跟据文件后缀名判断文件类型，而是根据文件最头部的几位Magic Number进行判断。对于乱改文件后缀的情况非常适合。</p>
<p>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-Vostro-3902:~&#x2F;Desktop$ file 1945300044.png</span><br><span class="line">1945300044.png: JPEG image data</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-14-linux-commands/" data-id="cklf7tst7001lz8t4f50868r6" data-title="Linux常用命令" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Script/" rel="tag">Script</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-19-monitor-tomcat-in-docker" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-19-monitor-tomcat-in-docker/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-19-monitor-tomcat-in-docker/">使用Moint监控Docker中运行的Web服务器</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Monit是一个Linux系统中常用的监控软件，可以监控CPU、内存、文件系统、TCP端口、UDP端口、HTTP等基本上所有的资源。可以参考其官方网站：<a target="_blank" rel="noopener" href="https://mmonit.com/monit/%E3%80%82">https://mmonit.com/monit/。</a></p>
<p>本次要对Docker（Docker中运行了一个Web服务器）进行监控，需要满足以下几个需求：</p>
<ol>
<li>当Docker挂掉的时候自动启动；</li>
<li>当Docker中的Web服务器300秒内无响应的时候重启Docker；</li>
<li>当Docker发生异常或者重启时，发送邮件警告通知。</li>
</ol>
<h2 id="安装Moint软件"><a href="#安装Moint软件" class="headerlink" title="安装Moint软件"></a>安装Moint软件</h2><p>Moint的安装比较容易，如果使用Ubuntu/Debian，则可以直接执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install monit</span><br></pre></td></tr></table></figure>
<p>如果使用源代码编译安装，则是经典三部曲：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><p>这里只提及几个比较重要的设置，其他设置可以参考Linux手册。</p>
<h3 id="监控进程检查周期"><a href="#监控进程检查周期" class="headerlink" title="监控进程检查周期"></a>监控进程检查周期</h3><p>默认为120秒检查一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">###############################################################################</span><br><span class="line">## Global section</span><br><span class="line">###############################################################################</span><br><span class="line">##</span><br><span class="line">## Start Monit in the background (run as a daemon):</span><br><span class="line">#</span><br><span class="line">  set daemon 30            # check services at 30-seconds intervals</span><br><span class="line">#   with start delay 120   # optional: delay the first check by 4-minutes (by</span><br><span class="line">#                          # default Monit check immediately after Monit start)</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<h3 id="使用本地Sendmail发送邮件"><a href="#使用本地Sendmail发送邮件" class="headerlink" title="使用本地Sendmail发送邮件"></a>使用本地Sendmail发送邮件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## Set the list of mail servers for alert delivery. Multiple servers may be </span><br><span class="line">## specified using a comma separator. If the first mail server fails, Monit </span><br><span class="line"># will use the second mail server in the list and so on. By default Monit uses </span><br><span class="line"># port 25 - it is possible to override this with the PORT option.</span><br><span class="line">#</span><br><span class="line"># set mailserver mail.bar.baz,               # primary mailserver</span><br><span class="line">#                backup.bar.baz port 10025,  # backup mailserver on port 10025</span><br><span class="line">#                localhost                   # fallback relay</span><br><span class="line"> set mailserver localhost               # primary mailserver</span><br></pre></td></tr></table></figure>
<h3 id="邮件发件人"><a href="#邮件发件人" class="headerlink" title="邮件发件人"></a>邮件发件人</h3><p>我用来区别是哪台服务器发送的报警</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## You can override this message format or parts of it, such as subject</span><br><span class="line">## or sender using the MAIL-FORMAT statement. Macros such as $DATE, etc.</span><br><span class="line">## are expanded at runtime. For example, to override the sender, use:</span><br><span class="line">#</span><br><span class="line"> set mail-format &#123; from: node1@anying.me &#125;</span><br></pre></td></tr></table></figure>
<h3 id="报警邮件接收人"><a href="#报警邮件接收人" class="headerlink" title="报警邮件接收人"></a>报警邮件接收人</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## You can set alert recipients whom will receive alerts if&#x2F;when a </span><br><span class="line">## service defined in this file has errors. Alerts may be restricted on </span><br><span class="line">## events by using a filter as in the second example below. </span><br><span class="line">#</span><br><span class="line"> set alert fify@xiaotanzhu.com                       # receive all alerts</span><br></pre></td></tr></table></figure>
<h3 id="监控的Web服务"><a href="#监控的Web服务" class="headerlink" title="监控的Web服务"></a>监控的Web服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">## Monit has an embedded web server which can be used to view status of </span><br><span class="line">## services monitored and manage services from a web interface. See the</span><br><span class="line">## Monit Wiki if you want to enable SSL for the web server. </span><br><span class="line">#</span><br><span class="line"> set httpd port 2812 and</span><br><span class="line">    use address localhost  # only accept connection from localhost</span><br><span class="line">    allow localhost        # allow localhost to connect to the server and</span><br><span class="line">    allow admin:monit      # require user &#39;admin&#39; with password &#39;monit&#39;</span><br><span class="line">    allow @monit           # allow users of group &#39;monit&#39; to connect (rw)</span><br><span class="line">    allow @users readonly  # allow users of group &#39;users&#39; to connect readonly</span><br></pre></td></tr></table></figure>

<h2 id="监听Docker服务"><a href="#监听Docker服务" class="headerlink" title="监听Docker服务"></a>监听Docker服务</h2><p>在<code>/etc/monit/conf.d</code>目录下增加监控文件<code>irenshi-web</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">check process irenshi-web matching &quot;docker-proxy.*-host-port 8081.*&quot;</span><br><span class="line">  start program &quot;&#x2F;usr&#x2F;bin&#x2F;docker start irenshi-web&quot;</span><br><span class="line">  stop  program &quot;&#x2F;usr&#x2F;bin&#x2F;docker stop irenshi-web&quot;</span><br><span class="line">  if failed host localhost port 8081 protocol http request &quot;&#x2F;web&#x2F;&quot; for 10 times within 12 cycles then restart</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>irenshi-web</code>为监控项目名称，这个名称将显示在报警邮件中。另外，启动和关闭项目也需要使用该名称，见<a href="#%E9%9C%80%E8%A6%81%E5%81%9C%E6%AD%A2Docker%E6%97%B6">需要停止Docker时</a></li>
<li><code>matching &quot;docker-proxy.*-host-port 8081.*&quot;</code>通过正则表达式来识别进程。通常情况下可以使用pidfile来识别进程，但Docker的实例没有进程pidfile，所以我们通过正则表达式匹配进程。Monit判断进程是否存在的时候会根据该正则表达式进行进程名搜索。</li>
<li><code>start program</code>启动进程的方法，这里必须使用完整路径<code>/usr/bin/docker</code>，否则会无法找到命令</li>
<li><code>stop program</code>关闭进程的方法。当Monit执行重启的时候，会先调用<code>stop program</code>，然后再调用<code>start program</code></li>
<li><code>if failed host localhost port 8081 protocol http request &quot;/web/&quot; for 10 times within 12 cycles then restart</code><ol>
<li><code>if failed</code>指定访问失败时的情形。当进程还在，但是Web服务器已经挂掉时，会触发<code>fail</code></li>
<li><code>localhost port 8081</code>监听本地的8081端口，这是Docker映射给主机的端口</li>
<li><code>protocol http request &quot;/web/&quot;</code>使用HTTP协议请求<code>/web/</code>这个页面</li>
<li><code>for 10 times within 12 cycles</code>出现次数设定：在12个检测周期中，如果出现了10次无法访问</li>
<li><code>then restart</code>满足以上条件时执行的操作，这里执行<code>restart</code></li>
</ol>
</li>
</ul>
<p>备注：Docker的完整进程名为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 8081 -container-ip 192.168.42.253 -container-port 8080</span><br></pre></td></tr></table></figure>
<p>由于同一台机器上启动了若干个Docker，为防止干扰我们采用了取巧的方法，用<code>-host-port 8086</code>来识别进程实例。</p>
<h2 id="需要停止Docker时"><a href="#需要停止Docker时" class="headerlink" title="需要停止Docker时"></a>需要停止Docker时</h2><p>如果使用<code>docker stop irenshi-web</code>命令停止Docker的话，Monit检测到应用不存在会立即重新启动。所以应该使用以下命令关闭Docker：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monit -c /etc/monit/monitrc stop irenshi-web</span><br></pre></td></tr></table></figure>

<p>如果需要重新启动，则对应执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monit -c /etc/monit/monitrc start irenshi-web</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-19-monitor-tomcat-in-docker/" data-id="cklf7tst9001pz8t4e91yguwu" data-title="使用Moint监控Docker中运行的Web服务器" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Moint/" rel="tag">Moint</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%9B%91%E6%8E%A7/" rel="tag">监控</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-23-create-db-user-in-mysql" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-23-create-db-user-in-mysql/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-23-create-db-user-in-mysql/">在MySQL中创建库和用户</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE `irenshi` <span class="keyword">DEFAULT</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>

<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;irenshi&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;irenshi&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="授权数据库访问"><a href="#授权数据库访问" class="headerlink" title="授权数据库访问"></a>授权数据库访问</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> irenshi.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;irenshi&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-23-create-db-user-in-mysql/" data-id="cklf7tstb001tz8t4cj31exwp" data-title="在MySQL中创建库和用户" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-06-16-delete-keys-in-batch-redis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-06-16-delete-keys-in-batch-redis/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-06-16-delete-keys-in-batch-redis/">批量删除Redis数据库中的Key</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>转载自：<a target="_blank" rel="noopener" href="http://img.snail8.com/?p=502">http://img.snail8.com/?p=502</a></p>
</blockquote>
<p>Redis中有删除单个Key的指令<code>DEL</code>，但好像没有批量删除Key的指令，不过我们可以借助Linux的<code>xargs</code>指令来完成这个动作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli keys <span class="string">&quot;*&quot;</span> | xargs redis-cli del</span><br><span class="line"><span class="comment"># 如果redis-cli没有设置成系统变量，需要指定redis-cli的完整路径</span></span><br><span class="line"><span class="comment"># 如：/opt/redis/redis-cli keys &quot;*&quot; | xargs /opt/redis/redis-cli del</span></span><br></pre></td></tr></table></figure>

<p>如果要指定 Redis 数据库访问密码，使用下面的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a password keys <span class="string">&quot;*&quot;</span> | xargs redis-cli -a password del</span><br></pre></td></tr></table></figure>

<p>如果要访问 Redis 中特定的数据库，使用下面的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面的命令指定数据序号为0，即默认数据库</span></span><br><span class="line">redis-cli -n 0 keys <span class="string">&quot;*&quot;</span> | xargs redis-cli -n 0 del</span><br></pre></td></tr></table></figure>

<p>删除所有Key，可以使用Redis的flushdb和flushall命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除当前数据库中的所有Key</span></span><br><span class="line">flushdb</span><br><span class="line"><span class="comment"># 删除所有数据库中的key</span></span><br><span class="line">flushall</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-06-16-delete-keys-in-batch-redis/" data-id="cklf7tssc0001z8t48qi103ky" data-title="批量删除Redis数据库中的Key" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-25-mysql-basic-config" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-25-mysql-basic-config/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-25-mysql-basic-config/">MySQL服务器配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>MySQL版本信息：</p>
<blockquote>
<p>mysqld  Ver 5.6.31-0ubuntu0.14.04.2 for debian-linux-gnu on x86_64 ((Ubuntu))</p>
</blockquote>
<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># The MySQL database server configuration file.</span><br><span class="line">#</span><br><span class="line"># You can copy this to one of:</span><br><span class="line"># - &quot;/etc/mysql/my.cnf&quot; to set global options,</span><br><span class="line"># - &quot;~/.my.cnf&quot; to set user-specific options.</span><br><span class="line"># </span><br><span class="line"># One can use all long options that the program supports.</span><br><span class="line"># Run program with --help to get a list of available options and with</span><br><span class="line"># --print-defaults to see which it would actually understand and use.</span><br><span class="line">#</span><br><span class="line"># For explanations see</span><br><span class="line"># http://dev.mysql.com/doc/mysql/en/server-system-variables.html</span><br><span class="line"></span><br><span class="line"># This will be passed to all mysql clients</span><br><span class="line"># It has been reported that passwords should be enclosed with ticks/quotes</span><br><span class="line"># escpecially if they contain &quot;#&quot; chars...</span><br><span class="line"># Remember to edit /etc/mysql/debian.cnf when changing the socket location.</span><br><span class="line">[client]</span><br><span class="line">port            = 3306</span><br><span class="line">socket          = /var/run/mysqld/mysqld.sock</span><br><span class="line"><span class="addition">+ default-character-set = utf8mb4</span></span><br><span class="line"></span><br><span class="line"># Here is entries for some specific programs</span><br><span class="line"># The following values assume you have at least 32M ram</span><br><span class="line"></span><br><span class="line"># This was formally known as [safe_mysqld]. Both versions are currently parsed.</span><br><span class="line">[mysqld_safe]</span><br><span class="line">socket          = /var/run/mysqld/mysqld.sock</span><br><span class="line">nice            = 0</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">#</span><br><span class="line"># * Basic Settings</span><br><span class="line">#</span><br><span class="line"><span class="addition">+ skip-host-cache</span></span><br><span class="line">user            = mysql</span><br><span class="line">pid-file        = /var/run/mysqld/mysqld.pid</span><br><span class="line">socket          = /var/run/mysqld/mysqld.sock</span><br><span class="line">port            = 3306</span><br><span class="line">basedir         = /usr</span><br><span class="line">datadir         = /var/lib/mysql</span><br><span class="line">tmpdir          = /tmp</span><br><span class="line">lc-messages-dir = /usr/share/mysql</span><br><span class="line"><span class="addition">+ explicit_defaults_for_timestamp</span></span><br><span class="line">skip-external-locking</span><br><span class="line">#</span><br><span class="line"># Instead of skip-networking the default is now to listen only on</span><br><span class="line"># localhost which is more compatible and is not less secure.</span><br><span class="line"><span class="deletion">- bind-address           = 127.0.0.1</span></span><br><span class="line"><span class="addition">+ #bind-address           = 127.0.0.1</span></span><br><span class="line">#</span><br><span class="line"># * Fine Tuning</span><br><span class="line">#</span><br><span class="line">key_buffer              = 16M</span><br><span class="line">max_allowed_packet      = 16M</span><br><span class="line">thread_stack            = 192K</span><br><span class="line">thread_cache_size       = 8</span><br><span class="line"># This replaces the startup script and checks MyISAM tables if needed</span><br><span class="line"># the first time they are touched</span><br><span class="line">myisam-recover         = BACKUP</span><br><span class="line"><span class="deletion">- #max_connections        = 100</span></span><br><span class="line"><span class="addition">+ max_connections        = 1000</span></span><br><span class="line">#table_cache            = 64</span><br><span class="line">thread_concurrency     = 10</span><br><span class="line">#</span><br><span class="line"># * Query Cache Configuration</span><br><span class="line">#</span><br><span class="line">query_cache_limit       = 1M</span><br><span class="line">query_cache_size        = 16M</span><br><span class="line"><span class="addition">+ skip_name_resolve       = 1</span></span><br><span class="line"><span class="addition">+ lower_case_table_names  = 1</span></span><br><span class="line"><span class="addition">+ max_allowed_packet      = 32M</span></span><br><span class="line">#</span><br><span class="line"># * Logging and Replication</span><br><span class="line">#</span><br><span class="line"># Both location gets rotated by the cronjob.</span><br><span class="line"># Be aware that this log type is a performance killer.</span><br><span class="line"># As of 5.1 you can enable the log at runtime!</span><br><span class="line">#general_log_file        = /var/log/mysql/mysql.log</span><br><span class="line">#general_log             = 1</span><br><span class="line">#</span><br><span class="line"># Error log - should be very few entries.</span><br><span class="line">#</span><br><span class="line">log_error = /var/log/mysql/error.log</span><br><span class="line">#</span><br><span class="line"># Here you can see queries with especially long duration</span><br><span class="line">#log_slow_queries       = /var/log/mysql/mysql-slow.log</span><br><span class="line">#long_query_time = 2</span><br><span class="line">#log-queries-not-using-indexes</span><br><span class="line"><span class="addition">+ # 千万不要使用log_slow_queries，这是一个错误的参数，会导致MySQL无法启动</span></span><br><span class="line"><span class="addition">+ slow_query_log          = 1</span></span><br><span class="line"><span class="addition">+ slow_query_log_file     = /var/log/mysql/slow.log</span></span><br><span class="line"><span class="addition">+ long_query_time         = 10</span></span><br><span class="line">#</span><br><span class="line"># The following can be used as easy to replay backup logs or for replication.</span><br><span class="line"># note: if you are setting up a replication slave, see README.Debian about</span><br><span class="line">#       other settings you may need to change.</span><br><span class="line"><span class="deletion">- #server-id              = 1</span></span><br><span class="line"><span class="addition">+ server-id               = 2</span></span><br><span class="line"><span class="deletion">- #log_bin                 = /var/log/mysql/mysql-bin.log</span></span><br><span class="line"><span class="addition">+ log_bin                 = /var/log/mysql/mysql-bin.log</span></span><br><span class="line">expire_logs_days        = 10</span><br><span class="line">max_binlog_size         = 100M</span><br><span class="line"><span class="addition">+ read-only               = 0</span></span><br><span class="line">#binlog_do_db           = include_database_name</span><br><span class="line">#binlog_ignore_db       = include_database_name</span><br><span class="line"><span class="addition">+ binlog-ignore-db        = mysql</span></span><br><span class="line"><span class="addition">+ binlog-ignore-db        = information_schema</span></span><br><span class="line"><span class="addition">+ binlog-ignore-db        = performance_schema</span></span><br><span class="line"><span class="addition">+ ## GTID: Global Transaction ID</span></span><br><span class="line"><span class="addition">+ gtid_mode               = on</span></span><br><span class="line"><span class="addition">+ enforce_gtid_consistency= on</span></span><br><span class="line"><span class="addition">+ log-slave-updates       = 1</span></span><br><span class="line"><span class="addition">+ # For all slave servers</span></span><br><span class="line"><span class="addition">+ skip_slave_start        = 1</span></span><br><span class="line">#</span><br><span class="line"># * InnoDB</span><br><span class="line">#</span><br><span class="line"># InnoDB is enabled by default with a 10MB datafile in /var/lib/mysql/.</span><br><span class="line"># Read the manual for more InnoDB related options. There are many!</span><br><span class="line">#</span><br><span class="line"># * Security Features</span><br><span class="line">#</span><br><span class="line"># Read the manual, too, if you want chroot!</span><br><span class="line"># chroot = /var/lib/mysql/</span><br><span class="line">#</span><br><span class="line"># For generating SSL certificates I recommend the OpenSSL GUI &quot;tinyca&quot;.</span><br><span class="line">#</span><br><span class="line"># ssl-ca=/etc/mysql/cacert.pem</span><br><span class="line"># ssl-cert=/etc/mysql/server-cert.pem</span><br><span class="line"># ssl-key=/etc/mysql/server-key.pem</span><br><span class="line"></span><br><span class="line"><span class="addition">+ max_connect_errors      = 20</span></span><br><span class="line"><span class="addition">+ interactive_timeout     = 172800</span></span><br><span class="line"><span class="addition">+ wait_timeout            = 172800</span></span><br><span class="line"></span><br><span class="line"># Character sets</span><br><span class="line"><span class="addition">+ character-set-client-handshake = FALSE</span></span><br><span class="line"><span class="addition">+ character-set-server    = utf8mb4</span></span><br><span class="line"><span class="addition">+ collation-server        = utf8mb4_unicode_ci</span></span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">quote-names</span><br><span class="line"><span class="addition">+ max_allowed_packet      = 32M</span></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">#no-auto-rehash # faster start of mysql but no tab completition</span><br><span class="line"><span class="addition">+ default-character-set   = utf8mb4</span></span><br><span class="line"></span><br><span class="line">[isamchk]</span><br><span class="line">key_buffer              = 16M</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># * IMPORTANT: Additional settings that can override those from this file!</span><br><span class="line">#   The files must end with &#x27;.cnf&#x27;, otherwise they&#x27;ll be ignored.</span><br><span class="line">#</span><br><span class="line"><span class="addition">!includedir /etc/mysql/conf.d/</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-25-mysql-basic-config/" data-id="cklf7tstf0021z8t456qp3kyu" data-title="MySQL服务器配置" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-25-mysql-gtid-master-slave" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-25-mysql-gtid-master-slave/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-25-mysql-gtid-master-slave/">使用GTID机制创建MySQL主从备份和主主备份</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p><strong>注意：</strong>GTID机制只适用与MySQL 5.6.10及更新版本。</p>
</blockquote>
<h2 id="GTID比传统复制的优势"><a href="#GTID比传统复制的优势" class="headerlink" title="GTID比传统复制的优势"></a>GTID比传统复制的优势</h2><ol>
<li>更简单的实现failover，不用以前那样在需要找log_file和log_Pos。</li>
<li>更简单的搭建主从复制。</li>
<li>比传统复制更加安全。</li>
<li>GTID是连续没有空洞的，因此主从库出现数据冲突时，可以用添加空事物的方式进行跳过。</li>
</ol>
<h2 id="GTID的工作原理："><a href="#GTID的工作原理：" class="headerlink" title="GTID的工作原理："></a>GTID的工作原理：</h2><ol>
<li>master更新数据时，会在事务前产生GTID，一同记录到binlog日志中。</li>
<li>slave端的i/o 线程将变更的binlog，写入到本地的relay log中。</li>
<li>sql线程从relay log中获取GTID，然后对比slave端的binlog是否有记录。</li>
<li>如果有记录，说明该GTID的事务已经执行，slave会忽略。</li>
<li>如果没有记录，slave就会从relay log中执行该GTID的事务，并记录到binlog。</li>
<li>在解析过程中会判断是否有主键，如果没有就用二级索引，如果没有就用全部扫描。</li>
</ol>
<p><strong>要点：</strong></p>
<ol>
<li>slave在接受master的binlog时，会校验master的GTID是否已经执行过（一个服务器只能执行一次）。</li>
<li>为了保证主从数据的一致性，多线程只能同时执行一个GTID。</li>
</ol>
<h2 id="MySQL启动GTID机制"><a href="#MySQL启动GTID机制" class="headerlink" title="MySQL启动GTID机制"></a>MySQL启动GTID机制</h2><p>主从MySQL的配置基本一致，区别在于<code>server_id</code><strong>必须</strong>不同：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>               = <span class="number">2</span></span><br><span class="line"><span class="comment"># 在GTID机制下从服务器也必须开启</span></span><br><span class="line"><span class="attr">log_bin</span>                 = /var/log/mysql/mysql-bin.log</span><br><span class="line"><span class="comment"># 参考下文说明，强烈推荐使用row</span></span><br><span class="line"><span class="attr">binlog_format</span>           = row</span><br><span class="line"><span class="attr">expire_logs_days</span>        = <span class="number">10</span></span><br><span class="line"><span class="attr">max_binlog_size</span>         = <span class="number">100</span>M</span><br><span class="line"><span class="attr">read-only</span>               = <span class="number">0</span></span><br><span class="line"><span class="attr">binlog-ignore-db</span>        = mysql</span><br><span class="line"><span class="attr">binlog-ignore-db</span>        = information_schema</span><br><span class="line"><span class="attr">binlog-ignore-db</span>        = performance_schema</span><br><span class="line"><span class="comment">#binlog_ignore_db       = include_database_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## GTID: Global Transaction ID</span></span><br><span class="line"><span class="attr">gtid_mode</span>               = <span class="literal">on</span></span><br><span class="line"><span class="comment"># 使用主从复制的时候必须启用</span></span><br><span class="line"><span class="attr">enforce_gtid_consistency</span>= <span class="literal">on</span></span><br><span class="line"><span class="comment"># 使用主从复制的时候必须启用</span></span><br><span class="line"><span class="attr">log-slave-updates</span>       = <span class="number">1</span></span><br><span class="line"><span class="comment"># For all slave servers</span></span><br><span class="line"><span class="attr">skip_slave_start</span>        = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>关于<code>binlog-format = row</code>的<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/binary-log-setting.html">官方描述</a>：</p>
<blockquote>
<p><strong>Warning</strong><br>When using statement-based logging for replication, it is possible for the data on the master and slave to become different if a statement is designed in such a way that the data modification is nondeterministic; that is, it is left to the will of the query optimizer. In general, this is not a good practice even outside of replication. For a detailed explanation of this issue, see Section B.5.7, “Known Issues in MySQL”.</p>
</blockquote>
<p>重新启动MySQL服务器，可以查看GTID是否正常启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like &#39;%gtid%&#39;;</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| Variable_name                   | Value                                         |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery     | OFF                                           |</span><br><span class="line">| enforce_gtid_consistency        | ON                                            |</span><br><span class="line">| gtid_executed                   | 3591a291-699c-11e6-8386-0242ac1100f2:1-1830   |</span><br><span class="line">| gtid_mode                       | ON                                            |</span><br><span class="line">| gtid_owned                      | 3591a291-699c-11e6-8386-0242ac1100f2:1831#127 |</span><br><span class="line">| gtid_purged                     |                                               |</span><br><span class="line">| simplified_binlog_gtid_recovery | OFF                                           |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">7 rows in set (0.02 sec)</span><br></pre></td></tr></table></figure>

<p>执行一条更新语句，然后就可以看到GTID的状态了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000001</span><br><span class="line">         Position: 1070635555</span><br><span class="line">     Binlog_Do_DB: </span><br><span class="line"> Binlog_Ignore_DB: mysql,information_schema,performance_schema</span><br><span class="line">Executed_Gtid_Set: 3591a291-699c-11e6-8386-0242ac1100f2:1-1745</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>

<h2 id="启动主从复制"><a href="#启动主从复制" class="headerlink" title="启动主从复制"></a>启动主从复制</h2><h3 id="创建Master的Replica帐号："><a href="#创建Master的Replica帐号：" class="headerlink" title="创建Master的Replica帐号："></a>创建Master的Replica帐号：</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;slave&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="在新系统中启动Slave"><a href="#在新系统中启动Slave" class="headerlink" title="在新系统中启动Slave"></a>在新系统中启动Slave</h3><p>如果所有的Binlog都存在Master中，我们认为这是一个新的MySQL系统，此时可以非常容易的启动Slave，只需要在Slave中执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;192.168.1.3&#x27;</span>, master_port<span class="operator">=</span><span class="number">3307</span>, master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, master_password<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>, master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure>
<p>最后一个参数<code>master_auto_position=1</code>告诉Slave服务器自动去寻找Binlog的位置，并且启动Slave。</p>
<p>此时可以查看Slave的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.3</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3307</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000005</span><br><span class="line">          Read_Master_Log_Pos: 22069</span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.000005</span><br><span class="line">                Relay_Log_Pos: 29521031</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 29520821</span><br><span class="line">              Relay_Log_Space: 973528215</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 6454</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: 3591a291-699c-11e6-8386-0242ac1100f2</span><br><span class="line">             Master_Info_File: &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: executing</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 3591a291-699c-11e6-8386-0242ac1100f2:1-2114</span><br><span class="line">            Executed_Gtid_Set: 3591a291-699c-11e6-8386-0242ac1100f2:1-1750</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<p>需要注意的是以下两个字段都应该为Yes：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h3 id="在已有系统中启动Slave"><a href="#在已有系统中启动Slave" class="headerlink" title="在已有系统中启动Slave"></a>在已有系统中启动Slave</h3><p>使用mysqldump的方式：</p>
<ol>
<li>在备份的时候指定–master-data=2（来保存binlog的文件号和位置的命令）。</li>
<li>使用mysqldump的命令在dump文件里可以看到下面两个信息：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @@SESSION.SQL_LOG_BIN&#x3D;0;</span><br><span class="line">SET @@GLOBAL.GTID_PURGED&#x3D;&#39;7800a22c-95ae-11e4-983d-080027de205a:1-8&#39;;</span><br></pre></td></tr></table></figure></li>
<li>将备份还原到slave后，使用change master to命令挂载master端。</li>
</ol>
<h2 id="启动主主复制"><a href="#启动主主复制" class="headerlink" title="启动主主复制"></a>启动主主复制</h2><p>主主复制只是需要将两个MySQL服务器互为主从。在上节的从服务器中执行主服务器的操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;slave&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>在上节中的主服务器执行从服务器的操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;192.168.1.3&#x27;</span>, master_port<span class="operator">=</span><span class="number">3308</span>, master_user<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, master_password<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>, master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure>
<p>这时候两台服务器为互为备份的状态。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="如果mysql导入的过程中失败"><a href="#如果mysql导入的过程中失败" class="headerlink" title="如果mysql导入的过程中失败"></a>如果mysql导入的过程中失败</h3><p>如果导入过程中MySQL报错，则再次执行的时候会报：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fify@server-base:&#x2F;tmp&#x2F;irenshi⟫ mysql -uroot -proot -h192.168.1.4 -P3307 &lt; irenshi.sql</span><br><span class="line">ERROR 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</span><br></pre></td></tr></table></figure>
<p>此时只需要在从服务器中执行reset命令即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset master</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>参考：</strong><a target="_blank" rel="noopener" href="https://avdeo.com/tag/error-1840-hy000-global-gtid_purged-can-only-be-set-when/">https://avdeo.com/tag/error-1840-hy000-global-gtid_purged-can-only-be-set-when/</a></p>
</blockquote>
<h3 id="启动salve之后报错"><a href="#启动salve之后报错" class="headerlink" title="启动salve之后报错"></a>启动salve之后报错</h3><p>如我的slave报了如下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Last_SQL_Errno: 1049</span><br><span class="line">Last_SQL_Error: Error &#39;Unknown database &#39;irenshi&#39;&#39; on query. Default database: &#39;irenshi&#39;. Query: &#39;CREATE TABLE &#96;C3P0_TEST_TABLE&#96; (</span><br><span class="line">  &#96;a&#96; char(1) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8&#39;</span><br><span class="line">Retrieved_Gtid_Set: 3591a291-699c-11e6-8386-0242ac1100f2:1-1751</span><br><span class="line">Executed_Gtid_Set: 3591a291-699c-11e6-8386-0242ac1100f2:1-7</span><br></pre></td></tr></table></figure>
<p>因为我的从数据库中多了<code>irenshi</code>这个表格，并且默认表格也为<code>irenshi</code>，导致无法执行。</p>
<p>可以看到我的从库目前获取到主库的GtidSet为1-1751，但是只执行到了1-7，那么可以通过以下方式跳过第8个GTID：</p>
<blockquote>
<ol>
<li>stop slave;</li>
<li>set GTID_NEXT=’3591a291-699c-11e6-8386-0242ac1100f2:8’;</li>
<li>begin;</li>
<li>commit;</li>
<li>set GTID_NEXT=’AUTOMATIC’;</li>
<li>start slave;</li>
</ol>
</blockquote>
<p>此时再看slave的状态，已经跳过了第8个GTID。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-25-mysql-gtid-master-slave/" data-id="cklf7tsth0025z8t4d2pdg8cq" data-title="使用GTID机制创建MySQL主从备份和主主备份" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GTID/" rel="tag">GTID</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" rel="tag">主从复制</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-26-mysql-error-2006" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-26-mysql-error-2006/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-26-mysql-error-2006/">MySQL导入数据错误：ERROR 2006 (HY000) at line 1&amp;#58; MySQL server has gone away</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这个问题出在使用mysqldump进行数据迁移的过程中，问题的原因就是单条SQL的大小比数据库的设置更大。</p>
<p>检查两个地方的配置：</p>
<ol>
<li>mysqldump的配置</li>
<li>mysqld的配置</li>
</ol>
<p>主要关注<strong>max_allowed_packet</strong>参数。</p>
<p><strong>mysqldump在/etc/mysql/my.cnf的配置</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqldump]</span></span><br><span class="line"><span class="attr">max_allowed_packet</span> = <span class="number">64</span>M</span><br></pre></td></tr></table></figure>

<p><strong>mysqld在/etc/mysql/my.cnf的配置</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">max_allowed_packet</span> = <span class="number">64</span>M</span><br></pre></td></tr></table></figure>
<p>只要保证mysqld中的max_allowed_packet不小于mysqldump的配置即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-26-mysql-error-2006/" data-id="cklf7tsti0029z8t49red8h23" data-title="MySQL导入数据错误：ERROR 2006 (HY000) at line 1&amp;#58; MySQL server has gone away" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysqldump/" rel="tag">mysqldump</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-26-turn-on-swap-on-aliyun-linux" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-26-turn-on-swap-on-aliyun-linux/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-26-turn-on-swap-on-aliyun-linux/">阿里云ECS Linux开启swap（虚拟内存）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>阿里云的服务器默认是不开启虚拟内存的，官方给出的理由如下：</p>
<blockquote>
<p>由于开启swap分区会导致硬盘IO性能下降，因此阿里云服务器初始状态未配置swap。</p>
</blockquote>
<p>这确实是个理由，开启swap对阿里云并没有什么太多的好处：</p>
<ol>
<li>开启swap分区会造成阿里云宿主机的磁盘负载增大，其一会影响磁盘IO性能，其次还会降低磁盘使用寿命；</li>
<li>在阿里云推出SSD之后，SSD的性能和内存性能的差距相对机械硬盘来说减小很多，SSD设置可以当内存使用。但是SSD和内存的价格差别不是一点半点。</li>
</ol>
<p>但是不开启swap，会造成很严重的后果：</p>
<ol>
<li>内存使用波动的时候会导致系统直接杀死某些进程，造成严重的系统不稳定因素，触发只是因为系统偶尔的一次波动而已。</li>
</ol>
<h2 id="开启swap的方法"><a href="#开启swap的方法" class="headerlink" title="开启swap的方法"></a>开启swap的方法</h2><h3 id="创建用于交换分区的文件"><a href="#创建用于交换分区的文件" class="headerlink" title="创建用于交换分区的文件"></a>创建用于交换分区的文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/mnt/swap bs=1M count=4096</span><br></pre></td></tr></table></figure>
<p>注：<code>block_size</code>、<code>number_of_block</code>大小可以自定义，比如bs=1M count=4096代表设置4G大小swap分区</p>
<h3 id="设置交换分区文件"><a href="#设置交换分区文件" class="headerlink" title="设置交换分区文件"></a>设置交换分区文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkswap /mnt/swap</span><br></pre></td></tr></table></figure>

<h3 id="立即启用交换分区文件"><a href="#立即启用交换分区文件" class="headerlink" title="立即启用交换分区文件"></a>立即启用交换分区文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon /mnt/swap</span><br></pre></td></tr></table></figure>
<p>如果在/etc/rc.local中有swapoff -a 需要修改为swapon -a</p>
<h3 id="设置开机时自启用swap分区"><a href="#设置开机时自启用swap分区" class="headerlink" title="设置开机时自启用swap分区"></a>设置开机时自启用swap分区</h3><p>需要修改文件/etc/fstab中的swap行。添加以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;mnt&#x2F;swap swap swap defaults 0 0</span><br></pre></td></tr></table></figure>
<p>注：/mnt/swap 路径可以修改，可以根据创建的swap文件具体路径来配置。</p>
<p>设置后可以执行free -m命令查看效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@www:~# free -m</span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line">Mem:          7983       7784        199          2         70       1158</span><br><span class="line">-&#x2F;+ buffers&#x2F;cache:       6555       1428</span><br><span class="line">Swap:         4095       1052       3043</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-26-turn-on-swap-on-aliyun-linux/" data-id="cklf7tstj002cz8t4ecv83h3n" data-title="阿里云ECS Linux开启swap（虚拟内存）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ECS/" rel="tag">ECS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swap/" rel="tag">swap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" rel="tag">阿里云</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-30-mysql-performance-and-tunning" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-30-mysql-performance-and-tunning/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-30-mysql-performance-and-tunning/">MySQL性能查看及调优参考</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>网上有很多的文章教怎么配置MySQL服务器，但考虑到服务器硬件配置的不同，具体应用的差别，那些文章的做法只能作为初步设置参考，我们需要根据自己的情况进行配置优化，好的做法是MySQL服务器稳定运行了一段时间后运行，根据服务器的”状态”进行优化。</p>
<p>主要依赖两个命令，1）可以列出MySQL服务器运行各种状态值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status;</span><br></pre></td></tr></table></figure>
<p>2）查询MySQL服务器配置信息语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables;</span><br></pre></td></tr></table></figure>

<h2 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">where</span> Variable_name <span class="keyword">like</span> <span class="string">&#x27;%slow_query_log%&#x27;</span> <span class="keyword">or</span> Variable_name <span class="keyword">like</span> <span class="string">&#x27;long_query%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+-------------------------+</span><br><span class="line">| Variable_name       | Value                   |</span><br><span class="line">+---------------------+-------------------------+</span><br><span class="line">| long_query_time     | 5.000000                |</span><br><span class="line">| slow_query_log      | ON                      |</span><br><span class="line">| slow_query_log_file | &#x2F;var&#x2F;log&#x2F;mysql&#x2F;slow.log |</span><br><span class="line">+---------------------+-------------------------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;%slow%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+-------+</span><br><span class="line">| Variable_name       | Value |</span><br><span class="line">+---------------------+-------+</span><br><span class="line">| Slow_launch_threads | 0     |</span><br><span class="line">| Slow_queries        | 457   |</span><br><span class="line">+---------------------+-------+</span><br></pre></td></tr></table></figure>
<p>配置中打开了记录慢查询，执行时间超过5秒的即为慢查询，系统显示有457个慢查询，你可以分析慢查询日志，找出有问题的SQL语句，慢查询时间不宜设置过长，否则意义不大，最好在5秒以内。</p>
<p><strong>Hint：</strong>打开慢查询日志可能会对系统性能有一点点影响，如果你的MySQL是主-从结构，可以考虑打开其中一台从服务器的慢查询日志，这样既可以监控慢查询，对系统性能影响又小。</p>
<h2 id="连接数"><a href="#连接数" class="headerlink" title="连接数"></a>连接数</h2><p>经常会遇见”MySQL: ERROR 1040: Too many connections”的情况，一种是访问量确实很高，MySQL服务器抗不住，这个时候就要考虑增加从服务器分散读压力，另外一种情况是MySQL配置文件中max_connections值过小：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;max_connections&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+-------+</span><br><span class="line">| Variable_name   | Value |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| max_connections | 1000  |</span><br><span class="line">+-----------------+-------+</span><br></pre></td></tr></table></figure>
<p>这台MySQL服务器最大连接数是1000，然后查询一下服务器响应的最大连接数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Max_used_connections&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------------------+-------+</span><br><span class="line">| Variable_name        | Value |</span><br><span class="line">+----------------------+-------+</span><br><span class="line">| Max_used_connections | 299   |</span><br><span class="line">+----------------------+-------+</span><br></pre></td></tr></table></figure>

<p>MySQL服务器过去的最大连接数是299，没有达到服务器连接数上限1000，应该没有出现1040错误，比较理想的设置是：</p>
<blockquote>
<p>Max_used_connections / max_connections * 100% ≈ 85%</p>
</blockquote>
<p>最大连接数占上限连接数的85%左右，如果发现比例在10%以下，MySQL服务器连接数上限设置的过高了。</p>
<h2 id="临时表"><a href="#临时表" class="headerlink" title="临时表"></a>临时表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;created_tmp%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+--------+</span><br><span class="line">| Variable_name           | Value  |</span><br><span class="line">+-------------------------+--------+</span><br><span class="line">| Created_tmp_disk_tables | 15259  |</span><br><span class="line">| Created_tmp_files       | 3237   |</span><br><span class="line">| Created_tmp_tables      | 244972 |</span><br><span class="line">+-------------------------+--------+</span><br></pre></td></tr></table></figure>
<p>每次创建临时表，Created_tmp_tables增加，如果是在磁盘上创建临时表，Created_tmp_disk_tables也增加,Created_tmp_files表示MySQL服务创建的临时文件文件数，比较理想的配置是：</p>
<blockquote>
<p>Created_tmp_disk_tables / Created_tmp_tables * 100% &lt;= 25%</p>
</blockquote>
<p>比如上面的服务器Created_tmp_disk_tables / Created_tmp_tables * 100% = 6.2%，应该可以了。我们再看一下MySQL服务器对临时表的配置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">where</span> Variable_name <span class="keyword">in</span> (<span class="string">&#x27;tmp_table_size&#x27;</span>, <span class="string">&#x27;max_heap_table_size&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+----------+</span><br><span class="line">| Variable_name       | Value    |</span><br><span class="line">+---------------------+----------+</span><br><span class="line">| max_heap_table_size | 16777216 |</span><br><span class="line">| tmp_table_size      | 16777216 |</span><br><span class="line">+---------------------+----------+</span><br></pre></td></tr></table></figure>
<p>只有16MB以下的临时表才能全部放内存，超过的就会用到硬盘临时表。</p>
<h2 id="Open-Table情况"><a href="#Open-Table情况" class="headerlink" title="Open Table情况"></a>Open Table情况</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;open%tables%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Open_tables   | 953   |</span><br><span class="line">| Opened_tables | 1935  |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure>
<p>Open_tables表示打开表的数量，Opened_tables表示打开过的表数量，如果Opened_tables数量过大，说明配置中table_cache(5.1.3之后这个值叫做table_open_cache)值可能太小，我们查询一下服务器table_cache值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%table_open%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------+-------+</span><br><span class="line">| Variable_name              | Value |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| table_open_cache           | 2000  |</span><br><span class="line">| table_open_cache_instances | 1     |</span><br><span class="line">+----------------------------+-------+</span><br></pre></td></tr></table></figure>
<p>比较合适的值为：</p>
<blockquote>
<p>Open_tables / Opened_tables * 100% &gt;= 85%<br>Open_tables / table_open_cache * 100% &lt;= 95%</p>
</blockquote>
<h2 id="进程使用情况"><a href="#进程使用情况" class="headerlink" title="进程使用情况"></a>进程使用情况</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;Thread%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Threads_cached    | 1     |</span><br><span class="line">| Threads_connected | 280   |</span><br><span class="line">| Threads_created   | 12368 |</span><br><span class="line">| Threads_running   | 2     |</span><br><span class="line">+-------------------+-------+</span><br></pre></td></tr></table></figure>
<p>如果我们在MySQL服务器配置文件中设置了thread_cache_size，当客户端断开之后，服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)。Threads_created表示创建过的线程数，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗资源，可以适当增加配置文件中thread_cache_size值，查询服务器thread_cache_size配置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;thread_cache_size&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| thread_cache_size | 64    |</span><br><span class="line">+-------------------+-------+</span><br></pre></td></tr></table></figure>

<h2 id="排序使用情况"><a href="#排序使用情况" class="headerlink" title="排序使用情况"></a>排序使用情况</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;sort%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+----------+</span><br><span class="line">| Variable_name     | Value    |</span><br><span class="line">+-------------------+----------+</span><br><span class="line">| Sort_merge_passes | 1012     |</span><br><span class="line">| Sort_range        | 519624   |</span><br><span class="line">| Sort_rows         | 14179389 |</span><br><span class="line">| Sort_scan         | 846266   |</span><br><span class="line">+-------------------+----------+</span><br></pre></td></tr></table></figure>

<p>Sort_merge_passes 包括两步。MySQL 首先会尝试在内存中做排序，使用的内存大小由系统变量 Sort_buffer_size 决定，如果它的大小不够把所有的记录都读到内存中，MySQL 就会把每次在内存中排序的结果存到临时文件中，等 MySQL 找到所有记录之后，再把临时文件中的记录做一次排序。这再次排序就会增加 Sort_merge_passes。实际上，MySQL 会用另一个临时文件来存再次排序的结果，所以通常会看到 Sort_merge_passes 增加的数值是建临时文件数的两倍。因为用到了临时文件，所以速度可能会比较慢，增加 Sort_buffer_size 会减少 Sort_merge_passes 和 创建临时文件的次数。</p>
<p>另外，增加read_rnd_buffer_size(3.2.3是record_rnd_buffer_size)的值对排序的操作也有一点的好处，参见：<a target="_blank" rel="noopener" href="http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/">http://www.mysqlperformanceblog.com/2007/07/24/what-exactly-is-read_rnd_buffer_size/</a></p>
<h2 id="文件打开数"><a href="#文件打开数" class="headerlink" title="文件打开数"></a>文件打开数</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;open_files&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Open_files    | 30    |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;open_files_limit&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| open_files_limit | 65535 |</span><br><span class="line">+------------------+-------+</span><br></pre></td></tr></table></figure>

<p>比较合适的设置：</p>
<blockquote>
<p>Open_files / open_files_limit * 100% &lt;= 75%</p>
</blockquote>
<h2 id="表扫描情况"><a href="#表扫描情况" class="headerlink" title="表扫描情况"></a>表扫描情况</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;handler_read%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+-------------+</span><br><span class="line">| Variable_name         | Value       |</span><br><span class="line">+-----------------------+-------------+</span><br><span class="line">| Handler_read_first    | 8525687     |</span><br><span class="line">| Handler_read_key      | 192321231   |</span><br><span class="line">| Handler_read_last     | 120         |</span><br><span class="line">| Handler_read_next     | 351154252   |</span><br><span class="line">| Handler_read_prev     | 46717985    |</span><br><span class="line">| Handler_read_rnd      | 13564471    |</span><br><span class="line">| Handler_read_rnd_next | 44813383354 |</span><br><span class="line">+-----------------------+-------------+</span><br></pre></td></tr></table></figure>
<p>服务器完成的查询请求次数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;com_select&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------------+----------+</span><br><span class="line">| Variable_name | Value    |</span><br><span class="line">+---------------+----------+</span><br><span class="line">| Com_select    | 27320750 |</span><br><span class="line">+---------------+----------+</span><br></pre></td></tr></table></figure>

<p>计算表扫描率：</p>
<blockquote>
<p>表扫描率 = Handler_read_rnd_next / Com_select</p>
</blockquote>
<p>如果表扫描率超过4000，说明进行了太多表扫描，很有可能索引没有建好，增加read_buffer_size值会有一些好处，但最好不要超过8MB。</p>
<h2 id="表锁情况"><a href="#表锁情况" class="headerlink" title="表锁情况"></a>表锁情况</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;table_locks%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+----------+</span><br><span class="line">| Variable_name         | Value    |</span><br><span class="line">+-----------------------+----------+</span><br><span class="line">| Table_locks_immediate | 28770420 |</span><br><span class="line">| Table_locks_waited    | 0        |</span><br><span class="line">+-----------------------+----------+</span><br></pre></td></tr></table></figure>
<p>Table_locks_immediate表示立即释放表锁数，Table_locks_waited表示需要等待的表锁数，如果Table_locks_immediate / Table_locks_waited &gt; 5000，最好采用InnoDB引擎，因为InnoDB是行锁而MyISAM是表锁，对于高并发写入的应用InnoDB效果会好些。示例中的服务器Table_locks_immediate / Table_locks_waited = 235，MyISAM就足够了。</p>
<h2 id="Key-buffer-size"><a href="#Key-buffer-size" class="headerlink" title="Key_buffer_size"></a>Key_buffer_size</h2><p>key_buffer_size是对MyISAM表性能影响最大的一个参数，下面一台以MyISAM为主要存储引擎服务器的配置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;key_buffer_size&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+----------+</span><br><span class="line">| Variable_name   | Value    |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| key_buffer_size | 16777216 |</span><br><span class="line">+-----------------+----------+</span><br></pre></td></tr></table></figure>

<p>分配了16MB内存给key_buffer_size，我们再看一下key_buffer_size的使用情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;key_read%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Key_read_requests | 31424 |</span><br><span class="line">| Key_reads         | 4     |</span><br><span class="line">+-------------------+-------+</span><br></pre></td></tr></table></figure>

<p>一共有31424个索引读取请求，有4个请求在内存中没有找到直接从硬盘读取索引，计算索引未命中缓存的概率：</p>
<blockquote>
<p>key_cache_miss_rate = Key_reads / Key_read_requests * 100%</p>
</blockquote>
<p>比如上面的数据，key_cache_miss_rate为0.0244%，4000个索引读取请求才有一个直接读硬盘，已经很BT了,key_cache_miss_rate在0.1%以下都很好(每1000个请求有一个直接读硬盘)，如果key_cache_miss_rate在0.01%以下的话，key_buffer_size分配的过多，可以适当减少。</p>
<p>MySQL服务器还提供了key_blocks_*参数：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;key_blocks_u%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Key_blocks_unused | 13392 |</span><br><span class="line">| Key_blocks_used   | 51    |</span><br><span class="line">+-------------------+-------+</span><br></pre></td></tr></table></figure>

<p>Key_blocks_unused表示未使用的缓存簇(blocks)数，Key_blocks_used表示曾经用到的最大的blocks数，比如这台服务器，所有的缓存都用到了，要么增加key_buffer_size，要么就是过渡索引了，把缓存占满了。比较理想的设置：</p>
<blockquote>
<p>Key_blocks_used / (Key_blocks_unused + Key_blocks_used) * 100% ≈ 80%</p>
</blockquote>
<h2 id="查询缓存-query-cache"><a href="#查询缓存-query-cache" class="headerlink" title="查询缓存(query cache)"></a>查询缓存(query cache)</h2><p><strong>注意：</strong>很多人不建议对这个选项调优，所以放到了最后。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;qcache%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+----------+</span><br><span class="line">| Variable_name           | Value    |</span><br><span class="line">+-------------------------+----------+</span><br><span class="line">| Qcache_free_blocks      | 1        |</span><br><span class="line">| Qcache_free_memory      | 1031360  |</span><br><span class="line">| Qcache_hits             | 0        |</span><br><span class="line">| Qcache_inserts          | 0        |</span><br><span class="line">| Qcache_lowmem_prunes    | 0        |</span><br><span class="line">| Qcache_not_cached       | 27326355 |</span><br><span class="line">| Qcache_queries_in_cache | 0        |</span><br><span class="line">| Qcache_total_blocks     | 1        |</span><br><span class="line">+-------------------------+----------+</span><br></pre></td></tr></table></figure>

<p>MySQL查询缓存变量解释：</p>
<ul>
<li>Qcache_free_blocks：缓存中相邻内存块的个数。数目大说明可能有碎片。FLUSH QUERY CACHE会对缓存中的碎片进行整理，从而得到一个空闲块。</li>
<li>Qcache_free_memory：缓存中的空闲内存。 </li>
<li>Qcache_hits：每次查询在缓存中命中时就增大</li>
<li>Qcache_inserts：每次插入一个查询时就增大。命中次数除以插入次数就是不中比率。</li>
<li>Qcache_lowmem_prunes：缓存出现内存不足并且必须要进行清理以便为更多查询提供空间的次数。这个数字最好长时间来看;如果这个数字在不断增长，就表示可能碎片非常严重，或者内存很少。(上面的 free_blocks和free_memory可以告诉您属于哪种情况) </li>
<li>Qcache_not_cached：不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。</li>
<li>Qcache_queries_in_cache：当前缓存的查询(和响应)的数量。</li>
<li>Qcache_total_blocks：缓存中块的数量。</li>
</ul>
<p>我们再查询一下服务器关于query_cache的配置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;query_cache%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+------------------------------+---------+</span><br><span class="line">| Variable_name                | Value   |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| query_cache_limit            | 1048576 |</span><br><span class="line">| query_cache_min_res_unit     | 4096    |</span><br><span class="line">| query_cache_size             | 1048576 |</span><br><span class="line">| query_cache_type             | OFF     |</span><br><span class="line">| query_cache_wlock_invalidate | OFF     |</span><br><span class="line">+------------------------------+---------+</span><br></pre></td></tr></table></figure>
<p>各字段的解释：</p>
<ul>
<li>query_cache_limit：超过此大小的查询将不缓存</li>
<li>query_cache_min_res_unit：缓存块的最小大小</li>
<li>query_cache_size：查询缓存大小</li>
<li>query_cache_type：缓存类型，决定缓存什么样的查询，示例中表示不缓存 select sql_no_cache 查询</li>
<li>query_cache_wlock_invalidate：当有其他客户端正在对MyISAM表进行写操作时，如果查询在query cache中，是否返回cache结果还是等写操作完成再读表获取结果。</li>
<li>query_cache_min_res_unit的配置是一柄”双刃剑”，默认是4KB，设置值大对大数据查询有好处，但如果你的查询都是小数据查询，就容易造成内存碎片和浪费。</li>
<li>查询缓存碎片率 = Qcache_free_blocks / Qcache_total_blocks * 100%</li>
<li>如果查询缓存碎片率超过20%，可以用FLUSH QUERY CACHE整理缓存碎片，或者试试减小query_cache_min_res_unit，如果你的查询都是小数据量的话。</li>
<li>查询缓存利用率 = (query_cache_size - Qcache_free_memory) / query_cache_size * 100%</li>
<li>查询缓存利用率在25%以下的话说明query_cache_size设置的过大，可适当减小;查询缓存利用率在80%以上而且Qcache_lowmem_prunes &gt; 50的话说明query_cache_size可能有点小，要不就是碎片太多。</li>
<li>查询缓存命中率 = (Qcache_hits - Qcache_inserts) / Qcache_hits * 100%</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-30-mysql-performance-and-tunning/" data-id="cklf7tstk002ez8t41ti5g4i9" data-title="MySQL性能查看及调优参考" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Performance/" rel="tag">Performance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tuning/" rel="tag">Tuning</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Microservice/">Microservice</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Microservice/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E6%9C%8D%E5%8A%A1%E5%99%A8/">Web服务器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%8D%93/">安卓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-Service/" rel="tag">Android Service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bash/" rel="tag">Bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binlog/" rel="tag">Binlog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Browser-Caching/" rel="tag">Browser Caching</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPU/" rel="tag">CPU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cobar/" rel="tag">Cobar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECS/" rel="tag">ECS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Email/" rel="tag">Email</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Emoji/" rel="tag">Emoji</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GTID/" rel="tag">GTID</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Goaccess/" rel="tag">Goaccess</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gzip/" rel="tag">Gzip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hibernate/" rel="tag">Hibernate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Introduction-to-Microservices/" rel="tag">Introduction to Microservices</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/" rel="tag">JDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JUnit/" rel="tag">JUnit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Mail/" rel="tag">Java Mail</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaMail/" rel="tag">JavaMail</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jedis/" rel="tag">Jedis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Marathon/" rel="tag">Marathon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mesos/" rel="tag">Mesos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mockito/" rel="tag">Mockito</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Moint/" rel="tag">Moint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mongo/" rel="tag">Mongo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyCAT/" rel="tag">MyCAT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ORM/" rel="tag">ORM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/" rel="tag">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Performance/" rel="tag">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PowerMock/" rel="tag">PowerMock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SMTP/" rel="tag">SMTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Script/" rel="tag">Script</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Data-JPA/" rel="tag">Spring Data JPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Modules/" rel="tag">Spring Modules</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Telnet/" rel="tag">Telnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tuning/" rel="tag">Tuning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/USB/" rel="tag">USB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/" rel="tag">Vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Volumes/" rel="tag">Volumes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/" rel="tag">Zabbix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/" rel="tag">Zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apk/" rel="tag">apk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/emoji/" rel="tag">emoji</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/enca/" rel="tag">enca</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysqldump/" rel="tag">mysqldump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swap/" rel="tag">swap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/utf8mb4/" rel="tag">utf8mb4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" rel="tag">主从复制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="tag">分布式锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" rel="tag">分库分表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" rel="tag">单元测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%8D%93/" rel="tag">安卓</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%8F%E5%8F%B7%E7%94%9F%E6%88%90%E5%99%A8/" rel="tag">序号生成器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1/" rel="tag">微信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%B5%E5%AD%90%E4%B9%A6/" rel="tag">电子书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%91%E6%8E%A7/" rel="tag">监控</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AD%BE%E5%90%8D/" rel="tag">签名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" rel="tag">读写分离</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" rel="tag">阿里云</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Android-Service/" style="font-size: 10px;">Android Service</a> <a href="/tags/Bash/" style="font-size: 10px;">Bash</a> <a href="/tags/Binlog/" style="font-size: 10px;">Binlog</a> <a href="/tags/Browser-Caching/" style="font-size: 10px;">Browser Caching</a> <a href="/tags/CPU/" style="font-size: 10px;">CPU</a> <a href="/tags/Cobar/" style="font-size: 10px;">Cobar</a> <a href="/tags/Docker/" style="font-size: 11.67px;">Docker</a> <a href="/tags/ECS/" style="font-size: 10px;">ECS</a> <a href="/tags/Email/" style="font-size: 10px;">Email</a> <a href="/tags/Emoji/" style="font-size: 10px;">Emoji</a> <a href="/tags/GTID/" style="font-size: 11.67px;">GTID</a> <a href="/tags/Goaccess/" style="font-size: 10px;">Goaccess</a> <a href="/tags/Gzip/" style="font-size: 10px;">Gzip</a> <a href="/tags/Hibernate/" style="font-size: 10px;">Hibernate</a> <a href="/tags/Introduction-to-Microservices/" style="font-size: 10px;">Introduction to Microservices</a> <a href="/tags/JDK/" style="font-size: 11.67px;">JDK</a> <a href="/tags/JUnit/" style="font-size: 10px;">JUnit</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 11.67px;">Java</a> <a href="/tags/Java-Mail/" style="font-size: 10px;">Java Mail</a> <a href="/tags/JavaMail/" style="font-size: 10px;">JavaMail</a> <a href="/tags/Jedis/" style="font-size: 10px;">Jedis</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Marathon/" style="font-size: 10px;">Marathon</a> <a href="/tags/Mesos/" style="font-size: 10px;">Mesos</a> <a href="/tags/Mockito/" style="font-size: 10px;">Mockito</a> <a href="/tags/Moint/" style="font-size: 10px;">Moint</a> <a href="/tags/Mongo/" style="font-size: 10px;">Mongo</a> <a href="/tags/MyCAT/" style="font-size: 11.67px;">MyCAT</a> <a href="/tags/MySQL/" style="font-size: 20px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Nodejs/" style="font-size: 10px;">Nodejs</a> <a href="/tags/ORM/" style="font-size: 10px;">ORM</a> <a href="/tags/Oracle/" style="font-size: 10px;">Oracle</a> <a href="/tags/Performance/" style="font-size: 11.67px;">Performance</a> <a href="/tags/PowerMock/" style="font-size: 10px;">PowerMock</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/SMTP/" style="font-size: 10px;">SMTP</a> <a href="/tags/Script/" style="font-size: 10px;">Script</a> <a href="/tags/Shell/" style="font-size: 11.67px;">Shell</a> <a href="/tags/Spring/" style="font-size: 16.67px;">Spring</a> <a href="/tags/Spring-Cloud/" style="font-size: 11.67px;">Spring Cloud</a> <a href="/tags/Spring-Data-JPA/" style="font-size: 10px;">Spring Data JPA</a> <a href="/tags/Spring-Modules/" style="font-size: 10px;">Spring Modules</a> <a href="/tags/Telnet/" style="font-size: 10px;">Telnet</a> <a href="/tags/Tuning/" style="font-size: 10px;">Tuning</a> <a href="/tags/USB/" style="font-size: 10px;">USB</a> <a href="/tags/Ubuntu/" style="font-size: 11.67px;">Ubuntu</a> <a href="/tags/Vim/" style="font-size: 10px;">Vim</a> <a href="/tags/Volumes/" style="font-size: 10px;">Volumes</a> <a href="/tags/Zabbix/" style="font-size: 11.67px;">Zabbix</a> <a href="/tags/Zookeeper/" style="font-size: 10px;">Zookeeper</a> <a href="/tags/apk/" style="font-size: 10px;">apk</a> <a href="/tags/emoji/" style="font-size: 10px;">emoji</a> <a href="/tags/enca/" style="font-size: 10px;">enca</a> <a href="/tags/mysqldump/" style="font-size: 11.67px;">mysqldump</a> <a href="/tags/swap/" style="font-size: 10px;">swap</a> <a href="/tags/utf8mb4/" style="font-size: 11.67px;">utf8mb4</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 10px;">中间件</a> <a href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" style="font-size: 10px;">主从复制</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 10px;">分布式锁</a> <a href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" style="font-size: 10px;">分库分表</a> <a href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">单元测试</a> <a href="/tags/%E5%AE%89%E5%8D%93/" style="font-size: 13.33px;">安卓</a> <a href="/tags/%E5%BA%8F%E5%8F%B7%E7%94%9F%E6%88%90%E5%99%A8/" style="font-size: 10px;">序号生成器</a> <a href="/tags/%E5%BE%AE%E4%BF%A1/" style="font-size: 10px;">微信</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 11.67px;">微服务</a> <a href="/tags/%E7%94%B5%E5%AD%90%E4%B9%A6/" style="font-size: 10px;">电子书</a> <a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 15px;">监控</a> <a href="/tags/%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">签名</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 11.67px;">编码</a> <a href="/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" style="font-size: 10px;">读写分离</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 18.33px;">转载</a> <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" style="font-size: 10px;">阿里云</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/02/21/2016-08-24-import-data-into-mycat/">将现有数据库的数据导入MyCAT</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-06-15-login-smtp-with-telnet/">利用telnet进行SMTP的验证</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-06-27-monitor-mysql-with-zabbix/">使用Zabbix监控MySQL服务器</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-07-19-mongo-queries/">Mongo常用命令</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-07-19-vim-commands/">Vim常用命令</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>