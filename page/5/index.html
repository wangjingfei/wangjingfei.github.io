<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-2017-03-09-spring-framework-modules" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2017-03-09-spring-framework-modules/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2017-03-09-spring-framework-modules/">Spring Framework: Modules</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/4.3.0.BUILD-SNAPSHOT/spring-framework-reference/htmlsingle/#overview-modules">https://docs.spring.io/spring/docs/4.3.0.BUILD-SNAPSHOT/spring-framework-reference/htmlsingle/#overview-modules</a></p>
</blockquote>
<h2 id="Spring-Framework-Modules"><a href="#Spring-Framework-Modules" class="headerlink" title="Spring Framework: Modules"></a>Spring Framework: Modules</h2><p>The Spring Framework consists of features organized into about 20 modules. These modules are grouped into <code>Core Container</code>, <code>Data Access/Integration</code>, <code>Web</code>, <code>AOP (Aspect Oriented Programming)</code>, <code>Instrumentation</code>, <code>Messaging</code>, and <code>Test</code>, as shown in the following diagram.</p>
<p><img src="/upload/images/15.png" alt="Spring Framework 4.x 的系统架构图"></p>
<p>The following sections list the available modules for each feature along with their artifact names and the topics they cover.</p>
<h3 id="1-Core-Container"><a href="#1-Core-Container" class="headerlink" title="1. Core Container"></a>1. Core Container</h3><blockquote>
<ul>
<li>spring-core</li>
<li>spring-beans</li>
<li>spring-context</li>
<li>spring-context-support</li>
<li>spring-expression</li>
</ul>
</blockquote>
<p>The <em>Core Container</em> consists of the <code>spring-core</code>, <code>spring-beans</code>, <code>spring-context</code>, <code>spring-context-support</code>, and <code>spring-expression</code> (Spring Expression Language) modules.</p>
<p>The <code>spring-core</code> and <code>spring-beans</code> modules provide the fundamental parts of the framework, including the <em>IoC</em> and <em>Dependency Injection</em> features. The <code>BeanFactory</code> is a sophisticated implementation of the factory pattern. It removes the need for programmatic singletons and allows you to decouple the configuration and specification of dependencies from your actual program logic.</p>
<p>The Context (<code>spring-context</code>) module builds on the solid base provided by the <em>Core</em> and <em>Beans</em> modules: it is a means to access objects in a framework-style manner that is similar to a JNDI registry. The Context module inherits its features from the <em>Beans</em> module and adds support for <code>internationalization</code> (using, for example, resource bundles), <code>event propagation</code>, <code>resource loading</code>, and <code>the transparent creation of contexts</code> by, for example, a Servlet container. The Context module also supports Java EE features such as EJB, JMX, and basic remoting. The ApplicationContext interface is the focal point of the Context module. spring-context-support provides support for integrating common third-party libraries into a Spring application context for caching (EhCache, Guava, JCache), mailing (JavaMail), scheduling (CommonJ, Quartz) and template engines (FreeMarker, JasperReports, Velocity).</p>
<p>The <code>spring-expression</code> module provides a powerful Expression Language for querying and manipulating an object graph at runtime. It is an extension of the unified expression language (unified EL) as specified in the JSP 2.1 specification. The language supports setting and getting property values, property assignment, method invocation, accessing the content of arrays, collections and indexers, logical and arithmetic operators, named variables, and retrieval of objects by name from Spring’s IoC container. It also supports list projection and selection as well as common list aggregations.</p>
<h3 id="2-AOP-and-Instrumentation"><a href="#2-AOP-and-Instrumentation" class="headerlink" title="2. AOP and Instrumentation"></a>2. AOP and Instrumentation</h3><blockquote>
<ul>
<li>spring-aop</li>
<li>spring-aspect</li>
<li>spring-instrument</li>
<li>spring-instrument-tomcat</li>
</ul>
</blockquote>
<p>The <code>spring-aop</code> module provides an AOP Alliance-compliant aspect-oriented programming implementation allowing you to define, for example, method interceptors and pointcuts to cleanly decouple code that implements functionality that should be separated. Using source-level metadata functionality, you can also incorporate behavioral information into your code, in a manner similar to that of .NET attributes.</p>
<p>The separate <code>spring-aspects</code> module provides integration with AspectJ.</p>
<p>The <code>spring-instrument</code> module provides class instrumentation support and classloader implementations to be used in certain application servers. The <code>spring-instrument-tomcat</code> module contains Spring’s instrumentation agent for Tomcat.</p>
<h3 id="3-Messaging"><a href="#3-Messaging" class="headerlink" title="3. Messaging"></a>3. Messaging</h3><blockquote>
<ul>
<li>spring-messaging</li>
</ul>
</blockquote>
<p>Spring Framework 4 includes a <code>spring-messaging</code> module with key abstractions from the <em>Spring Integration</em> project such as <code>Message</code>, <code>MessageChannel</code>, <code>MessageHandler</code>, and others to serve as a foundation for messaging-based applications. The module also includes a set of annotations for mapping messages to methods, similar to the Spring MVC annotation based programming model.</p>
<h3 id="4-Data-Access-Integration"><a href="#4-Data-Access-Integration" class="headerlink" title="4. Data Access/Integration"></a>4. Data Access/Integration</h3><blockquote>
<ul>
<li>spring-jdbc</li>
<li>spring-tx</li>
<li>spring-orm</li>
<li>spring-oxm</li>
<li>spring-jms</li>
</ul>
</blockquote>
<p>The <em>Data Access/Integration layer</em> consists of the JDBC, ORM, OXM, JMS, and Transaction modules.</p>
<p>The <code>spring-jdbc</code> module provides a JDBC-abstraction layer that removes the need to do tedious JDBC coding and parsing of database-vendor specific error codes.</p>
<p>The <code>spring-tx</code> module supports programmatic and declarative transaction management for classes that implement special interfaces and for all your POJOs (Plain Old Java Objects).</p>
<p>The <code>spring-orm</code> module provides integration layers for popular object-relational mapping APIs, including JPA, JDO, and Hibernate. Using the <code>spring-orm</code> module you can use all of these O/R-mapping frameworks in combination with all of the other features Spring offers, such as the simple declarative transaction management feature mentioned previously.</p>
<p>The <code>spring-oxm</code> module provides an abstraction layer that supports Object/XML mapping implementations such as JAXB, Castor, XMLBeans, JiBX and XStream.</p>
<p>The <code>spring-jms</code> module (Java Messaging Service) contains features for producing and consuming messages. Since Spring Framework 4.1, it provides integration with the <code>spring-messaging</code> module.</p>
<h3 id="5-Web"><a href="#5-Web" class="headerlink" title="5. Web"></a>5. Web</h3><blockquote>
<ul>
<li>spring-web</li>
<li>spring-webmvc: Web-Servlet module</li>
<li>spring-webmvc-portlet: Web-Portlet module</li>
</ul>
</blockquote>
<p>The Web layer consists of the <code>spring-web</code>, <code>spring-webmvc</code>, <code>spring-websocket</code>, and <code>spring-webmvc-portlet</code> modules.</p>
<p>The <code>spring-web</code> module provides basic web-oriented integration features such as multipart file upload functionality and the initialization of the IoC container using Servlet listeners and a web-oriented application context. It also contains an HTTP client and the web-related parts of Spring’s remoting support.</p>
<p>The <code>spring-webmvc</code> module (also known as the Web-Servlet module) contains Spring’s model-view-controller (MVC) and REST Web Services implementation for web applications. Spring’s MVC framework provides a clean separation between domain model code and web forms and integrates with all of the other features of the Spring Framework.</p>
<p>The <code>spring-webmvc-portlet</code> module (also known as the Web-Portlet module) provides the MVC implementation to be used in a Portlet environment and mirrors the functionality of the spring-webmvc module.</p>
<h3 id="6-Test"><a href="#6-Test" class="headerlink" title="6. Test"></a>6. Test</h3><blockquote>
<ul>
<li>spring-test</li>
</ul>
</blockquote>
<p>The <code>spring-test</code> module supports the unit testing and integration testing of Spring components with JUnit or TestNG. It provides consistent loading of Spring ApplicationContexts and caching of those contexts. It also provides mock objects that you can use to test your code in isolation.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2017-03-09-spring-framework-modules/" data-id="cklf7tsu0003fz8t4bsu70s37" data-title="Spring Framework: Modules" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Modules/" rel="tag">Spring Modules</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2018-03-07-spring-cloud-components" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2018-03-07-spring-cloud-components/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2018-03-07-spring-cloud-components/">Spring Cloud组件介绍</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Reference:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xlgen157387/article/details/77773908">Spring Cloud全家桶主要组件及简要介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wxb880114/article/details/79467779">SpringCloud分布式开发五大组件详解</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ityouknow.com/springcloud/2017/05/26/springcloud-config-eureka-bus.html">配置中心和消息总线（配置中心终结版）</a></li>
</ul>
</blockquote>
<h2 id="什么是微服务？"><a href="#什么是微服务？" class="headerlink" title="什么是微服务？"></a>什么是微服务？</h2><p>微服务的主旨是将一个原本独立的系统拆分成多个小型服务，这些小型服务都在各自独立的进程中运行，服务之间通过基于HTTP的RESTful API进行通信协作，并且每个服务都维护着自身的数据存储、业务开发、自动化测试以及独立部署机制。</p>
<p>一个微服务一般完成某个特定的功能，比如下单管理、客户管理等等。每一个微服务都是微型六角形应用，都有自己的业务逻辑和适配器。一些微服务还会发布API给其它微服务和应用客户端使用。其它微服务完成一个Web UI，运行时，每一个实例可能是一个云VM或者是Docker容器。</p>
<p>以下是一个汽车租赁网站的微服务架构：</p>
<p><img src="/upload/images/16.png" alt="微服务示例"></p>
<h2 id="常见微服务框架"><a href="#常见微服务框架" class="headerlink" title="常见微服务框架"></a>常见微服务框架</h2><h3 id="服务治理框架"><a href="#服务治理框架" class="headerlink" title="服务治理框架"></a>服务治理框架</h3><ol>
<li><p>Dubbo（<a target="_blank" rel="noopener" href="http://dubbo.io/">http://dubbo.io/</a>）、Dubbox（当当网对Dubbo的扩展）</p>
</li>
<li><p>Netflix的Eureka、Apache的Consul等。</p>
<blockquote>
<p>Spring Cloud Eureka是对Netflix的Eureka的进一步封装。</p>
</blockquote>
</li>
</ol>
<h3 id="分布式配置管理"><a href="#分布式配置管理" class="headerlink" title="分布式配置管理"></a>分布式配置管理</h3><ol>
<li>百度的Disconf</li>
<li>360的QConf</li>
<li>Spring Cloud组件中的Config</li>
<li>淘宝的Diamond</li>
</ol>
<h3 id="批量任务框架"><a href="#批量任务框架" class="headerlink" title="批量任务框架"></a>批量任务框架</h3><ol>
<li>Spring Cloud组件中的Task</li>
<li>LTS</li>
</ol>
<h3 id="服务追踪框架"><a href="#服务追踪框架" class="headerlink" title="服务追踪框架"></a>服务追踪框架</h3><ol>
<li>Skywalking</li>
</ol>
<h2 id="Spring-Cloud全家桶组件"><a href="#Spring-Cloud全家桶组件" class="headerlink" title="Spring Cloud全家桶组件"></a>Spring Cloud全家桶组件</h2><p>Netflix 公司提供了包括Eureka、Hystrix、Zuul、Archaius等在内的很多组件，在微服务架构中至关重要，Spring在Netflix 的基础上，封装了一系列的组件，命名为：Spring Cloud Eureka、Spring Cloud Hystrix、Spring Cloud Zuul等，下边对各个组件进行分别得介绍：</p>
<h3 id="Spring-Cloud-Eureka"><a href="#Spring-Cloud-Eureka" class="headerlink" title="Spring Cloud Eureka"></a>Spring Cloud Eureka</h3><p>我们可以将自己定义的API 接口注册到Spring Cloud Eureka上，Eureka负责服务的注册于发现，如果学习过Zookeeper的话，就可以很好的理解，Eureka的角色和 Zookeeper的角色差不多，都是服务的注册和发现，构成Eureka体系的包括：服务注册中心、服务提供者、服务消费者。</p>
<p><img src="/upload/images/17.png"></p>
<p>上图中描述了：</p>
<ol>
<li>两台Eureka服务注册中心构成的服务注册中心的主从复制集群；</li>
<li>然后服务提供者向注册中心进行注册、续约、下线服务等；</li>
<li>服务消费者向Eureka注册中心拉去服务列表并维护在本地（这也是客户端发现模式的机制体现！）；</li>
<li>然后服务消费者根据从Eureka服务注册中心获取的服务列表选取一个服务提供者进行消费服务。</li>
</ol>
<h3 id="Spring-Cloud-Ribbon"><a href="#Spring-Cloud-Ribbon" class="headerlink" title="Spring Cloud Ribbon"></a>Spring Cloud Ribbon</h3><p>在上Spring Cloud Eureka描述了服务如何进行注册，注册到哪里，服务消费者如何获取服务生产者的服务信息，但是Eureka只是维护了服务生产者、注册中心、服务消费者三者之间的关系，真正的服务消费者调用服务生产者提供的数据是通过Spring Cloud Ribbon来实现的。</p>
<p><img src="/upload/images/18.png"></p>
<p>Ribbon，主要提供客户侧的软件负载均衡算法。</p>
<p>Ribbon客户端组件提供一系列完善的配置选项，比如连接超时、重试、重试算法等。Ribbon内置可插拔、可定制的负载均衡组件。下面是用到的一些负载均衡策略：</p>
<ul>
<li>简单轮询负载均衡</li>
<li>加权响应时间负载均衡</li>
<li>区域感知轮询负载均衡</li>
<li>随机负载均衡</li>
</ul>
<p>Ribbon中还包括以下功能：</p>
<ul>
<li>易于与服务发现组件（比如Netflix的Eureka）集成</li>
<li>使用Archaius完成运行时配置</li>
<li>使用JMX暴露运维指标，使用Servo发布</li>
<li>多种可插拔的序列化选择</li>
<li>异步和批处理操作（即将推出）</li>
<li>自动SLA框架（即将推出）</li>
<li>系统管理/指标控制台（即将推出）</li>
</ul>
<h3 id="Spring-Cloud-Feign"><a href="#Spring-Cloud-Feign" class="headerlink" title="Spring Cloud Feign"></a>Spring Cloud Feign</h3><p>Spring Cloud Feign 是一个声明web服务客户端，这使得编写Web服务客户端更容易，使用Feign 创建一个接口并对它进行注解，它具有可插拔的注解支持包括Feign注解与JAX-RS注解，Feign还支持可插拔的编码器与解码器，Spring Cloud 增加了对 Spring MVC的注解，Spring Web 默认使用了HttpMessageConverters, Spring Cloud 集成 Ribbon 和 Eureka 提供的负载均衡的HTTP客户端 Feign。</p>
<p>简单的可以理解为：Spring Cloud Feign 的出现使得Eureka和Ribbon的使用更为简单。</p>
<h3 id="Spring-Cloud-Hystrix"><a href="#Spring-Cloud-Hystrix" class="headerlink" title="Spring Cloud Hystrix"></a>Spring Cloud Hystrix</h3><p>当有一个服务出现了故障，而服务的调用方不知道服务出现故障，若此时调用放的请求不断的增加，最后就会等待出现故障的依赖方 相应形成任务的积压，最终导致自身服务的瘫痪。</p>
<p>Spring Cloud Hystrix正是为了解决这种情况的，防止对某一故障服务持续进行访问。Hystrix的含义是：断路器，断路器本身是一种开关装置，用于我们家庭的电路保护，防止电流的过载，当线路中有电器发生短路的时候，断路器能够及时切换故障的电器，防止发生过载、发热甚至起火等严重后果。</p>
<p><img src="/upload/images/19.png"></p>
<p>断路器可以防止一个应用程序多次试图执行一个操作，即很可能失败，允许它继续而不等待故障恢复或者浪费 CPU 周期，而它确定该故障是持久的。断路器模式也使应用程序能够检测故障是否已经解决。如果问题似乎已经得到纠正​​，应用程序可以尝试调用操作。</p>
<p><img src="/upload/images/20.png"></p>
<p>断路器增加了稳定性和灵活性，以一个系统，提供稳定性，而系统从故障中恢复，并尽量减少此故障的对性能的影响。它可以帮助快速地拒绝对一个操作，即很可能失败，而不是等待操作超时（或者不返回）的请求，以保持系统的响应时间。如果断路器提高每次改变状态的时间的事件，该信息可以被用来监测由断路器保护系统的部件的健康状况，或以提醒管理员当断路器跳闸，以在打开状态。</p>
<p>Hystrix断路器的工作流程：</p>
<p><img src="/upload/images/21.png"></p>
<h3 id="Spring-Cloud-Zuul"><a href="#Spring-Cloud-Zuul" class="headerlink" title="Spring Cloud Zuul"></a>Spring Cloud Zuul</h3><p>服务网关是微服务架构中一个不可或缺的部分。通过服务网关统一向外系统提供REST API的过程中，除了具备服务路由、均衡负载功能之外，它还具备了权限控制等功能。Spring Cloud Netflix中的Zuul就担任了这样的一个角色，为微服务架构提供了前门保护的作用，同时将权限控制这些较重的非业务逻辑内容迁移到服务路由层面，使得服务集群主体能够具备更高的可复用性和可测试性。</p>
<p><img src="/upload/images/22.png"></p>
<p>Zuul类似nginx，反向代理的功能，不过netflix自己增加了一些配合其他组件的特性。</p>
<h3 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h3><p>对于微服务还不是很多的时候，各种服务的配置管理起来还相对简单，但是当成百上千的微服务节点起来的时候，服务配置的管理变得会复杂起来。</p>
<p>分布式系统中，由于服务数量巨多，为了方便服务配置文件统一管理，实时更新，所以需要分布式配置中心组件。在Spring Cloud中，有分布式配置中心组件Spring Cloud Config ，它支持配置服务放在配置服务的内存中（即本地），也支持放在远程Git仓库中。在Spring Cloud Config 组件中，分两个角色，一是Config Server，二是Config Client。</p>
<blockquote>
<ul>
<li>Config Server用于配置属性的存储，存储的位置可以为Git仓库、SVN仓库、本地文件等</li>
<li>Config Client用于服务属性的读取</li>
</ul>
</blockquote>
<p><img src="/upload/images/23.png"></p>
<h3 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h3><p>Spring cloud bus通过轻量消息代理连接各个分布的节点。这会用在广播状态的变化（例如配置变化）或者其他的消息指令。Spring bus的一个核心思想是通过分布式的启动器对spring boot应用进行扩展，也可以用来建立一个多个应用之间的通信频道。目前唯一实现的方式是用AMQP消息代理作为通道，同样特性的设置（有些取决于通道的设置）在更多通道的文档中。</p>
<p>Spring cloud bus被国内很多都翻译为消息总线，也挺形象的。大家可以将它理解为管理和传播所有分布式项目中的消息既可，其实<strong>本质是利用了MQ的广播机制在分布式的系统中传播消息</strong>，目前常用的有Kafka和RabbitMQ。利用bus的机制可以做很多的事情，其中配置中心客户端刷新就是典型的应用场景之一，我们用一张图来描述bus在配置中心使用的机制。</p>
<p><img src="/upload/images/25.jpg"></p>
<p>根据此图我们可以看出利用Spring Cloud Bus做配置更新的步骤:</p>
<ol>
<li>提交代码触发post给客户端A发送bus/refresh</li>
<li>客户端A接收到请求从Server端更新配置并且发送给Spring Cloud Bus</li>
<li>Spring Cloud bus接到消息并通知给其它客户端</li>
<li>其它客户端接收到通知，请求Server端获取最新配置</li>
<li>全部客户端均获取到最新的配置</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2018-03-07-spring-cloud-components/" data-id="cklf7tsu2003iz8t4h3ip3dbd" data-title="Spring Cloud组件介绍" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2018-07-01-simple-springcloud" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2018-07-01-simple-springcloud/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2018-07-01-simple-springcloud/">Spring Cloud(一)：大话Spring Cloud</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="http://www.ityouknow.com/springcloud/2017/05/01/simple-springcloud.html">http://www.ityouknow.com/springcloud/2017/05/01/simple-springcloud.html</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2018-07-01-simple-springcloud/" data-id="cklf7tsu4003kz8t4bhq652wc" data-title="Spring Cloud(一)：大话Spring Cloud" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/hello-world/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/hello-world/" data-id="cklf7tsu6003oz8t4cszc0awb" data-title="Hello World" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-2016-07-25-spring-unit-test-with-junit-mockito-powermock" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-07-25-spring-unit-test-with-junit-mockito-powermock/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-07-25-spring-unit-test-with-junit-mockito-powermock/">Spring中使用JUnit+mockito+powermock进行单元测试</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Spring中执行单元测试，最麻烦的就是解决Bean的定义以及注入的问题。最开始使用Spring的上下文初始化进行测试，开头是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span> </span><br><span class="line"><span class="meta">@ContextConfiguration(&quot;/config/Spring-db1.xml&quot;)</span> </span><br></pre></td></tr></table></figure>
<p>于是，为了能让这个单元测试正常运行起来，我又Mock了一堆其他的如：MySQL，MongoDB，Redis等等无数的组件。最终测试终于可以运行起来，但是运行的时候又需要对整个Spring的上下文进行初始化，跑一个单元测试需要0.1秒，跑初始化流程就需要1分钟。不过当时单元测试并不是团队高优先级的任务，后来也就没有再研究。   </p>
<p>最近回归Bug频频出现，单元测试又开始提上日程。花了大半天时间研究了JUnit+mockito+powermock进行可行的单元测试。</p>
<h2 id="三个软件的定位"><a href="#三个软件的定位" class="headerlink" title="三个软件的定位"></a>三个软件的定位</h2><ul>
<li><strong>JUnit</strong> 作为优秀的测试框架，在Spring单元测试占有相当大的市场份额</li>
<li><strong>Mockito</strong> 管理Spring的Mock对象管理，以及依赖注入等</li>
<li><strong>PowerMock</strong> Mockito不能对构造函数、静态函数以及私有函数进行Stunning，PowerMock是Mockito基础上的增强，填补了后者这方面的空白</li>
</ul>
<h2 id="从一个例子开始：签到"><a href="#从一个例子开始：签到" class="headerlink" title="从一个例子开始：签到"></a>从一个例子开始：签到</h2><p>凡事从简单的开始，我选择了系统中最复杂模块之一————“签到”的最简单部分进行单元测试。以下是需要进行测试的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SigninResult <span class="title">signV3</span><span class="params">(String staffId, SigninType signType, String wifiName, String wifiMac, Double longitude,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Double latitude, Double radius, String locationName, String mobileId, Date signDate, String companyId, <span class="keyword">boolean</span> isSigninOnlyOnce)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.checkOutSign(signType, companyId, staffId, signDate);<span class="comment">//校验是否有相同类型的外出签到在申请中或已经审批通过了</span></span><br><span class="line">    <span class="keyword">return</span> actualSignV3(staffId, signType, wifiName, wifiMac, longitude, latitude, radius, locationName, mobileId, signDate, companyId, <span class="keyword">new</span> Date(), isSigninOnlyOnce, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>大家可以忽略乱七八糟的参数，只关注函数的两步：</p>
<ol>
<li>校验和外出签到关联的条件：checkOutSign</li>
<li>实际执行签到的逻辑：actualSignV3<br>另外需要注意的是：</li>
<li>checkOutSign是私有函数，如果其中不符合签到条件的话会抛出异常</li>
<li>actualSignV3是共有函数，在某些版本的接口中可以被其他模块直接调用<br>由于我们要演示对私有函数的测试，所以<code>checkOutSign</code>内的大致流程为：</li>
<li>获取一个外出签到记录，<code>signinOutRecordDao.findByCompanyIdAndStaffIdAndSignTypeAndSignDateAndApplicationStatusIn(xxx, xxx)</code>。（JPA实现，函数名比较长，勿喷）</li>
<li>校验外出签到，如果有异常的时候，抛出<code>IrenshiException</code></li>
</ol>
<h2 id="单元测试代码"><a href="#单元测试代码" class="headerlink" title="单元测试代码"></a>单元测试代码</h2><p>先从代码开始，然后一步步讲解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.irenshi.biz.attendance.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.irenshi.biz.attendance.dao.mysql.SigninOutRecordDao;</span><br><span class="line"><span class="keyword">import</span> cn.irenshi.biz.attendance.service.impl.SignServiceImpl;</span><br><span class="line"><span class="keyword">import</span> cn.irenshi.meta.dto.attendance.mysql.SigninOutRecord;</span><br><span class="line"><span class="keyword">import</span> cn.irenshi.meta.entity.attendance.SigninResult;</span><br><span class="line"><span class="keyword">import</span> cn.irenshi.meta.exception.IrenshiException;</span><br><span class="line"><span class="keyword">import</span> cn.irenshi.meta.type.ApplicationStatus;</span><br><span class="line"><span class="keyword">import</span> cn.irenshi.meta.type.SigninType;</span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.mockito.InjectMocks;</span><br><span class="line"><span class="keyword">import</span> org.mockito.Mock;</span><br><span class="line"><span class="keyword">import</span> org.powermock.core.classloader.annotations.PrepareOnlyThisForTest;</span><br><span class="line"><span class="keyword">import</span> org.powermock.modules.junit4.PowerMockRunner;</span><br><span class="line"><span class="keyword">import</span> org.powermock.reflect.Whitebox;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.junit.Assert.assertTrue;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Matchers.any;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Matchers.eq;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.doReturn;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.powermock.api.mockito.PowerMockito.doNothing;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.powermock.api.mockito.PowerMockito.spy;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.powermock.api.mockito.PowerMockito.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 使用名称为PowerMockRunner的JUnit模块执行单元测试</span></span><br><span class="line"><span class="meta">@RunWith(PowerMockRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SignServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 2. 使用Mockito的@InjectMocks注解将待测试的实现类注入</span></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> SignServiceImpl signService;</span><br><span class="line">    <span class="comment">// 3. 将生成MockDao，并注入到@InjectMocks指定的类中</span></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> SigninOutRecordDao signinOutRecordDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="comment">// 4. 对于final类，有private函数及static函数的类等，必须使用此注解，之后才能着Stubbing</span></span><br><span class="line">    <span class="meta">@PrepareOnlyThisForTest(SignServiceImpl.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSignV3</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String staffId = <span class="string">&quot;mockStaffId&quot;</span>;</span><br><span class="line">        SigninType signType = SigninType.SIGNIN_AFTERNOON;</span><br><span class="line">        String wifiName = <span class="string">&quot;mockWifiName&quot;</span>;</span><br><span class="line">        String wifiMac = <span class="string">&quot;mockWifiMac&quot;</span>;</span><br><span class="line">        Double longitude = <span class="number">0.0</span>;</span><br><span class="line">        Double latitude = <span class="number">0.0</span>;</span><br><span class="line">        Double radius = <span class="number">0.0</span>;</span><br><span class="line">        String locationName = <span class="string">&quot;mockLocationName&quot;</span>;</span><br><span class="line">        String mobileId = <span class="string">&quot;mockMobileId&quot;</span>;</span><br><span class="line">        Date signDate = <span class="keyword">new</span> Date();</span><br><span class="line">        String companyId = <span class="string">&quot;mockCompanyId&quot;</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isSigninOnlyOnce = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 对实体类进行Stubbing，从spy()开始</span></span><br><span class="line">        SignServiceImpl spy = spy(signService);</span><br><span class="line"></span><br><span class="line">        SigninResult signinResult = <span class="keyword">new</span> SigninResult();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 对私有函数进行Stubbing</span></span><br><span class="line">        doNothing().when(spy, <span class="string">&quot;checkOutSign&quot;</span>, signType, companyId, staffId, signDate);</span><br><span class="line">        <span class="comment">// 7. 对共有和函数进行Stubbing</span></span><br><span class="line">        <span class="comment">// 8. 因为actualSignV3含有不确定的变量，所以必须使用Matchers进行参数处理</span></span><br><span class="line">        doReturn(signinResult).when(spy).actualSignV3(eq(staffId), eq(signType), eq(wifiName), eq(wifiMac),</span><br><span class="line">                eq(longitude), eq(latitude), eq(radius), eq(locationName), eq(mobileId), eq(signDate), eq(companyId),</span><br><span class="line">                any(), eq(isSigninOnlyOnce), eq(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9. 执行即将进行测试的代码</span></span><br><span class="line">        SigninResult result = spy.signV3(staffId, signType, wifiName, wifiMac, longitude, latitude, radius, locationName, mobileId,</span><br><span class="line">                signDate, companyId, isSigninOnlyOnce);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 10. 检查该私有函数是否以给定的参数被调用了1次</span></span><br><span class="line">        verifyPrivate(spy, times(<span class="number">1</span>)).invoke(<span class="string">&quot;checkOutSign&quot;</span>, signType, companyId, staffId, signDate);</span><br><span class="line">        <span class="comment">// 11. 检查该共有函数是否以给定的参数被调用了1次</span></span><br><span class="line">        <span class="comment">// 12. 同样由于含有不确定变量，校验的时候也需要使用Matchers对参数进行处理</span></span><br><span class="line">        verify(spy, times(<span class="number">1</span>)).actualSignV3(eq(staffId), eq(signType), eq(wifiName), eq(wifiMac),</span><br><span class="line">                eq(longitude), eq(latitude), eq(radius), eq(locationName), eq(mobileId), eq(signDate), eq(companyId),</span><br><span class="line">                any(), eq(isSigninOnlyOnce), eq(<span class="keyword">false</span>));</span><br><span class="line">        <span class="comment">// 13. 校验函数的返回值是否正确</span></span><br><span class="line">        assertTrue(signinResult == result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCheckOutSign1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String staffId = <span class="string">&quot;mockStaffId&quot;</span>;</span><br><span class="line">        SigninType signType = SigninType.SIGNIN_AFTERNOON;</span><br><span class="line">        Date signDate = <span class="keyword">new</span> Date();</span><br><span class="line">        String companyId = <span class="string">&quot;mockCompanyId&quot;</span>;</span><br><span class="line"></span><br><span class="line">        SigninOutRecord record1 = <span class="keyword">new</span> SigninOutRecord();</span><br><span class="line">        SigninOutRecord record2 = <span class="keyword">new</span> SigninOutRecord();</span><br><span class="line">        SigninOutRecord record3 = <span class="keyword">new</span> SigninOutRecord();</span><br><span class="line">        SigninOutRecord record4 = <span class="keyword">new</span> SigninOutRecord();</span><br><span class="line">        SigninOutRecord record5 = <span class="keyword">new</span> SigninOutRecord();</span><br><span class="line">        record1.setApplicationStatus(ApplicationStatus.CANCEL_APPROVED);</span><br><span class="line">        record2.setApplicationStatus(ApplicationStatus.CANCEL_PROCESSING);</span><br><span class="line">        record3.setApplicationStatus(ApplicationStatus.DELETE);</span><br><span class="line">        record4.setApplicationStatus(ApplicationStatus.DENIED);</span><br><span class="line">        record5.setApplicationStatus(ApplicationStatus.PROCESSING);</span><br><span class="line">        <span class="comment">// 14. 对Mock的接口进行处理，定义接口的返回值</span></span><br><span class="line">        doReturn(Lists.newArrayList(record1, record2, record3, record4)).when(signinOutRecordDao)</span><br><span class="line">                .findByCompanyIdAndStaffIdAndSignTypeAndSignDateAndApplicationStatusIn(companyId, staffId,</span><br><span class="line">                        signType, signDate, Lists.newArrayList(ApplicationStatus.APPROVED,</span><br><span class="line">                                ApplicationStatus.WAITING_HR_APPROVAL, ApplicationStatus.PROCESSING));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 15. 执行私有函数进行测试</span></span><br><span class="line">        Whitebox.invokeMethod(signService, <span class="string">&quot;checkOutSign&quot;</span>, signType, companyId, staffId, signDate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 16. 校验Mock的对象的函数是否被调用了1次</span></span><br><span class="line">        verify(signinOutRecordDao, times(<span class="number">1</span>)).findByCompanyIdAndStaffIdAndSignTypeAndSignDateAndApplicationStatusIn(companyId, staffId,</span><br><span class="line">                signType, signDate, Lists.newArrayList(ApplicationStatus.APPROVED,</span><br><span class="line">                        ApplicationStatus.WAITING_HR_APPROVAL, ApplicationStatus.PROCESSING));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 17. 该函数预计会产生Exception</span></span><br><span class="line">    <span class="meta">@Test(expected = IrenshiException.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCheckOutSign2</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String staffId = <span class="string">&quot;mockStaffId&quot;</span>;</span><br><span class="line">        SigninType signType = SigninType.SIGNIN_AFTERNOON;</span><br><span class="line">        Date signDate = <span class="keyword">new</span> Date();</span><br><span class="line">        String companyId = <span class="string">&quot;mockCompanyId&quot;</span>;</span><br><span class="line"></span><br><span class="line">        SigninOutRecord record = <span class="keyword">new</span> SigninOutRecord();</span><br><span class="line">        record.setApplicationStatus(ApplicationStatus.APPROVED);</span><br><span class="line">        doReturn(Lists.newArrayList(record)).when(signinOutRecordDao)</span><br><span class="line">                .findByCompanyIdAndStaffIdAndSignTypeAndSignDateAndApplicationStatusIn(companyId, staffId,</span><br><span class="line">                        signType, signDate, Lists.newArrayList(ApplicationStatus.APPROVED,</span><br><span class="line">                                ApplicationStatus.WAITING_HR_APPROVAL, ApplicationStatus.PROCESSING));</span><br><span class="line"></span><br><span class="line">        Whitebox.invokeMethod(signService, <span class="string">&quot;checkOutSign&quot;</span>, signType, companyId, staffId, signDate);</span><br><span class="line"></span><br><span class="line">        verify(signinOutRecordDao, times(<span class="number">1</span>)).findByCompanyIdAndStaffIdAndSignTypeAndSignDateAndApplicationStatusIn(companyId, staffId,</span><br><span class="line">                signType, signDate, Lists.newArrayList(ApplicationStatus.APPROVED,</span><br><span class="line">                        ApplicationStatus.WAITING_HR_APPROVAL, ApplicationStatus.PROCESSING));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="代码详细分析"><a href="#代码详细分析" class="headerlink" title="代码详细分析"></a>代码详细分析</h2><h3 id="使用JUnit测试框架启动"><a href="#使用JUnit测试框架启动" class="headerlink" title="使用JUnit测试框架启动"></a>使用JUnit测试框架启动</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(PowerMockRunner.class)</span></span><br></pre></td></tr></table></figure>
<p><code>@RunWith</code>是JUnit的注解，可以指定测试用的Runner。如：使用Spring上下文做测试的代码为<code>@RunWith(SpringJUnit4ClassRunner.class) </code>，使用纯Mockito的代码为<code>@RunWith(MockitoJUnitRunner.class)</code></p>
<h3 id="注入待测试的类"><a href="#注入待测试的类" class="headerlink" title="注入待测试的类"></a>注入待测试的类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InjectMocks</span></span><br><span class="line"><span class="keyword">private</span> SignServiceImpl signService;</span><br></pre></td></tr></table></figure>
<p><code>@InjectMocks</code>是原生Mockito的注解，负责将待测试的类注入到单元测试中。这里需要注意：</p>
<ol>
<li>此处的对象（SignServiceImpl）必须是实体对象，不能是接口或者抽象类。因为<code>InjectMocks</code>需要实例化该对象</li>
<li>对象中所有的依赖注入都会以一个简单粗暴的方式解决，默认将所有的<code>@Autowired</code>对象注入成<code>null</code><br>所以，只要增加这个注解就可以快速生成一个对象，比Spring的Bean管理简单很多。</li>
</ol>
<h3 id="Mock一个Bean"><a href="#Mock一个Bean" class="headerlink" title="Mock一个Bean"></a>Mock一个Bean</h3><p>大部分情况下，我们还是要Mock一些Bean，来辅助完成单元测试的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mock</span></span><br><span class="line"><span class="keyword">private</span> SigninOutRecordDao signinOutRecordDao;</span><br></pre></td></tr></table></figure>
<p><code>@Mock</code>也是原生Mockito的注解，增加该Mock之后，<code>SignServiceImpl</code>所有依赖<code>SigninOutRecordDao</code>的地方，都会被注入成该对象。我们可以对Mock的对象进行各种操作，修改函数调用行为（称作Stub，有人叫“打桩”）等。</p>
<h3 id="测试类包含私有函数的调用时"><a href="#测试类包含私有函数的调用时" class="headerlink" title="测试类包含私有函数的调用时"></a>测试类包含私有函数的调用时</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@PrepareOnlyThisForTest(SignServiceImpl.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSignV3</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span></span><br></pre></td></tr></table></figure>
<p><code>@Test</code>注解不用说，就是生成一个测试用例。<code>@PrepareOnlyThisForTest</code>需要特别注意。因为我们在测试<code>SignServiceImpl</code>的过程中，需要对<code>SignServiceImpl</code>的私有函数<code>checkOutSign</code>进行Stubbing，修改其行为，所以必须使用<code>@PrepareOnlyThisForTest(SignServiceImpl.class)</code>为Stubbing做好准备。</p>
<h3 id="为测试实体Stubbing"><a href="#为测试实体Stubbing" class="headerlink" title="为测试实体Stubbing"></a>为测试实体Stubbing</h3><p>测试的时候，我们需要用到实体类，但又不想使用实体类的所有实现函数。所以我们需要针对特定的某些函数进行Stubbing。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SignServiceImpl spy = spy(signService);</span><br></pre></td></tr></table></figure>
<p>对Mock的接口（如：SigninOutRecordDao signinOutRecordDao）来说，直接对其中的函数进行Stub即可。但如果要对测试实体进行Stubbing，则需要先对其进行<code>spy</code>。然后即可开展后边的Stubbing操作。</p>
<h3 id="对函数进行Stubbing"><a href="#对函数进行Stubbing" class="headerlink" title="对函数进行Stubbing"></a>对函数进行Stubbing</h3><p>先从对Mock对象进行的Stubbing开始。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">doReturn(Lists.newArrayList(record1, record2, record3, record4)).when(signinOutRecordDao)</span><br><span class="line">                .findByCompanyIdAndStaffIdAndSignTypeAndSignDateAndApplicationStatusIn(companyId, staffId,</span><br><span class="line">                        signType, signDate, Lists.newArrayList(ApplicationStatus.APPROVED,</span><br><span class="line">                                ApplicationStatus.WAITING_HR_APPROVAL, ApplicationStatus.PROCESSING));</span><br></pre></td></tr></table></figure>
<p>这个函数对<code>signinOutRecordDao</code>进行Stubbing。根据字面意思可以理解：</p>
<pre><code>This function will be stubbed as: **return** the given **List** when **signinOutRecordDao**
is called by **findByCompanyIdAndStaffIdAndSignTypeAndSignDateAndApplicationStatusIn**
with these **parameters**
</code></pre>
<p>都比较容易理解。</p>
<h3 id="对私有函数进行Stubbing"><a href="#对私有函数进行Stubbing" class="headerlink" title="对私有函数进行Stubbing"></a>对私有函数进行Stubbing</h3><p>对私有函数进行Stubbing和公共函数类似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doNothing().when(spy, <span class="string">&quot;checkOutSign&quot;</span>, signType, companyId, staffId, signDate);</span><br></pre></td></tr></table></figure>
<p>在这里，Stubbing对象是实体<code>spy</code>的<code>checkOutSign</code>函数，参数为<code>signType, companyId, staffId, signDate</code>。</p>
<h3 id="当被Stub的函数不是确定输入参数时"><a href="#当被Stub的函数不是确定输入参数时" class="headerlink" title="当被Stub的函数不是确定输入参数时"></a>当被Stub的函数不是确定输入参数时</h3><p><code>actualSignV3</code>这个函数在调用的时候，用了一个很Anti-Pattern的一个设计，<code>signTime</code>这个参数用的是<code>new Date()</code>。暂且先不讨论代码的质量，先看看下边的Stub代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">doReturn(signinResult).when(spy).actualSignV3(eq(staffId), eq(signType), eq(wifiName), eq(wifiMac),</span><br><span class="line">                eq(longitude), eq(latitude), eq(radius), eq(locationName), eq(mobileId), eq(signDate), eq(companyId),</span><br><span class="line">                any(), eq(isSigninOnlyOnce), eq(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure>
<p><code>any()</code>函数意思是，当<code>actualSignV3</code>函数调用的时候，无论<code>signTime</code>这个参数是什么值，这个Stubbing均生效。需要注意的是，一旦函数参数里边有任何一个<code>any</code>或类似的<code>Matcher</code>函数（如<code>anyInt</code>，<code>anyString</code>等）时，其他所有参数也必须以同样的形式出现。<br>上边代码中可以看到所有参数都使用了<code>eq()</code>进行封装。</p>
<h3 id="另一种Stubbing方法（不推荐）"><a href="#另一种Stubbing方法（不推荐）" class="headerlink" title="另一种Stubbing方法（不推荐）"></a>另一种Stubbing方法（不推荐）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">when(spy.actualSignV3(eq(staffId), eq(signType), eq(wifiName), eq(wifiMac),</span><br><span class="line">        eq(longitude), eq(latitude), eq(radius), eq(locationName), eq(mobileId), eq(signDate), eq(companyId),</span><br><span class="line">        any(), eq(isSigninOnlyOnce), eq(<span class="keyword">false</span>))).thenReturn(signinResult);</span><br></pre></td></tr></table></figure>
<p>这种Stubbing比较符合汉语的语法：当xxx的时候，怎么怎么样。但是这样Stub有一个不好的地方，Stub的时候会首先执行<code>actualSignV3</code>的原版函数，然后再进行替换。可向而知，由于很多Bean都没有定义，直接抛<code>NullPointerException</code>。</p>
<h3 id="执行测试代码"><a href="#执行测试代码" class="headerlink" title="执行测试代码"></a>执行测试代码</h3><p>执行测试代码的方法和普通调用一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SigninResult result = spy.signV3(staffId, signType, wifiName, wifiMac, longitude, latitude, radius, locationName, mobileId,</span><br><span class="line">        signDate, companyId, isSigninOnlyOnce);</span><br></pre></td></tr></table></figure>
<p>但这里仍有需要注意的地方：当调用的时候，只能使用被spy的对象<code>spy</code>，而不能使用原对象<code>signService</code>。因为只有<code>spy</code>被Stubbed了，而<code>signService</code>仍然保持不变。</p>
<h3 id="校验函数调用情况"><a href="#校验函数调用情况" class="headerlink" title="校验函数调用情况"></a>校验函数调用情况</h3><p>校验<code>checkOutSign</code>函数是否以给定的参数<code>signType, companyId, staffId, signDate</code>被调用了<strong>一次</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">verifyPrivate(spy, times(<span class="number">1</span>)).invoke(<span class="string">&quot;checkOutSign&quot;</span>, signType, companyId, staffId, signDate);</span><br></pre></td></tr></table></figure>

<h3 id="校验具有不确定参数的函数时"><a href="#校验具有不确定参数的函数时" class="headerlink" title="校验具有不确定参数的函数时"></a>校验具有不确定参数的函数时</h3><p>和Stubbing的时候一样，校验时如果有任意一个参数使用了<code>Matcher</code>形式，则其他所有函数都必须使用<code>Matcher</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">verify(spy, times(<span class="number">1</span>)).actualSignV3(eq(staffId), eq(signType), eq(wifiName), eq(wifiMac),</span><br><span class="line">        eq(longitude), eq(latitude), eq(radius), eq(locationName), eq(mobileId), eq(signDate), eq(companyId),</span><br><span class="line">        any(), eq(isSigninOnlyOnce), eq(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure>

<h3 id="校验输出结果"><a href="#校验输出结果" class="headerlink" title="校验输出结果"></a>校验输出结果</h3><p>这个没什么好说的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assertTrue(signinResult == result);</span><br></pre></td></tr></table></figure>

<h3 id="对私有函数进行测试"><a href="#对私有函数进行测试" class="headerlink" title="对私有函数进行测试"></a>对私有函数进行测试</h3><p>私有函数测试的难点在于我们没有办法调用私有函数，但是PowerMock帮我们解决了这个问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Whitebox.invokeMethod(signService, <span class="string">&quot;checkOutSign&quot;</span>, signType, companyId, staffId, signDate);</span><br></pre></td></tr></table></figure>
<p>PowerMock使用<code>Writebox</code>，通过反射的方式调用<code>checkOutSign</code>这个函数。</p>
<h3 id="正确运行会抛出异常"><a href="#正确运行会抛出异常" class="headerlink" title="正确运行会抛出异常"></a>正确运行会抛出异常</h3><p>这个也没什么好说的，JUnit4原生的处理方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test(expected = IrenshiException.class)</span></span><br></pre></td></tr></table></figure>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>一个框架+一个Mock+一个Mock增强，基本可以满足大部分单元测试的需求了，在配合使用Jenkins等CI工具，单元测试是要飞起来的节奏！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-07-25-spring-unit-test-with-junit-mockito-powermock/" data-id="cklf7tsvf008iz8t4bnm3fss1" data-title="Spring中使用JUnit+mockito+powermock进行单元测试" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JUnit/" rel="tag">JUnit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mockito/" rel="tag">Mockito</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PowerMock/" rel="tag">PowerMock</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" rel="tag">单元测试</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-07-30-use-rc4-in-tencent-mail" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-07-30-use-rc4-in-tencent-mail/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-07-30-use-rc4-in-tencent-mail/">RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>7月29日开始，腾讯修改了邮箱的加密方式，导致我们线上的所有的腾讯代收、代发邮件的功能全部失效。解决方法在最后，如果需要可直接跳转至<a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95">解决方法</a>一节</p>
<h3 id="问题出现"><a href="#问题出现" class="headerlink" title="问题出现"></a>问题出现</h3><p>7月29日开始，线上的所有的腾讯代收、代发邮件的功能全部失效，报<code>handshake_error</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">javax.mail.MessagingException: Connect failed;</span><br><span class="line">  nested exception is:</span><br><span class="line">	javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure</span><br><span class="line">	at com.sun.mail.pop3.POP3Store.protocolConnect(POP3Store.java:209)</span><br><span class="line">	at javax.mail.Service.connect(Service.java:295)</span><br><span class="line">	at javax.mail.Service.connect(Service.java:176)</span><br><span class="line">	at cn.irenshi.biz.recruit.service.impl.RecruitReceiveMailServiceImpl.testConnect(RecruitReceiveMailServiceImpl.java:507)</span><br><span class="line">	at cn.irenshi.biz.recruit.service.impl.RecruitReceiveMailServiceImpl.testMailConnect(RecruitReceiveMailServiceImpl.java:534)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:497)</span><br><span class="line">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:302)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:190)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157)</span><br><span class="line">	... more</span><br><span class="line"></span><br><span class="line">Caused by: javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure</span><br><span class="line">	at sun.security.ssl.Alerts.getSSLException(Alerts.java:192)</span><br><span class="line">	at sun.security.ssl.Alerts.getSSLException(Alerts.java:154)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.recvAlert(SSLSocketImpl.java:2023)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:1125)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:1375)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:1403)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:1387)</span><br><span class="line">	at com.sun.mail.util.SocketFetcher.configureSSLSocket(SocketFetcher.java:549)</span><br><span class="line">	at com.sun.mail.util.SocketFetcher.createSocket(SocketFetcher.java:354)</span><br><span class="line">	at com.sun.mail.util.SocketFetcher.getSocket(SocketFetcher.java:237)</span><br><span class="line">	at com.sun.mail.pop3.Protocol.&lt;init&gt;(Protocol.java:112)</span><br><span class="line">	at com.sun.mail.pop3.POP3Store.getPort(POP3Store.java:260)</span><br><span class="line">	at com.sun.mail.pop3.POP3Store.protocolConnect(POP3Store.java:205)</span><br><span class="line">	... 132 more</span><br></pre></td></tr></table></figure>
<p>记得当时用客户端链接腾讯的企业邮箱时，报证书警告，警告原因是<code>pop.exmail.qq.com</code>这个域名使用了<code>pop.qq.com</code>这个证书，应该是为了省钱吧。但是当用QQ个人邮箱连接的时候，确实使用了正确的证书，那错误原因应该不同。</p>
<h3 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h3><p>把问题交给做邮箱连接的同事，结果同事很快告诉我，他在windows上运行代码完全没有任何问题，并且JDK都用了相同的版本：1.8.0_u60。难道这个错误和系统相关？<br>打开Thunderbird尝试连接腾讯邮箱，发现一切也正常。可以断定这个问题不是系统相关的，问题一定出在我们的代码中。网上搜了一些<code>handshake_failure</code>相关的原因如下（<a target="_blank" rel="noopener" href="http://stackoverflow.com/a/6353956" title="StackOverflow">StackOverflow</a>）：</p>
<blockquote>
<ul>
<li>Incompatible cipher suites in use by the client and the server. This would require the client to use (or enable) a cipher suite that is supported by the server.</li>
<li>Incompatible versions of SSL in use (the server might accept only TLS v1, while the client is capable of only using SSL v3). Again, the client might have to ensure that it uses a compatible version of the SSL/TLS protocol.</li>
<li>Incomplete trust path for the server certificate; the server’s certificate is probably not trusted by the client. This would usually result in a more verbose error, but it is quite possible. Usually the fix is to import the server’s CA certificate into the client’s trust store.</li>
<li>The cerificate is issued for a different domain. Again, this would have resulted in a more verbose message, but I’ll state the fix here in case this is the cause. The resolution in this case would be get the server (it does not appear to be yours) to use the correct certificate.</li>
</ul>
</blockquote>
<p>问题来了，如果以上是问题所在的话，一定会有一些错误信息输出，但为什么在我的系统中没有任何输出？</p>
<p>想到telnet，因为一般测试邮箱连接都直接使用telnet明文测试一下。当然这个想法是不可行的，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-PC:~$ telnet pop.qq.com 995</span><br><span class="line">Trying 163.177.72.198...</span><br><span class="line">Connected to pop.qq.com.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br></pre></td></tr></table></figure>
<p>没有办法输入任何东西，原因也很简单，995端口使用了加密。（这里犯迷糊了，现在握手错误就是因为加密问题…）</p>
<p>换一个方式连接POP邮箱：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect pop.qq.com:995</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">CONNECTED(00000003)</span><br><span class="line">depth&#x3D;2 C &#x3D; US, O &#x3D; GeoTrust Inc., CN &#x3D; GeoTrust Global CA</span><br><span class="line">verify return:1</span><br><span class="line">depth&#x3D;1 C &#x3D; US, O &#x3D; GeoTrust Inc., CN &#x3D; GeoTrust SSL CA - G3</span><br><span class="line">verify return:1</span><br><span class="line">depth&#x3D;0 C &#x3D; CN, ST &#x3D; Guangdong, L &#x3D; Shenzhen, O &#x3D; Shenzhen Tencent Computer Systems Company Limited, OU &#x3D; R&amp;D, CN &#x3D; pop.qq.com</span><br><span class="line">verify return:1</span><br><span class="line">---</span><br><span class="line">Certificate chain</span><br><span class="line"> 0 s:&#x2F;C&#x3D;CN&#x2F;ST&#x3D;Guangdong&#x2F;L&#x3D;Shenzhen&#x2F;O&#x3D;Shenzhen Tencent Computer Systems Company Limited&#x2F;OU&#x3D;R&amp;D&#x2F;CN&#x3D;pop.qq.com</span><br><span class="line">   i:&#x2F;C&#x3D;US&#x2F;O&#x3D;GeoTrust Inc.&#x2F;CN&#x3D;GeoTrust SSL CA - G3</span><br><span class="line"> 1 s:&#x2F;C&#x3D;US&#x2F;O&#x3D;GeoTrust Inc.&#x2F;CN&#x3D;GeoTrust SSL CA - G3</span><br><span class="line">   i:&#x2F;C&#x3D;US&#x2F;O&#x3D;GeoTrust Inc.&#x2F;CN&#x3D;GeoTrust Global CA</span><br><span class="line">---</span><br><span class="line">Server certificate</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIGbzCCBVegAwIBAgIQZlTnxqFc&#x2F;rVo50RzuVnejDANBgkqhkiG9w0BAQsFADBE</span><br><span class="line">MQswCQYDVQQGEwJVUzEWMBQGA1UEChMNR2VvVHJ1c3QgSW5jLjEdMBsGA1UEAxMU</span><br><span class="line">R2VvVHJ1c3QgU1NMIENBIC0gRzMwHhcNMTYwMTI3MDAwMDAwWhcNMTYxMDIzMjM1</span><br><span class="line">OTU5WjCBkzELMAkGA1UEBhMCQ04xEjAQBgNVBAgTCUd1YW5nZG9uZzERMA8GA1UE</span><br><span class="line">BxQIU2hlbnpoZW4xOjA4BgNVBAoUMVNoZW56aGVuIFRlbmNlbnQgQ29tcHV0ZXIg</span><br><span class="line">U3lzdGVtcyBDb21wYW55IExpbWl0ZWQxDDAKBgNVBAsUA1ImRDETMBEGA1UEAxQK</span><br><span class="line">cG9wLnFxLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALeSY7Vb</span><br><span class="line">60Cvv7P2O+zhaZnqlz&#x2F;KFs&#x2F;&#x2F;DH4It3xmyMPFOPUFopzN1h8n3&#x2F;4FPqGBtqEEuWBE</span><br><span class="line">&#x2F;o7soZT30E8bw30Tl07VOcYm&#x2F;fPKi1pyro3hNEdLi5Wlta9fKxDAvw0U3clSq39R</span><br><span class="line">qihYIDAA3QrDuqI54gULa5IZnqM16A9VBULPfIDaXbdgaAIJ5Ak92nC13YcdQYuv</span><br><span class="line">egL6jOWSKzCRTqeRAg+6dWkfce1+gAOCuCUDgAso2EJ+k9nFe&#x2F;LAMMGdGbe4KI9H</span><br><span class="line">CwpDCMo+2k2u4SQtXOmuYke7nNmRnpJeL3qZnGWsqT7l3N0mYCc&#x2F;+3zcMfAcmyuo</span><br><span class="line">H90stoWF&#x2F;G2T2rcCAwEAAaOCAwswggMHMIIBggYDVR0RBIIBeTCCAXWCCm14Mi5x</span><br><span class="line">cS5jb22CEmltYXAuZXhtYWlsLnFxLmNvbYISdXBsb2FkLm1haWwucXEuY29tgg90</span><br><span class="line">ZWwubWFpbC5xcS5jb22CFGh3c210cC5leG1haWwucXEuY29tgg9tb2IubWFpbC5x</span><br><span class="line">cS5jb22CEXJ0eC5leG1haWwucXEuY29tgg1teGJpejIucXEuY29tgg1teGJpejEu</span><br><span class="line">cXEuY29tgg5oay5tYWlsLnFxLmNvbYIOY2xvdWRteC5xcS5jb22CFGh3aW1hcC5l</span><br><span class="line">eG1haWwucXEuY29tggpteDEucXEuY29tghJzbXRwLmV4bWFpbC5xcS5jb22CEXBv</span><br><span class="line">cC5leG1haWwucXEuY29tghNod3BvcC5leG1haWwucXEuY29tggpteDMucXEuY29t</span><br><span class="line">ggtzbXRwLnFxLmNvbYIKZGF2LnFxLmNvbYIJZXgucXEuY29tgg9jbmMubWFpbC5x</span><br><span class="line">cS5jb22CC2ltYXAucXEuY29tggpwb3AucXEuY29tMAkGA1UdEwQCMAAwDgYDVR0P</span><br><span class="line">AQH&#x2F;BAQDAgWgMCsGA1UdHwQkMCIwIKAeoByGGmh0dHA6Ly9nbi5zeW1jYi5jb20v</span><br><span class="line">Z24uY3JsMIGdBgNVHSAEgZUwgZIwgY8GBmeBDAECAjCBhDA&#x2F;BggrBgEFBQcCARYz</span><br><span class="line">aHR0cHM6Ly93d3cuZ2VvdHJ1c3QuY29tL3Jlc291cmNlcy9yZXBvc2l0b3J5L2xl</span><br><span class="line">Z2FsMEEGCCsGAQUFBwICMDUMM2h0dHBzOi8vd3d3Lmdlb3RydXN0LmNvbS9yZXNv</span><br><span class="line">dXJjZXMvcmVwb3NpdG9yeS9sZWdhbDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYB</span><br><span class="line">BQUHAwIwHwYDVR0jBBgwFoAU0m&#x2F;3lvSFP3I8MH0j2oV4m6N8WnwwVwYIKwYBBQUH</span><br><span class="line">AQEESzBJMB8GCCsGAQUFBzABhhNodHRwOi8vZ24uc3ltY2QuY29tMCYGCCsGAQUF</span><br><span class="line">BzAChhpodHRwOi8vZ24uc3ltY2IuY29tL2duLmNydDANBgkqhkiG9w0BAQsFAAOC</span><br><span class="line">AQEAvta4aGvK5qe31ZnLbmtblhgLD11dAdSom3sEnkF8UHtoi+gPiHBmHy1t39Du</span><br><span class="line">2w+5aeriqwsetdDNuAhh6ckKJhGjc9ochWw2lvyuHPko8sSDdBd&#x2F;oUYBh60lREwB</span><br><span class="line">DoAi7x37QIjia4yprFCNs&#x2F;+bV+bee+2nijeNYibgwLQ+5jZL89jC6BVXxLSTenVw</span><br><span class="line">B2bzQPauNo+DOsB6ubY&#x2F;i5r9p2E1DHAO9AluN&#x2F;epJZ1gwZhYlOey71s59341w&#x2F;ql</span><br><span class="line">ZJImDrWch+Gj1ZgnXWnttgOSafqynPA6VtiFyYGF4zLboxIkNiyuwj+ZzuugV97z</span><br><span class="line">IurYVE9FA7vTlfeJhAkG2gIwsA&#x3D;&#x3D;</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">subject&#x3D;&#x2F;C&#x3D;CN&#x2F;ST&#x3D;Guangdong&#x2F;L&#x3D;Shenzhen&#x2F;O&#x3D;Shenzhen Tencent Computer Systems Company Limited&#x2F;OU&#x3D;R&amp;D&#x2F;CN&#x3D;pop.qq.com</span><br><span class="line">issuer&#x3D;&#x2F;C&#x3D;US&#x2F;O&#x3D;GeoTrust Inc.&#x2F;CN&#x3D;GeoTrust SSL CA - G3</span><br><span class="line">---</span><br><span class="line">No client certificate CA names sent</span><br><span class="line">---</span><br><span class="line">SSL handshake has read 3070 bytes and written 619 bytes</span><br><span class="line">---</span><br><span class="line">New, TLSv1&#x2F;SSLv3, Cipher is RC4-SHA</span><br><span class="line">Server public key is 2048 bit</span><br><span class="line">Secure Renegotiation IS supported</span><br><span class="line">Compression: NONE</span><br><span class="line">Expansion: NONE</span><br><span class="line">No ALPN negotiated</span><br><span class="line">SSL-Session:</span><br><span class="line">    Protocol  : TLSv1.2</span><br><span class="line">    Cipher    : RC4-SHA</span><br><span class="line">    Session-ID: E278833690D2364F44B8E2B6D3F3708888411AD55298F02A0710C73FE229BBE9</span><br><span class="line">    Session-ID-ctx: </span><br><span class="line">    Master-Key: AF8A9394C87F52872A31DCC5ED62FF5F97B6F621CC9337E151D5F6229E9F231626F10B392A1938669EE72911ABD860D6</span><br><span class="line">    Key-Arg   : None</span><br><span class="line">    PSK identity: None</span><br><span class="line">    PSK identity hint: None</span><br><span class="line">    SRP username: None</span><br><span class="line">    TLS session ticket lifetime hint: 300 (seconds)</span><br><span class="line">    TLS session ticket:</span><br><span class="line">    0000 - 6c 30 25 d9 92 71 25 7c-3e bd 7b e6 e2 a5 13 d1   l0%..q%|&gt;.&#123;.....</span><br><span class="line">    0010 - 9b f9 61 e6 3d dc e6 ea-96 9d 04 02 ea 6f 68 0f   ..a.&#x3D;........oh.</span><br><span class="line">    0020 - 18 a3 a3 e6 39 02 b9 d2-dd d1 2c 18 6d 9c 87 e5   ....9.....,.m...</span><br><span class="line">    0030 - 31 a9 53 a0 6c 2d 4c b6-d4 d6 35 ef d9 04 b0 b9   1.S.l-L...5.....</span><br><span class="line">    0040 - 70 af 82 74 1e 1d 26 9a-00 00 6b 90 2e eb 56 e9   p..t..&amp;...k...V.</span><br><span class="line">    0050 - d8 f4 cd 56 d5 c2 02 80-0e d9 15 e5 2a b9 1f f3   ...V........*...</span><br><span class="line">    0060 - 8a 90 7b c0 72 6e c5 2a-04 2c 91 1c 11 fd 40 ba   ..&#123;.rn.*.,....@.</span><br><span class="line">    0070 - 38 fb db fb eb b7 65 e1-e1 51 1a e3 b2 f3 64 4e   8.....e..Q....dN</span><br><span class="line">    0080 - 54 6b 5f 0e 9d be 40 60-dd 68 8f 52 5d f3 48 36   Tk_...@&#96;.h.R].H6</span><br><span class="line">    0090 - 40 7b 11 68 10 7f 7d e2-d6 93 19 48 42 f0 da bc   @&#123;.h..&#125;....HB...</span><br><span class="line"></span><br><span class="line">    Start Time: 1470455760</span><br><span class="line">    Timeout   : 300 (sec)</span><br><span class="line">    Verify return code: 0 (ok)</span><br><span class="line">---</span><br><span class="line">+OK QQMail POP3 Server v1.0 Service Ready(QQMail v2.0)</span><br></pre></td></tr></table></figure>
<p>注意到以下片段</p>
<blockquote>
<p>SSL-Session:<br>   Protocol  : TLSv1.2<br>   Cipher    : RC4-SHA</p>
</blockquote>
<p>可以看到，加密使用的协议是<code>TLSv1.2</code>，Cipher使用的是<code>RC4-SHA</code>。</p>
<p>那么问题是出在这两个地方吗？</p>
<h3 id="JavaMail握手时的Protocol和Cipher"><a href="#JavaMail握手时的Protocol和Cipher" class="headerlink" title="JavaMail握手时的Protocol和Cipher"></a>JavaMail握手时的Protocol和Cipher</h3><p>在Java启动中增加参数<code>-Djavax.net.debug=all</code>可以开启加密协议的调试模式。详情可以参考<a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/6/docs/technotes/guides/security/jsse/ReadDebug.html">Oracle提供的文档</a>。</p>
<p>开启之后，连接邮箱握手的过程中打出了以下日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">trigger seeding of SecureRandom</span><br><span class="line">done seeding SecureRandom</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Allow unsafe renegotiation: false</span><br><span class="line">Allow legacy hello messages: true</span><br><span class="line">Is initial handshake: true</span><br><span class="line">Is secure renegotiation: false</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">%% No cached client session</span><br><span class="line">*** ClientHello, TLSv1.2</span><br><span class="line">RandomCookie:  GMT: 1453331365 bytes &#x3D; &#123; 172, 246, 197, 31, 208, 63, 31, 30, 107, 70, 211, 242, 90, 243, 100, 108, 44, 192, 70, 4, 238, 84, 176, 59, 5, 75, 162, 127 &#125;</span><br><span class="line">Session ID:  &#123;&#125;</span><br><span class="line">Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]</span><br><span class="line">Compression Methods:  &#123; 0 &#125;</span><br><span class="line">Extension elliptic_curves, curve names: &#123;secp256r1, sect163k1, sect163r2, secp192r1, secp224r1, sect233k1, sect233r1, sect283k1, sect283r1, secp384r1, sect409k1, sect409r1, secp521r1, sect571k1, sect571r1, secp160k1, secp160r1, secp160r2, sect163r1, secp192k1, sect193r1, sect193r2, secp224k1, sect239k1, secp256k1&#125;</span><br><span class="line">Extension ec_point_formats, formats: [uncompressed]</span><br><span class="line">Extension signature_algorithms, signature_algorithms: SHA512withECDSA, SHA512withRSA, SHA384withECDSA, SHA384withRSA, SHA256withECDSA, SHA256withRSA, SHA224withECDSA, SHA224withRSA, SHA1withECDSA, SHA1withRSA, SHA1withDSA, MD5withRSA</span><br><span class="line">Extension server_name, server_name: [type&#x3D;host_name (0), value&#x3D;pop.qq.com]</span><br><span class="line">***</span><br><span class="line">[write] MD5 and SHA1 hashes:  len &#x3D; 214</span><br><span class="line">0000: 01 00 00 D2 03 03 57 A0   14 A5 AC F6 C5 1F D0 3F  ......W........?</span><br><span class="line">0010: 1F 1E 6B 46 D3 F2 5A F3   64 6C 2C C0 46 04 EE 54  ..kF..Z.dl,.F..T</span><br><span class="line">0020: B0 3B 05 4B A2 7F 00 00   3A C0 23 C0 27 00 3C C0  .;.K....:.#.&#39;.&lt;.</span><br><span class="line">0030: 25 C0 29 00 67 00 40 C0   09 C0 13 00 2F C0 04 C0  %.).g.@.....&#x2F;...</span><br><span class="line">0040: 0E 00 33 00 32 C0 2B C0   2F 00 9C C0 2D C0 31 00  ..3.2.+.&#x2F;...-.1.</span><br><span class="line">0050: 9E 00 A2 C0 08 C0 12 00   0A C0 03 C0 0D 00 16 00  ................</span><br><span class="line">0060: 13 00 FF 01 00 00 6F 00   0A 00 34 00 32 00 17 00  ......o...4.2...</span><br><span class="line">0070: 01 00 03 00 13 00 15 00   06 00 07 00 09 00 0A 00  ................</span><br><span class="line">0080: 18 00 0B 00 0C 00 19 00   0D 00 0E 00 0F 00 10 00  ................</span><br><span class="line">0090: 11 00 02 00 12 00 04 00   05 00 14 00 08 00 16 00  ................</span><br><span class="line">00A0: 0B 00 02 01 00 00 0D 00   1A 00 18 06 03 06 01 05  ................</span><br><span class="line">00B0: 03 05 01 04 03 04 01 03   03 03 01 02 03 02 01 02  ................</span><br><span class="line">00C0: 02 01 01 00 00 00 0F 00   0D 00 00 0A 70 6F 70 2E  ............pop.</span><br><span class="line">00D0: 71 71 2E 63 6F 6D                                  qq.com</span><br><span class="line">http-nio-8080-exec-2, WRITE: TLSv1.2 Handshake, length &#x3D; 214</span><br><span class="line">[Raw write]: length &#x3D; 219</span><br><span class="line">0000: 16 03 03 00 D6 01 00 00   D2 03 03 57 A0 14 A5 AC  ...........W....</span><br><span class="line">0010: F6 C5 1F D0 3F 1F 1E 6B   46 D3 F2 5A F3 64 6C 2C  ....?..kF..Z.dl,</span><br><span class="line">0020: C0 46 04 EE 54 B0 3B 05   4B A2 7F 00 00 3A C0 23  .F..T.;.K....:.#</span><br><span class="line">0030: C0 27 00 3C C0 25 C0 29   00 67 00 40 C0 09 C0 13  .&#39;.&lt;.%.).g.@....</span><br><span class="line">0040: 00 2F C0 04 C0 0E 00 33   00 32 C0 2B C0 2F 00 9C  .&#x2F;.....3.2.+.&#x2F;..</span><br><span class="line">0050: C0 2D C0 31 00 9E 00 A2   C0 08 C0 12 00 0A C0 03  .-.1............</span><br><span class="line">0060: C0 0D 00 16 00 13 00 FF   01 00 00 6F 00 0A 00 34  ...........o...4</span><br><span class="line">0070: 00 32 00 17 00 01 00 03   00 13 00 15 00 06 00 07  .2..............</span><br><span class="line">0080: 00 09 00 0A 00 18 00 0B   00 0C 00 19 00 0D 00 0E  ................</span><br><span class="line">0090: 00 0F 00 10 00 11 00 02   00 12 00 04 00 05 00 14  ................</span><br><span class="line">00A0: 00 08 00 16 00 0B 00 02   01 00 00 0D 00 1A 00 18  ................</span><br><span class="line">00B0: 06 03 06 01 05 03 05 01   04 03 04 01 03 03 03 01  ................</span><br><span class="line">00C0: 02 03 02 01 02 02 01 01   00 00 00 0F 00 0D 00 00  ................</span><br><span class="line">00D0: 0A 70 6F 70 2E 71 71 2E   63 6F 6D                 .pop.qq.com</span><br><span class="line">javax.mail.MessagingException: Connect failed;</span><br><span class="line">  nested exception is:</span><br><span class="line">	javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure</span><br><span class="line">	at com.sun.mail.pop3.POP3Store.protocolConnect(POP3Store.java:209)</span><br><span class="line">	at javax.mail.Service.connect(Service.java:295)</span><br><span class="line">	at javax.mail.Service.connect(Service.java:176)</span><br><span class="line">	at cn.irenshi.biz.recruit.service.impl.RecruitReceiveMailServiceImpl.testConnect(RecruitReceiveMailServiceImpl.java:507)</span><br><span class="line">	at cn.irenshi.biz.recruit.service.impl.RecruitReceiveMailServiceImpl.testMailConnect(RecruitReceiveMailServiceImpl.java:534)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:497)</span><br><span class="line">	at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:302)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:190)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157)</span><br><span class="line">	at org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation(TransactionInterceptor.java:99)</span><br><span class="line">	at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:281)</span><br><span class="line">	at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:96)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)</span><br><span class="line">	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:207)</span><br><span class="line">	at com.sun.proxy.$Proxy1083.testMailConnect(Unknown Source)</span><br><span class="line">	at cn.irenshi.web.controller.recruit.RecruitReceiveMailController.testMailConnect(RecruitReceiveMailController.java:116)</span><br><span class="line">	at cn.irenshi.web.controller.recruit.RecruitReceiveMailController$$FastClassBySpringCGLIB$$4d626811.invoke(&lt;generated&gt;)</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:717)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157)</span><br><span class="line">	at org.springframework.security.access.intercept.aopalliance.MethodSecurityInterceptor.invoke(MethodSecurityInterceptor.java:68)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)</span><br><span class="line">	at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:92)</span><br><span class="line">	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)</span><br><span class="line">	at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:653)</span><br><span class="line">    at ...</span><br><span class="line">Caused by: javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure</span><br><span class="line">	at sun.security.ssl.Alerts.getSSLException(Alerts.java:192)</span><br><span class="line">	at sun.security.ssl.Alerts.getSSLException(Alerts.java:154)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.recvAlert(SSLSocketImpl.java:2023)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:1125)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:1375)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:1403)</span><br><span class="line">	at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:1387)</span><br><span class="line">	at com.sun.mail.util.SocketFetcher.configureSSLSocket(SocketFetcher.java:549)</span><br><span class="line">	at com.sun.mail.util.SocketFetcher.createSocket(SocketFetcher.java:354)</span><br><span class="line">	at com.sun.mail.util.SocketFetcher.getSocket(SocketFetcher.java:237)</span><br><span class="line">	at com.sun.mail.pop3.Protocol.&lt;init&gt;(Protocol.java:112)</span><br><span class="line">	at com.sun.mail.pop3.POP3Store.getPort(POP3Store.java:260)</span><br><span class="line">	at com.sun.mail.pop3.POP3Store.protocolConnect(POP3Store.java:205)</span><br><span class="line">	... 132 more</span><br><span class="line">[Raw read]: length &#x3D; 5</span><br><span class="line">0000: 15 03 03 00 02                                     .....</span><br><span class="line">[Raw read]: length &#x3D; 2</span><br><span class="line">0000: 02 28                                              .(</span><br><span class="line">http-nio-8080-exec-2, READ: TLSv1.2 Alert, length &#x3D; 2</span><br><span class="line">http-nio-8080-exec-2, RECV TLSv1.2 ALERT:  fatal, handshake_failure</span><br><span class="line">http-nio-8080-exec-2, called closeSocket()</span><br><span class="line">http-nio-8080-exec-2, handling exception: javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure</span><br></pre></td></tr></table></figure>
<p>注意到：</p>
<blockquote>
<p>Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]</p>
</blockquote>
<p>发现其中果然没有<code>RC4</code>相关的Cipher Suites。</p>
<p>在同事Windows机器上试了以下，输入果然不同，如下：</p>
<blockquote>
<p>Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]</p>
</blockquote>
<p>赫然发现：SSL_RSA_WITH_RC4_128_SHA。这正是我们想要的东西。</p>
<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>问题找到了，解决办法应该也比较容易找到。查看POP协议相关的<a target="_blank" rel="noopener" href="https://javamail.java.net/nonav/docs/api/com/sun/mail/pop3/package-summary.html">所有参数</a>，找到了<code>mail.pop3.ssl.ciphersuites</code>。在JavaMail的Properties中增加相关的<code>SSL_RSA_WITH_RC4_128_SHA</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.pop3s.ssl.ciphersuites&quot;</span>, <span class="string">&quot;SSL_RSA_WITH_RC4_128_SHA&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>重启服务器，测试，一气呵成，结果：<code>handshake_failure</code></p>
<h3 id="还是系统问题？"><a href="#还是系统问题？" class="headerlink" title="还是系统问题？"></a>还是系统问题？</h3><p>以<code>SSL_RSA_WITH_RC4_128_SHA</code>为关键字搜索，搜到了这篇文章：<a target="_blank" rel="noopener" href="https://support.blancco.com/index.php?/Knowledgebase/Article/View/497/117/java-8-update-60-disables-rc4-cipher-suites-causes-issues-with-blancco-erasure-software-and-mc-3-communication">Java 8 update 60 disables “RC4” cipher suites: Causes issues with Blancco erasure software and MC 3 communication</a>。这是别的软件遇到的问题，但原因是一样的。</p>
<p>原来从JDK 1.8.0_u60开始，默认禁止了RC4这个算法。可以在<code>&#123;JRE_HOME&#125;/lib/security/java.security</code>找到相关配置：</p>
<blockquote>
<p>534 jdk.tls.disabledAlgorithms=SSLv3, RC4, MD5withRSA, DH keySize &lt; 768</p>
</blockquote>
<p>以及</p>
<blockquote>
<p>586 jdk.tls.legacyAlgorithms= <br>587         K_NULL, C_NULL, M_NULL, <br>588         DHE_DSS_EXPORT, DHE_RSA_EXPORT, DH_anon_EXPORT, DH_DSS_EXPORT, <br>589         DH_RSA_EXPORT, RSA_EXPORT, <br>590         DH_anon, ECDH_anon, <br>591         RC4_128, RC4_40, DES_CBC, DES40_CBC</p>
</blockquote>
<p>那Windows中同样的JDK版本，为什么却可以正常使用呢？比较发现在Windows安装之后的Java目录中，有两个部分，一个是JDK目录（其中包含一个JRE目录），一个是直接的JRE目录。打开两个<code>java.security</code>文件，惊奇的发现两个文件并不相同，JRE目录中的<code>java.security</code>并不包含禁用RC4算法这些配置。</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><h4 id="启用Java的RC4算法"><a href="#启用Java的RC4算法" class="headerlink" title="启用Java的RC4算法"></a>启用Java的RC4算法</h4><p>没有去深研究为什么JDK会默认禁止这个算法，也不知道腾讯为什么会重新选择了一个JDK默认禁用的算法（7月29日之前是没有问题的）。但由于需要用到QQ邮箱，所以必须得开启这个算法。开启步骤如下：</p>
<ol>
<li>Go to the Java JRE installation folder: {JRE_HOME}\lib\security\</li>
<li>Locate java.security file.</li>
<li>Make a backup copy of the file.</li>
<li>Edit the java.security file with a text editor software (for example Notepad) according to the example further below.</li>
</ol>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">534c534</span><br><span class="line"><span class="deletion">- jdk.tls.disabledAlgorithms=SSLv3, RC4, MD5withRSA, DH keySize &lt; 768</span></span><br><span class="line"><span class="addition">+ jdk.tls.disabledAlgorithms=SSLv3, MD5withRSA, DH keySize &lt; 768</span></span><br><span class="line">591c591</span><br><span class="line"><span class="deletion">-         RC4_128, RC4_40, DES_CBC, DES40_CBC</span></span><br><span class="line"><span class="addition">+         DES_CBC, DES40_CBC</span></span><br></pre></td></tr></table></figure>

<h4 id="启用协议"><a href="#启用协议" class="headerlink" title="启用协议"></a>启用协议</h4><p>在POP/SMTP的协议中增加最新的TLSv1.2协议：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.pop3s.ssl.protocols&quot;</span>, <span class="string">&quot;TSLv1 TSLv1.1 TLSv1.2&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.smtps.ssl.protocols&quot;</span>, <span class="string">&quot;TSLv1 TSLv1.1 TLSv1.2&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="启用Cipher-Scites"><a href="#启用Cipher-Scites" class="headerlink" title="启用Cipher Scites"></a>启用Cipher Scites</h4><p>因为我需要兼容的不只是RC4这个算法，所以我启用了大部分的Cipher Suites</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.pop3s.ssl.ciphersuites&quot;</span>, <span class="string">&quot;TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA TLS_RSA_WITH_AES_128_CBC_SHA TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDH_RSA_WITH_AES_128_CBC_SHA TLS_DHE_RSA_WITH_AES_128_CBC_SHA TLS_DHE_DSS_WITH_AES_128_CBC_SHA TLS_ECDHE_ECDSA_WITH_RC4_128_SHA TLS_ECDHE_RSA_WITH_RC4_128_SHA SSL_RSA_WITH_RC4_128_SHA TLS_ECDH_ECDSA_WITH_RC4_128_SHA TLS_ECDH_RSA_WITH_RC4_128_SHA TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_RC4_128_MD5 TLS_EMPTY_RENEGOTIATION_INFO_SCSV&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.smtps.ssl.ciphersuites&quot;</span>, <span class="string">&quot;TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA TLS_RSA_WITH_AES_128_CBC_SHA TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDH_RSA_WITH_AES_128_CBC_SHA TLS_DHE_RSA_WITH_AES_128_CBC_SHA TLS_DHE_DSS_WITH_AES_128_CBC_SHA TLS_ECDHE_ECDSA_WITH_RC4_128_SHA TLS_ECDHE_RSA_WITH_RC4_128_SHA SSL_RSA_WITH_RC4_128_SHA TLS_ECDH_ECDSA_WITH_RC4_128_SHA TLS_ECDH_RSA_WITH_RC4_128_SHA TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_RC4_128_MD5 TLS_EMPTY_RENEGOTIATION_INFO_SCSV&quot;</span>);</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-07-30-use-rc4-in-tencent-mail/" data-id="cklf7tsvg008jz8t4fx9q5ha9" data-title="RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JDK/" rel="tag">JDK</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaMail/" rel="tag">JavaMail</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-09-weixin-sequence-generator" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-09-weixin-sequence-generator/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-09-weixin-sequence-generator/">万亿级调用系统：微信序列号生成器架构设计及演变</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p><strong>曾钦松</strong>，微信高级工程师，目前负责微信后台基础服务、朋友圈后台等开发优化，致力于高可用高性能后台系统的设计与研发。2011年毕业于西安电子科技大学，早先曾在腾讯搜搜从事检索架构、分布式数据库方面的工作。</p>
</blockquote>
<p>微信在立项之初，就已确立了利用数据版本号实现终端与后台的数据增量同步机制，确保发消息时消息可靠送达对方手机，避免了大量潜在的家庭纠纷。时至今日，微信已经走过第五个年头，这套同步机制仍然在消息收发、朋友圈通知、好友数据更新等需要数据同步的地方发挥着核心的作用。</p>
<p>而在这同步机制的背后，需要一个高可用、高可靠的序列号生成器来产生同步数据用的版本号。这个序列号生成器我们称之为seqsvr，目前已经发展为一个每天万亿级调用的重量级系统，其中每次申请序列号平时调用耗时1ms，99.9%的调用耗时小于3ms，服务部署于数百台4核CPU服务器上。<strong>本文会重点介绍seqsvr的架构核心思想，以及seqsvr随着业务量快速上涨所做的架构演变。</strong></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p><strong>微信服务器端为每一份需要与客户端同步的数据（例如消息）都会赋予一个唯一的、递增的序列号（后文称为sequence），作为这份数据的版本号。</strong>在客户端与服务器端同步的时候，客户端会带上已经同步下去数据的最大版本号，后台会根据客户端最大版本号与服务器端的最大版本号，计算出需要同步的增量数据，返回给客户端。这样不仅保证了客户端与服务器端的数据同步的可靠性，同时也大幅减少了同步时的冗余数据。</p>
<p>这里不用乐观锁机制来生成版本号，而是使用了一个独立的seqsvr来处理序列号操作，一方面因为业务有大量的sequence查询需求——查询已经分配出去的最后一个sequence，而基于seqsvr的查询操作可以做到非常轻量级，避免对存储层的大量IO查询操作；另一方面微信用户的不同种类的数据存在不同的Key-Value系统中，使用统一的序列号有助于避免重复开发，同时业务逻辑可以很方便地判断一个用户的各类数据是否有更新。</p>
<p>从seqsvr申请的、用作数据版本号的sequence，具有两种基本的性质：</p>
<ol>
<li>递增的64位整型变量</li>
<li>每个用户都有自己独立的64位sequence空间</li>
</ol>
<p>举个例子，小明当前申请的sequence为100，那么他下一次申请的sequence，可能为101，也可能是110，总之一定大于之前申请的100。而小红呢，她的sequence与小明的sequence是独立开的，假如她当前申请到的sequence为50，然后期间不管小明申请多少次sequence怎么折腾，都不会影响到她下一次申请到的值（很可能是51）。</p>
<p>这里用了每个用户独立的64位sequence的体系，而不是用一个全局的64位（或更高位）sequence，很大原因是全局唯一的sequence会有非常严重的申请互斥问题，不容易去实现一个高性能高可靠的架构。对微信业务来说，每个用户独立的64位sequence空间已经满足业务要求。</p>
<p><strong>目前sequence用在终端与后台的数据同步外，同时也广泛用于微信后台逻辑层的基础数据一致性cache中，大幅减少逻辑层对存储层的访问。</strong>虽然一个用于终端——后台数据同步，一个用于后台cache的一致性保证，场景大不相同。</p>
<p>但我们仔细分析就会发现，两个场景都是利用sequence可靠递增的性质来实现数据的一致性保证，这就要求我们的seqsvr保证分配出去的sequence是稳定递增的，一旦出现回退必然导致各种数据错乱、消息消失；另外，这两个场景都非常普遍，我们在使用微信的时候会不知不觉地对应到这两个场景：小明给小红发消息、小红拉黑小明、小明发一条失恋状态的朋友圈，一次简单的分手背后可能申请了无数次sequence。</p>
<p>微信目前拥有数亿的活跃用户，每时每刻都会有海量sequence申请，这对seqsvr的设计也是个极大的挑战。那么，既要sequence可靠递增，又要能顶住海量的访问，要如何设计seqsvr的架构？我们先从seqsvr的架构原型说起。</p>
<p>##架构原型</p>
<p>不考虑seqsvr的具体架构的话，它应该是一个巨大的64位数组，而我们每一个微信用户，都在这个大数组里独占一格8bytes的空间，这个格子就放着用户已经分配出去的最后一个sequence：cur_seq。每个用户来申请sequence的时候，只需要将用户的cur_seq+=1，保存回数组，并返回给用户。</p>
<p><img src="/upload/images/1.riff"><br>图1. 小明申请了一个sequence，返回101</p>
<h3 id="预分配中间层"><a href="#预分配中间层" class="headerlink" title="预分配中间层"></a>预分配中间层</h3><p><strong>任何一件看起来很简单的事，在海量的访问量下都会变得不简单。</strong>前文提到，seqsvr需要保证分配出去的sequence递增（数据可靠），还需要满足海量的访问量（每天接近万亿级别的访问）。满足数据可靠的话，我们很容易想到把数据持久化到硬盘，但是按照目前每秒千万级的访问量（~10^7 QPS），基本没有任何硬盘系统能扛住。</p>
<p>后台架构设计很多时候是一门关于权衡的哲学，针对不同的场景去考虑能不能降低某方面的要求，以换取其它方面的提升。仔细考虑我们的需求，我们只要求递增，并没有要求连续，也就是说出现一大段跳跃是允许的（例如分配出的sequence序列：1,2,3,10,100,101）。于是我们实现了一个简单优雅的策略：</p>
<ol>
<li>内存中储存最近一个分配出去的sequence：cur_seq，以及分配上限：max_seq</li>
<li>分配sequence时，将cur_seq++，同时与分配上限max_seq比较：如果cur_seq &gt; max_seq，将分配上限提升一个步长max_seq += step，并持久化max_seq</li>
<li>重启时，读出持久化的max_seq，赋值给cur_seq</li>
</ol>
<p><img src="/upload/images/2.riff"><br>图2. 小明、小红、小白都各自申请了一个sequence，但只有小白的max_seq增加了步长100</p>
<p>这样通过增加一个预分配sequence的中间层，在保证sequence不回退的前提下，大幅地提升了分配sequence的性能。实际应用中每次提升的步长为10000，那么持久化的硬盘IO次数从之前<del>10^7 QPS降低到</del>10^3 QPS，处于可接受范围。在正常运作时分配出去的sequence是顺序递增的，只有在机器重启后，第一次分配的sequence会产生一个比较大的跳跃，跳跃大小取决于步长大小。</p>
<h3 id="分号段共享存储"><a href="#分号段共享存储" class="headerlink" title="分号段共享存储"></a>分号段共享存储</h3><p>请求带来的硬盘IO问题解决了，可以支持服务平稳运行，但该模型还是存在一个问题：重启时要读取大量的max_seq数据加载到内存中。</p>
<p>我们可以简单计算下，以目前uid（用户唯一ID）上限2^32个、一个max_seq 8bytes的空间，数据大小一共为32GB，从硬盘加载需要不少时间。另一方面，出于数据可靠性的考虑，必然需要一个可靠存储系统来保存max_seq数据，重启时通过网络从该可靠存储系统加载数据。如果max_seq数据过大的话，会导致重启时在数据传输花费大量时间，造成一段时间不可服务。</p>
<p>为了解决这个问题，我们引入号段Section的概念，uid相邻的一段用户属于一个号段，而同个号段内的用户共享一个max_seq，这样大幅减少了max_seq数据的大小，同时也降低了IO次数。</p>
<p><img src="/upload/images/3.riff"><br>图3. 小明、小红、小白属于同个Section，他们共用一个max_seq。在每个人都申请一个sequence的时候，只有小白突破了max_seq上限，需要更新max_seq并持久化</p>
<p>目前seqsvr一个Section包含10万个uid，max_seq数据只有300+KB，为我们实现从可靠存储系统读取max_seq数据重启打下基础。</p>
<h3 id="工程实现"><a href="#工程实现" class="headerlink" title="工程实现"></a>工程实现</h3><p>工程实现在上面两个策略上做了一些调整，主要是出于数据可靠性及灾难隔离考虑</p>
<ol>
<li><p>把存储层和缓存中间层分成两个模块StoreSvr及AllocSvr。StoreSvr为存储层，利用了多机NRW策略来保证数据持久化后不丢失；AllocSvr则是缓存中间层，部署于多台机器，每台AllocSvr负责若干号段的sequence分配，分摊海量的sequence申请请求。</p>
</li>
<li><p>整个系统又按uid范围进行分Set，每个Set都是一个完整的、独立的StoreSvr+AllocSvr子系统。分Set设计目的是为了做灾难隔离，一个Set出现故障只会影响该Set内的用户，而不会影响到其它用户。</p>
</li>
</ol>
<p><img src="/upload/images/4.riff"><br>图4. 原型架构图</p>
<h3 id="容灾设计"><a href="#容灾设计" class="headerlink" title="容灾设计"></a>容灾设计</h3><p>接下来我们会介绍seqsvr的容灾架构。我们知道，后台系统绝大部分情况下并没有一种唯一的、完美的解决方案，同样的需求在不同的环境背景下甚至有可能演化出两种截然不同的架构。既然架构是多变的，那纯粹讲架构的意义并不是特别大，期间也会讲下seqsvr容灾设计时的一些思考和权衡，希望对大家有所帮助。</p>
<p>seqsvr的容灾模型在五年中进行过一次比较大的重构，提升了可用性、机器利用率等方面。其中不管是重构前还是重构后的架构，seqsvr一直遵循着两条架构设计原则：</p>
<ol>
<li>保持自身架构简单</li>
<li>避免对外部模块的强依赖</li>
</ol>
<p>这两点都是基于seqsvr可靠性考虑的，毕竟seqsvr是一个与整个微信服务端正常运行息息相关的模块。按照我们对这个世界的认识，系统的复杂度往往是跟可靠性成反比的，想得到一个可靠的系统一个关键点就是要把它做简单。相信大家身边都有一些这样的例子，设计方案里有很多高大上、复杂的东西，同时也总能看到他们在默默地填一些高大上的坑。当然简单的系统不意味着粗制滥造，我们要做的是理出最核心的点，然后在满足这些核心点的基础上，针对性地提出一个足够简单的解决方案。</p>
<p>那么，seqsvr最核心的点是什么呢？每个uid的sequence申请要递增不回退。这里我们发现，如果seqsvr满足这么一个约束：任意时刻任意uid有且仅有一台AllocSvr提供服务，就可以比较容易地实现sequence递增不回退的要求。</p>
<p><img src="/upload/images/5.riff"><br>图5. 两台AllocSvr服务同个uid造成sequence回退。Client读取到的sequence序列为101、201、102</p>
<p>但也由于这个约束，多台AllocSvr同时服务同一个号段的多主机模型在这里就不适用了。我们只能采用单点服务的模式，当某台AllocSvr发生服务不可用时，将该机服务的uid段切换到其它机器来实现容灾。这里需要引入一个仲裁服务，探测AllocSvr的服务状态，决定每个uid段由哪台AllocSvr加载。出于可靠性的考虑，仲裁模块并不直接操作AllocSvr，而是将加载配置写到StoreSvr持久化，然后AllocSvr定期访问StoreSvr读取最新的加载配置，决定自己的加载状态。</p>
<p><img src="/upload/images/6.riff"><br>图6. 号段迁移示意。通过更新加载配置把0~2号段从AllocSvrA迁移到AllocSvrB</p>
<p>同时，为了避免失联AllocSvr提供错误的服务，返回脏数据，AllocSvr需要跟StoreSvr保持租约。这个租约机制由以下两个条件组成：</p>
<ol>
<li><p>租约失效：AllocSvr N秒内无法从StoreSvr读取加载配置时，AllocSvr停止服务</p>
</li>
<li><p>租约生效：AllocSvr读取到新的加载配置后，立即卸载需要卸载的号段，需要加载的新号段等待N秒后提供服务</p>
</li>
</ol>
<p><img src="/upload/images/7.riff"><br>图7. 租约机制。AllocSvrB严格保证在AllocSvrA停止服务后提供服务</p>
<p>这两个条件保证了切换时，新AllocSvr肯定在旧AllocSvr下线后才开始提供服务。但这种租约机制也会造成切换的号段存在小段时间的不可服务，不过由于微信后台逻辑层存在重试机制及异步重试队列，小段时间的不可服务是用户无感知的，而且出现租约失效、切换是小概率事件，整体上是可以接受的。</p>
<p>到此讲了AllocSvr容灾切换的基本原理，接下来会介绍整个seqsvr架构容灾架构的演变</p>
<h2 id="容灾1-0架构：主备容灾"><a href="#容灾1-0架构：主备容灾" class="headerlink" title="容灾1.0架构：主备容灾"></a>容灾1.0架构：主备容灾</h2><p>最初版本的seqsvr采用了主机+冷备机容灾模式：全量的uid空间均匀分成N个Section，连续的若干个Section组成了一个Set，每个Set都有一主一备两台AllocSvr。正常情况下只有主机提供服务；在主机出故障时，仲裁服务切换主备，原来的主机下线变成备机，原备机变成主机后加载uid号段提供服务。</p>
<p><img src="/upload/images/8.riff"><br>图8. 容灾1.0架构：主备容灾</p>
<p>可能看到前文的叙述，有些同学已经想到这种容灾架构。一主机一备机的模型设计简单，并且具有不错的可用性——毕竟主备两台机器同时不可用的概率极低，相信很多后台系统也采用了类似的容灾策略。</p>
<h3 id="设计权衡"><a href="#设计权衡" class="headerlink" title="设计权衡"></a>设计权衡</h3><p>主备容灾存在一些明显的缺陷，比如备机闲置导致有一半的空闲机器；比如主备切换的时候，备机在瞬间要接受主机所有的请求，容易导致备机过载。既然一主一备容灾存在这样的问题，为什么一开始还要采用这种容灾模型？事实上，架构的选择往往跟当时的背景有关，seqsvr诞生于微信发展初期，也正是微信快速扩张的时候，选择一主一备容灾模型是出于以下的考虑：</p>
<ol>
<li>架构简单，可以快速开发</li>
<li>机器数少，机器冗余不是主要问题</li>
<li>Client端更新AllocSvr的路由状态很容易实现</li>
</ol>
<p>前两点好懂，人力、机器都不如时间宝贵。而第三点比较有意思，下面展开讲下</p>
<p>微信后台绝大部分模块使用了一个自研的RPC框架，seqsvr也不例外。在这个RPC框架里，调用端读取本地机器的client配置文件，决定去哪台服务端调用。这种模型对于无状态的服务端，是很好用的，也很方便实现容灾。我们可以在client配置文件里面写“对于号段x，可以去SvrA、SvrB、SvrC三台机器的任意一台访问”，实现三主机容灾。</p>
<p>但在seqsvr里，AllocSvr是预分配中间层，并不是无状态的。而前面我们提到，AllocSvr加载哪些uid号段，是由保存在StoreSvr的加载配置决定的。那么这时候就尴尬了，业务想要申请某个uid的sequence，Client端其实并不清楚具体去哪台AllocSvr访问，client配置文件只会跟它说“AllocSvrA、AllocSvrB…这堆机器的某一台会有你想要的sequence”。换句话讲，原来负责提供服务的AllocSvrA故障，仲裁服务决定由AllocSvrC来替代AllocSvrA提供服务，Client要如何获知这个路由信息的变更？</p>
<p>这时候假如我们的AllocSvr采用了主备容灾模型的话，事情就变得简单多了。我们可以在client配置文件里写：对于某个uid号段，要么是AllocSvrA加载，要么是AllocSvrB加载。Client端发起请求时，尽管Client端并不清楚AllocSvrA和AllocSvrB哪一台真正加载了目标uid号段，但是Client端可以先尝试给其中任意一台AllocSvr发请求，就算这次请求了错误的AllocSvr，那么就知道另外一台是正确的AllocSvr，再发起一次请求即可。</p>
<p>也就是说，对于主备容灾模型，最多也只会浪费一次的试探请求来确定AllocSvr的服务状态，额外消耗少，编码也简单。可是，如果Svr端采用了其它复杂的容灾策略，那么基于静态配置的框架就很难去确定Svr端的服务状态：Svr发生状态变更，Client端无法确定应该向哪台Svr发起请求。这也是为什么一开始选择了主备容灾的原因之一。</p>
<h3 id="主备容灾的缺陷"><a href="#主备容灾的缺陷" class="headerlink" title="主备容灾的缺陷"></a>主备容灾的缺陷</h3><p>在我们的实际运营中，容灾1.0架构存在两个重大的不足：</p>
<ol>
<li>扩容、缩容非常麻烦</li>
<li>一个Set的主备机都过载，无法使用其他Set的机器进行容灾</li>
</ol>
<p>在主备容灾中，Client和AllocSvr需要使用完全一致的配置文件。变更这个配置文件的时候，由于无法实现在同一时间更新给所有的Client和AllocSvr，因此需要非常复杂的人工操作来保证变更的正确性（包括需要使用iptables来做请求转发，具体的详情这里不做展开）。</p>
<p>对于第二个问题，常见的方法是用一致性Hash算法替代主备，一个Set有多台机器，过载机器的请求被分摊到多台机器，容灾效果会更好。在seqsvr中使用类似一致性Hash的容灾策略也是可行的，只要Client端与仲裁服务都使用完全一样的一致性Hash算法，这样Client端可以启发式地去尝试，直到找到正确的AllocSvr。</p>
<p>例如对于某个uid，仲裁服务会优先把它分配到AllocSvrA，如果AllocSvrA挂掉则分配到AllocSvrB，再不行分配到AllocSvrC。那么Client在访问AllocSvr时，按照AllocSvrA -&gt; AllocSvrB -&gt; AllocSvrC的顺序去访问，也能实现容灾的目的。但这种方法仍然没有克服前面主备容灾面临的配置文件变更的问题，运营起来也很麻烦。</p>
<h2 id="容灾2-0架构：嵌入式路由表容灾"><a href="#容灾2-0架构：嵌入式路由表容灾" class="headerlink" title="容灾2.0架构：嵌入式路由表容灾"></a>容灾2.0架构：嵌入式路由表容灾</h2><p>最后我们另辟蹊径，采用了一种不同的思路：既然Client端与AllocSvr存在路由状态不一致的问题，那么让AllocSvr把当前的路由状态传递给Client端，打破之前只能根据本地Client配置文件做路由决策的限制，从根本上解决这个问题。</p>
<p>所以在2.0架构中，我们把AllocSvr的路由状态嵌入到Client请求sequence的响应包中，在不带来额外的资源消耗的情况下，实现了Client端与AllocSvr之间的路由状态一致。具体实现方案如下：</p>
<p>seqsvr所有模块使用了统一的路由表，描述了uid号段到AllocSvr的全映射。这份路由表由仲裁服务根据AllocSvr的服务状态生成，写到StoreSvr中，由AllocSvr当作租约读出，最后在业务返回包里旁路给Client端。</p>
<p><img src="/upload/images/9.png"><br>图9. 容灾2.0架构：动态号段迁移容灾</p>
<p><strong>把路由表嵌入到请求响应包看似很简单的架构变动，却是整个seqsvr容灾架构的技术奇点。</strong>利用它解决了路由状态不一致的问题后，可以实现一些以前不容易实现的特性。例如灵活的容灾策略，让所有机器都互为备机，在机器故障时，把故障机上的号段均匀地迁移到其它可用的AllocSvr上；还可以根据AllocSvr的负载情况，进行负载均衡，有效缓解AllocSvr请求不均的问题，大幅提升机器使用率。</p>
<p>另外在运营上也得到了大幅简化。之前对机器进行运维操作有着繁杂的操作步骤，而新架构只需要更新路由即可轻松实现上线、下线、替换机器，不需要关心配置文件不一致的问题，避免了一些由于人工误操作引发的故障。</p>
<p><img src="/upload/images/10.riff"><br>图10. 机器故障号段迁移</p>
<h3 id="路由同步优化"><a href="#路由同步优化" class="headerlink" title="路由同步优化"></a>路由同步优化</h3><p>把路由表嵌入到取sequence的请求响应包中，那么会引入一个类似“先有鸡还是先有蛋”的哲学命题：没有路由表，怎么知道去哪台AllocSvr取路由表？另外，取sequence是一个超高频的请求，如何避免嵌入路由表带来的带宽消耗？</p>
<p>这里通过在Client端内存缓存路由表以及路由版本号来解决，请求步骤如下：</p>
<ol>
<li><p>Client根据本地共享内存缓存的路由表，选择对应的AllocSvr；如果路由表不存在，随机选择一台AllocSvr</p>
</li>
<li><p>对选中的AllocSvr发起请求，请求带上本地路由表的版本号</p>
</li>
<li><p>AllocSvr收到请求，除了处理sequence逻辑外，判断Client带上版本号是否最新，如果是旧版则在响应包中附上最新的路由表</p>
</li>
<li><p>Client收到响应包，除了处理sequence逻辑外，判断响应包是否带有新路由表。如果有，更新本地路由表，并决策是否返回第1步重试</p>
</li>
</ol>
<p>基于以上的请求步骤，在本地路由表失效的时候，使用少量的重试便可以拉到正确的路由，正常提供服务。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到此把seqsvr的架构设计和演变基本讲完了，正是如此简单优雅的模型，为微信的其它模块提供了一种简单可靠的一致性解决方案，支撑着微信五年来的高速发展，相信在可预见的未来仍然会发挥着重要的作用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-09-weixin-sequence-generator/" data-id="cklf7tsvj008lz8t44bu195w9" data-title="万亿级调用系统：微信序列号生成器架构设计及演变" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BA%8F%E5%8F%B7%E7%94%9F%E6%88%90%E5%99%A8/" rel="tag">序号生成器</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1/" rel="tag">微信</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2016-08-17-mycat-startup" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2016-08-17-mycat-startup/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2016-08-17-mycat-startup/">开始使用MyCAT</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>MyCAT是基于阿里巴巴开源数据库中间件Cobar开发并维护的数据库中间件，弥补了Cobar无人维护的尴尬境地。详细介绍可以参考官网：<a target="_blank" rel="noopener" href="http://mycat.io/">http://mycat.io/</a></p>
<p>相比Cobar来说，MyCAT的坑算是少很多了，下面是开始使用MyCAT的一些步骤。</p>
<h2 id="准备数据库"><a href="#准备数据库" class="headerlink" title="准备数据库"></a>准备数据库</h2><h3 id="创建MySQL数据库实例"><a href="#创建MySQL数据库实例" class="headerlink" title="创建MySQL数据库实例"></a>创建MySQL数据库实例</h3><p>用Docker启动，其他安装方式不再介绍。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql-001 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -d mysql:5.6 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>

<h3 id="修改MySQL服务器配置"><a href="#修改MySQL服务器配置" class="headerlink" title="修改MySQL服务器配置"></a>修改MySQL服务器配置</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line">skip-host-cache</span><br><span class="line">skip-name-resolve</span><br><span class="line"><span class="attr">user</span>            = mysql</span><br><span class="line"><span class="attr">pid-file</span>        = /var/run/mysqld/mysqld.pid</span><br><span class="line"><span class="attr">socket</span>          = /var/run/mysqld/mysqld.sock</span><br><span class="line"><span class="attr">port</span>            = <span class="number">3306</span></span><br><span class="line"><span class="attr">basedir</span>         = /usr</span><br><span class="line"><span class="attr">datadir</span>         = /var/lib/mysql</span><br><span class="line"><span class="attr">tmpdir</span>          = /tmp</span><br><span class="line"><span class="attr">lc-messages-dir</span> = /usr/share/mysql</span><br><span class="line">explicit_defaults_for_timestamp</span><br><span class="line"><span class="attr">lower-case-table-names</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">max_allowed_packet</span>=<span class="number">32</span>M</span><br></pre></td></tr></table></figure>
<p>其中<code>lower-case-table-names=1</code>和<code>max_allowed_packet=32M</code>为非默认参数：</p>
<ul>
<li><code>lower-case-table-names=1</code>忽略表格名字大小写，否则MyCAT会无法找到表格</li>
<li><code>max_allowed_packet=32M</code>该参数需要配合mysqldump，参考<a href="#%E4%BD%BF%E7%94%A8mysqldump%E5%AF%BC%E5%87%BA">使用<code>mysqldump</code>导出</a>。</li>
</ul>
<h2 id="准备MyCAT"><a href="#准备MyCAT" class="headerlink" title="准备MyCAT"></a>准备MyCAT</h2><h3 id="设置MyCAT虚拟schema"><a href="#设置MyCAT虚拟schema" class="headerlink" title="设置MyCAT虚拟schema"></a>设置MyCAT虚拟schema</h3><h4 id="定义虚拟schema：schema-xml"><a href="#定义虚拟schema：schema-xml" class="headerlink" title="定义虚拟schema：schema.xml"></a>定义虚拟schema：schema.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://org.opencloudb/&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;irenshi&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn001&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tab_sign_record_info&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn001,dn002,dn003&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-company-id&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;linahr&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn004&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tab_web_user&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn004,dn005&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-company-id-murmur&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn001&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;mysql-001&quot;</span> <span class="attr">database</span>=<span class="string">&quot;irenshi001&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn002&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;mysql-001&quot;</span> <span class="attr">database</span>=<span class="string">&quot;irenshi002&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn003&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;mysql-001&quot;</span> <span class="attr">database</span>=<span class="string">&quot;irenshi003&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;mysql-001&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user();<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;m001&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.1.4:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;root&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!--&lt;readHost host=&quot;s001&quot; url=&quot;192.168.1.4:3306&quot; user=&quot;root&quot; password=&quot;root&quot; /&gt;--&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong><code>&lt;schema&gt;</code>标签：</strong></p>
<ul>
<li><code>name=&quot;irenshi&quot;</code>定义的数据库名称为<code>irenshi</code></li>
<li><code>checkSQLschema=&quot;false&quot;</code>不对select语句中的schema名称做处理。该值置为<code>true</code>时，如果我们执行询句<code>select * from TESTDB.travelrecord;</code>则MyCat会把询句修改为<code>select * from travelrecord;</code>。即把表示schema字符去捧，避免发送到后端数据库执行时报：<em>（ERROR1146 (42S02): Table ‘testdb.travelrecord’ doesn’t exist）</em>。</li>
<li><code>sqlMaxLimit=&quot;10000&quot;</code>在selecct语句不指定<code>limit</code>的时候，最多返回10000条数据</li>
<li><code>dataNode=&quot;dn001&quot;</code>在不使用<code>&lt;table&gt;</code>指明的情况下，数据库表存放到<code>dn001</code>节点</li>
</ul>
<p><strong><code>&lt;table&gt;</code>标签：</strong><br><code>&lt;table&gt;</code>标签不指定的数据库表均以<code>&lt;schema&gt;</code>的设置为准，指定的话以指定的为准。</p>
<ul>
<li><code>name=&quot;tab_sign_record_info&quot;</code>指定要设置的数据库表</li>
<li><code>primaryKey=&quot;id&quot;</code>指定数据库表的主键。设置该值之后，如果MyCAT第一次执行主键查询时，会把请求发送到所有后端服务器，并且将主键所对应的数据库位置缓存，下次查询的时候直接根据该缓存向对应的数据库发送请求</li>
<li><code>dataNode=&quot;dn001,dn002,dn003&quot;</code>表明该表将被存放到<code>dn001,dn002,dn003</code>三个MySQL中</li>
<li><code>rule=&quot;sharding-by-company-id&quot;</code>给出表中的数据如何分布到上边给定的三个MySQL中</li>
</ul>
<p><strong><code>&lt;dataNode&gt;</code>标签：</strong><br><code>&lt;dataNode</code>标签定义MyCAT的数据节点。每个数据节点定位到某个MySQL主机的某个数据库schema上。</p>
<p><strong><code>&lt;dataHost&gt;</code>标签：</strong><br><code>&lt;dataHost&gt;</code>定义MySQL物理节点以及其连接方式。具体可以参考<a target="_blank" rel="noopener" href="http://mycat.io/document/Mycat_V1.6.0.pdf">《MyCAT权威指南》</a>。</p>
<h3 id="设置MyCAT读写分离"><a href="#设置MyCAT读写分离" class="headerlink" title="设置MyCAT读写分离"></a>设置MyCAT读写分离</h3><p>MyCAT的读写分离通过<code>schema.xml</code>中的<code>&lt;dataNode&gt;</code>标签来定义。其中一个<code>&lt;dataNode&gt;</code>可以对应一个或者多个<code>&lt;writeHost&gt;</code>，而一个<code>&lt;writeHost&gt;</code>又可以有零个或者多个<code>&lt;readHost&gt;</code>。<br>其中<code>&lt;writeHost&gt;</code>之间可以互为备份，取决于<code>balance=&quot;0&quot;</code>的设置；当一个<code>&lt;writeNode&gt;</code>挂掉的时候，它下边的所有<code>&lt;readHost&gt;</code>也不可访问。</p>
<p><strong><code>balance</code>参数可取的值：</strong></p>
<ul>
<li><code>balance=&quot;0&quot;</code>, 不开启读写分离机制，所有读操作都都发送到当前可用的<code>writeHost</code>上</li>
<li><code>balance=&quot;1&quot;</code>，全部<code>readHost</code>与<code>stand by writeHost</code>参与<code>select</code>语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且 M1 与 M2 互为主备)，正常情冴下，M2,S1,S2 都参与<code>select</code>语句的负载均衡</li>
<li><code>balance=&quot;2&quot;</code>，所有读操作都随机在<code>writeHost</code>、<code>readhost</code>上分发</li>
<li><code>balance=&quot;3&quot;</code>，所有读请求随机分发到<code>wiriterHost</code>对应的<code>readhost</code>执行，<code>writerHost</code>不负担读压力，注意<code>balance=3</code>只在1.4 及其以后版本有，1.3没有</li>
</ul>
<h3 id="设置MyCAT水平切分"><a href="#设置MyCAT水平切分" class="headerlink" title="设置MyCAT水平切分"></a>设置MyCAT水平切分</h3><h4 id="使用字符串前缀切分"><a href="#使用字符串前缀切分" class="headerlink" title="使用字符串前缀切分"></a>使用字符串前缀切分</h4><p><code>&lt;table&gt;</code>指定了数据库表<code>tab_sign_record_info</code>的水平切分方式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;irenshi&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn001&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tab_sign_record_info&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn001,dn002,dn003&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-company-id&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中的数据由<code>rule=&quot;sharding-by-company-id&quot;</code>指定的算法切分。</p>
<p>在<code>rule.xml</code>中我们可以看到<code>sharding-by-company-id</code>的定义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-company-id&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">columns</span>&gt;</span>companyId<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-pattern<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-pattern&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.opencloudb.route.function.PartitionByPrefixPattern&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patternValue&quot;</span>&gt;</span>64<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefixLength&quot;</span>&gt;</span>5<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-pattern.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于CompanyID使用了UUID，为字符串类型。所以使用<code>PartitionByPrefixPattern</code>来进行计算：</p>
<ul>
<li><code>prefixLength</code> 将CompanyId中的前5个字母以ASCII的方式求和</li>
<li><code>patternValue</code> 将求和之后数值MOD 64得出最终结果</li>
<li><code>mapFile</code> 将计算的最终结果按照<code>partition-pattern.txt</code>文件给定的分片规则进行分片</li>
</ul>
<p>其中partition-pattern.txt内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># range start-end ,data node index</span><br><span class="line"># ASCII</span><br><span class="line"># 8-57&#x3D;0-9 阿拉伯数字</span><br><span class="line"># 64、65-90&#x3D;@、A-Z</span><br><span class="line"># 97-122&#x3D;a-z</span><br><span class="line">###### first host configuration</span><br><span class="line">0-20&#x3D;0</span><br><span class="line">21-40&#x3D;1</span><br><span class="line">41-63&#x3D;2</span><br></pre></td></tr></table></figure>
<p>结合<code>dataNode=&quot;dn001,dn002,dn003&quot;</code>设置，结果为0-20的数据将分布在dn001中，21-40的数据将分布到dn002中，41-63的数据将分布到dn003中。</p>
<h4 id="使用一致性哈希切分"><a href="#使用一致性哈希切分" class="headerlink" title="使用一致性哈希切分"></a>使用一致性哈希切分</h4><p><code>&lt;table&gt;</code>标签的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;linahr&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn004&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tab_web_user&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn004,dn005&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-company-id-murmur&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同样查看rule.xml中<code>sharding-by-company-id-murmur</code>的定义：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-company-id-murmur&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">columns</span>&gt;</span>companyId<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;murmur&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.opencloudb.route.function.PartitionByMurmurHash&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;seed&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;virtualBucketTimes&quot;</span>&gt;</span>160<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;property name=&quot;weightMapFile&quot;&gt;weightMapFile&lt;/property&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>&lt;property name=&quot;seed&quot;&gt;0&lt;/property&gt;</code>指定了murmur算法的种子。一般不需要改，使用默认的0即可</li>
<li><code>&lt;property name=&quot;count&quot;&gt;2&lt;/property&gt;</code>表示物理节点的个数，对应实际dataNode的数量。如上配置中，dataNode为<code>dn004,dn005</code>，则此处值为2</li>
<li><code>&lt;property name=&quot;virtualBucketTimes&quot;&gt;160&lt;/property&gt;</code>指定一致性哈希中虚拟bucket的数量。默认为160，在这里节点数为2，那么虚拟bucket的数量为320个（假设下边介绍的weight值为默认值1）。若扩容把count的数量改为3，则虚拟bucket的数量变为480。</li>
<li><code>&lt;property name=&quot;weightMapFile&quot;&gt;weightMapFile&lt;/property&gt;</code>默认值为1。每个节点对应一个weight值，假设第i个节点的weight值为<code>weight[i]</code>，则第i个节点对应的虚拟bucket数量为<code>weight[i]*virtualBucketTimes</code>。所有虚拟节点的总数为<code>sum(weight[i]*virtualBucketTimes)</code>。</li>
</ul>
<p>当在机器中增加节点时，即增大count值时，对于每一条数据，则要么落到原有节点中、要么落到新节点中。<strong>但是如果增大<code>virtualBucketTimes</code>或者<code>weight</code>的值，则一致性哈希的这个性质不能被保证。</strong>所以对<code>virtualBucketTimes</code>和<code>weight</code>的修改一定要谨慎！</p>
<p>之前<code>murmur</code>的配置中还包含<code>bucketMapPath</code>参数，但在1.5的代码中该参数相关的代码已经被注释掉，不能使用了：<a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Server/commit/c9cb201992564c315436792572e96c3beaed3b37">https://github.com/MyCATApache/Mycat-Server/commit/c9cb201992564c315436792572e96c3beaed3b37</a></p>
<h2 id="导入数据I：使用mysqldump-source命令"><a href="#导入数据I：使用mysqldump-source命令" class="headerlink" title="导入数据I：使用mysqldump+source命令"></a>导入数据I：使用<code>mysqldump</code>+<code>source</code>命令</h2><h3 id="使用mysqldump导出"><a href="#使用mysqldump导出" class="headerlink" title="使用mysqldump导出"></a>使用<code>mysqldump</code>导出</h3><p>设置<code>mysqldump</code>的一些参数</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqldump]</span></span><br><span class="line">quick</span><br><span class="line">quote-names</span><br><span class="line"><span class="attr">max_allowed_packet</span>      = <span class="number">16</span>M</span><br><span class="line"><span class="attr">default-character-set</span>   = utf8mb4</span><br></pre></td></tr></table></figure>
<p>当然这些也可以在执行<code>mysqldump</code>命令的时候指定。</p>
<ul>
<li><code>max_allowed_packet</code>指定了最大允许的包大小。如果不指定则默认为24MB，导入的时候可能会报<code>ERROR 1153 (08S01) at line 1133809: Got a packet bigger than &#39;max_allowed_packet&#39; bytes</code>错误，因为MySQL允许的默认大小为1MB。</li>
<li><code>default-character-set</code>保证在导出数据库的时候使用<code>utf8mb4</code>编码。关于<code>utf8mb4</code>可以参考：<a target="_blank" rel="noopener" href="http://www.xiaotanzhu.com/2016/08/14/create-mysql-database-with-utf8mb4.html">创建支持emoji表情的MySQL数据库（utf8mb4）</a>。</li>
</ul>
<p>导出命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h192.168.1.3 -ulinahr -plinahr -c --skip-add-locks --skip-extended-insert --no-autocommit linahr &gt; irenshi-data.sql</span><br></pre></td></tr></table></figure>
<p>其中每个参数都几乎是必选项，<code>-h</code>, <code>-u</code>, <code>-p</code>三个参数不多说，下面介绍其他参数：</p>
<ul>
<li><code>-c</code>，全称为<code>--complete-insert</code>，告诉mysqldump导出的时候把列名一起导出。这在MyCAT中要求是必选的，因为MyCAT在执行插入的时候只能执行带列名的插入语句</li>
<li><code>--skip-add-locks</code> 默认情况下，mysqldump会在每个表前后分别增加<code>LOCK TABLES</code>和<code>UNLOCK TABLES</code>语句，但在MyCAT中使用<code>LOCK TABLES </code>和<code>UNLOCK TABLES</code>会造成潜在的死锁风险，所以尽量避免使用</li>
<li><code>--skip-extended-insert</code>默认情况下，mysqldump会把每个表格的所有数据写到同一个SQL中。但在分库分表情况下执行导入的时候，对于Boolean类型的数据并且值为<code>True</code>的数据，会报<a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Server/issues/1054">Data too long</a>错误。目前还不能确认是否是MyCAT的Bug。增加该参数，将每行数据输出为一个单独的insert语句，就不会出现类似错误了。</li>
<li><code>--no-autocommit</code>参数在每个表格所有的插入语句的前后分别增加<code>SET autocommit = 0</code>和<code>COMMIT</code>语句。相比没有这个参数，插入速度能差出至少200倍，分别是10000QPS和50QPS。</li>
</ul>
<p><strong>如果需要在mysqldump的时候忽略一些表格</strong>，可以使用<code>--ignore-table</code>参数。如果需要一次性忽略一批表格，可以使用这个脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">PASSWORD=linahr</span><br><span class="line">HOST=192.168.1.3</span><br><span class="line">USER=linahr</span><br><span class="line">DATABASE=linahr</span><br><span class="line">DB_FILE=linahr.sql</span><br><span class="line">EXCLUDED_TABLES=(</span><br><span class="line">                qrtz_blob_triggers</span><br><span class="line">                qrtz_calendars</span><br><span class="line">                qrtz_cron_triggers</span><br><span class="line">                qrtz_fired_triggers</span><br><span class="line">                qrtz_job_details</span><br><span class="line">                qrtz_locks</span><br><span class="line">                qrtz_paused_trigger_grps</span><br><span class="line">                qrtz_scheduler_state</span><br><span class="line">                qrtz_simple_triggers</span><br><span class="line">                qrtz_simprop_triggers</span><br><span class="line">                qrtz_triggers</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">IGNORED_TABLES_STRING=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> TABLE <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;EXCLUDED_TABLES@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span> :</span><br><span class="line">	IGNORED_TABLES_STRING+=<span class="string">&quot; --ignore-table=<span class="variable">$&#123;DATABASE&#125;</span>.<span class="variable">$&#123;TABLE&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#echo &quot;Dump structure&quot;</span></span><br><span class="line"><span class="comment">#mysqldump --host=$&#123;HOST&#125; --user=$&#123;USER&#125; --password=$&#123;PASSWORD&#125; --single-transaction --no-data $&#123;IGNORED_TABLES_STRING&#125; $&#123;DATABASE&#125; &gt; irenshi-tables.sql</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Dump content&quot;</span></span><br><span class="line">mysqldump --host=<span class="variable">$&#123;HOST&#125;</span> --user=<span class="variable">$&#123;USER&#125;</span> --password=<span class="variable">$&#123;PASSWORD&#125;</span> --opt -c --skip-add-locks --no-autocommit --skip-extended-insert <span class="variable">$&#123;DATABASE&#125;</span> <span class="variable">$&#123;IGNORED_TABLES_STRING&#125;</span> &gt; irenshi-data.sql</span><br></pre></td></tr></table></figure>

<h3 id="使用mysql命令导入"><a href="#使用mysql命令导入" class="headerlink" title="使用mysql命令导入"></a>使用<code>mysql</code>命令导入</h3><p>首先需要修改<code>[mysqld]</code>的<code>max_allowed_packet</code>参数。这个参数默认为1MB，但mysqldump导出的最大允许为16MB，会造成错误，见<a href="#%E4%BD%BF%E7%94%A8mysqldump%E5%AF%BC%E5%87%BA">使用<code>mysqldump</code>导出</a>章节</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">max_allowed_packet</span>=<span class="number">32</span>M</span><br></pre></td></tr></table></figure>

<p>开始导入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -ulinahr -plinahr -h192.168.1.4 -P8066 irenshi &lt; irenshi-data.sql</span><br></pre></td></tr></table></figure>
<p>或者也可以执行SQL命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source irenshi<span class="operator">-</span>data.sql</span><br></pre></td></tr></table></figure>

<h2 id="导入数据II：使用mysqldump-LOAD-DATA-INFILE命令"><a href="#导入数据II：使用mysqldump-LOAD-DATA-INFILE命令" class="headerlink" title="导入数据II：使用mysqldump+LOAD DATA INFILE命令"></a>导入数据II：使用<code>mysqldump</code>+<code>LOAD DATA INFILE</code>命令</h2><blockquote>
<p><strong>注意：</strong>以下内容适合导入单个表，如果需要批量导入大量表，可以参考：<a target="_blank" rel="noopener" href="http://www.xiaotanzhu.com/2016/08/24/import-data-into-mycat.html">http://www.xiaotanzhu.com/2016/08/24/import-data-into-mycat.html</a></p>
</blockquote>
<p>在某些数据库表比较大的情况下，使用以上方法导入的速度就比较难以接受了。MyCAT1.4以后还提供了类似MySQL的<code>LOAD DATA INFILE</code>命令，供导入大批量数据使用。据说这种方式比<code>insert</code>语句要快20倍。</p>
<h3 id="同样使用mysqldump导出"><a href="#同样使用mysqldump导出" class="headerlink" title="同样使用mysqldump导出"></a>同样使用<code>mysqldump</code>导出</h3><p>对于小表，使用上面的导入方式还是比较方便的。我们只针对大表使用<code>LOAD DATA INFILE</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h192.168.1.3 -uroot -proot --fields-optionally-enclosed-by=<span class="string">&#x27;&quot;&#x27;</span> --fields-terminated-by=<span class="string">&#x27;,&#x27;</span> --tab /tmp/irenshi/ --lines-terminated-by=<span class="string">&#x27;\n&#x27;</span> linahr tab_sign_record_info</span><br></pre></td></tr></table></figure>
<p>这个命令会将<code>irenshi</code>库中的<code>tab_sign_record_info</code>以文件形式导入到<code>/tmp/irenshi/</code>目录下。对于每一个导出的数据库表，将生成两个文件：tab_sign_record_info.sql和tab_sign_record_info.txt，其中tab_sign_record_info.sql存放了数据库表DDL，tab_sign_record_info.txt存放数据库表中的数据。</p>
<p><code>--fields-optionally-enclosed-by=&#39;&quot;&#39;</code>，<code>--fields-terminated-by=&#39;,&#39;</code>和<code>--lines-terminated-by=&#39;\n&#39;</code>分别指定了数据库文件的格式。这几个命令应和<code>LOAD DATA INFILE</code>给定的参数一致。</p>
<p><strong>执行此命令需要注意几点：</strong></p>
<ol>
<li><code>mysqldump</code>必须在MySQL服务器同一台主机上执行</li>
<li>必须拥有写文件权限</li>
<li>MySQL服务器必须对给定的目录<code>/tmp/irenshi/</code>有写权限</li>
</ol>
<h3 id="使用LOAD-DATA-INFILE导入数据"><a href="#使用LOAD-DATA-INFILE导入数据" class="headerlink" title="使用LOAD DATA INFILE导入数据"></a>使用<code>LOAD DATA INFILE</code>导入数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA <span class="keyword">local</span> INFILE <span class="string">&#x27;/tmp/irenshi/tab_sign_record_info.txt&#x27;</span></span><br><span class="line">IGNORE <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tab_sign_record_info <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="string">&#x27;utf8mb4&#x27;</span> FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span> OPTIONALLY ENCLOSED <span class="keyword">BY</span> <span class="string">&#x27;&quot;&#x27;</span> LINES TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\n&#x27;</span> (column1, column2, column3, ...)</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>local</code>表示从执行该命令的机器上获取文件。如果没有该参数，则从MySQL服务器上获取文件</li>
<li><code>IGNORE</code>指定了在服务器上如果已经存在了相同数据则忽略该行。还可以为<code>REPLACE</code>，表示替换已经存在的数据</li>
<li><code>CHARACTER SET &#39;utf8mb4&#39;</code>指定数据库表的编码集。这里需要和数据的编码保持一致，否则可能会出现乱码甚至执行失败</li>
<li><code>FIELDS TERMINATED BY &#39;,&#39; OPTIONALLY ENCLOSED BY &#39;&quot;&#39; LINES TERMINATED BY &#39;\n&#39;</code>和<code>mysqldump</code>中的参数对应</li>
<li><code>(column1, column2, column3, ...)</code>给定数据库的列。在MyCAT中必须要给定所有列，并且列的顺序要和建表时的顺序一致</li>
</ul>
<p><strong>使用<code>local</code>文件加载数据时，需指定<code>local-infile = 1</code>参数</strong>。如果不指定可能会报以下错误：<br>在MySQL上报以下错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1148 (42000): The used command is not allowed with this MySQL version</span><br></pre></td></tr></table></figure>
<p>而在MyCAT上则会报：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 2027 (HY000): Malformed packet</span><br></pre></td></tr></table></figure>
<p>这个错误着实让人莫名其妙。</p>
<p><strong>使用该参数的方法有三种：</strong></p>
<ul>
<li><p>直接在<code>mysql</code>命令中指定：</p>
<blockquote>
<p>mysql -h192.168.1.4 -ulinahr –local-infile=1 -plinahr -P 8066 irenshi</p>
</blockquote>
</li>
<li><p>在mysql客户端的配置文件中设置：</p>
<blockquote>
<p>[client]<br>local-infile = 1</p>
</blockquote>
</li>
<li><p>在mysql连接之后的session中执行SQL命令:</p>
<blockquote>
<p>SET local_infile=1;</p>
</blockquote>
</li>
</ul>
<h2 id="数据库扩容"><a href="#数据库扩容" class="headerlink" title="数据库扩容"></a>数据库扩容</h2><p><em>&lt;等用到的时候我再写吧&gt;</em></p>
<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><p>MyCAT官方提供了MyCAT-Eye作为监控软件。如图所示：<br><img src="/upload/images/11.png"></p>
<p>启动MyCAT-Eye需要指定ZooKeeper的服务路径，修改<code>$MYCAT_WEB_DIR/mycat-web/WEB-INF/classes/mycat.properties</code>：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- zookeeper=localhost:2181</span></span><br><span class="line"><span class="addition">+ zookeeper=192.168.1.2:2181</span></span><br></pre></td></tr></table></figure>

<p>然后进入MyCAT-Eye所在目录，执行<code>./start.sh</code>即可启动MyCAT-Eye。MyCAT-Eye默认服务路径为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8082&#x2F;mycat&#x2F;</span><br></pre></td></tr></table></figure>
<p>进入后可以对MyCAT和MySQL等进行配置。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2016-08-17-mycat-startup/" data-id="cklf7tsvn008mz8t4850i0ul8" data-title="开始使用MyCAT" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cobar/" rel="tag">Cobar</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MyCAT/" rel="tag">MyCAT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" rel="tag">分库分表</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" rel="tag">读写分离</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2018-05-19-introduction-to-microservices" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/21/2018-05-19-introduction-to-microservices/" class="article-date">
  <time class="dt-published" datetime="2021-02-21T13:57:19.813Z" itemprop="datePublished">2021-02-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Microservice/">Microservice</a>►<a class="article-category-link" href="/categories/Microservice/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/02/21/2018-05-19-introduction-to-microservices/">Introduction to Microservices</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li>TOC</li>
</ul>
<p>{:toc}</p>
<h2 id="Introduction-to-Microservices"><a href="#Introduction-to-Microservices" class="headerlink" title="Introduction to Microservices"></a>Introduction to Microservices</h2><p>Microservices are currently getting a lot of attention: articles, blogs, discussions on social media, and conference presentations. They are rapidly heading towards the peak of inflated expectations on the Gartner Hype cycle. At the same time, there are skeptics in the software community who dismiss microservices as nothing new. Naysayers claim that the idea is just a rebranding of SOA. However, despite both the hype and the skepticism, the Microservices Architecture pattern has significant benefits – especially when it comes to enabling the agile development and delivery of complex enterprise applications.</p>
<p>Let’s first look at why you should consider using microservices.</p>
<h3 id="Building-Monolithic-Applications"><a href="#Building-Monolithic-Applications" class="headerlink" title="Building Monolithic Applications"></a>Building Monolithic Applications</h3><p>Let’s imagine that you were starting to build a brand new taxi‑hailing application intended to compete with Uber and Hailo. After some preliminary meetings and requirements gathering, you would create a new project either manually or by using a generator that comes with Rails, Spring Boot, Play, or Maven. This new application would have a modular hexagonal architecture, like in the following diagram:</p>
<p><img src="/upload/images/25.png"></p>
<p>At the core of the application is the business logic, which is implemented by modules that define services, domain objects, and events. Surrounding the core are adapters that interface with the external world. Examples of adapters include database access components, messaging components that produce and consume messages, and web components that either expose APIs or implement a UI.</p>
<p>Despite having a logically modular architecture, the application is packaged and deployed as a monolith. The actual format depends on the application’s language and framework. For example, many Java applications are packaged as WAR files and deployed on application servers such as Tomcat or Jetty. Other Java applications are packaged as self‑contained executable JARs. Similarly, Rails and Node.js applications are packaged as a directory hierarchy.</p>
<p>Applications written in this style are extremely common. They are simple to develop since our IDEs and other tools are focused on building a single application. These kinds of applications are also simple to test. You can implement end‑to‑end testing by simply launching the application and testing the UI with Selenium. Monolithic applications are also simple to deploy. You just have to copy the packaged application to a server. You can also scale the application by running multiple copies behind a load balancer. In the early stages of the project it works well.</p>
<h3 id="Marching-Towards-Monolithic-Hell"><a href="#Marching-Towards-Monolithic-Hell" class="headerlink" title="Marching Towards Monolithic Hell"></a>Marching Towards Monolithic Hell</h3><p>Unfortunately, this simple approach has a huge limitation. Successful applications have a habit of growing over time and eventually becoming huge. During each sprint, your development team implements a few more stories, which, of course, means adding many lines of code. After a few years, your small, simple application will have grown into a monstrous monolith. To give an extreme example, I recently spoke to a developer who was writing a tool to analyze the dependencies between the thousands of JARs in their multi‑million line of code (LOC) application. I’m sure it took the concerted effort of a large number of developers over many years to create such a beast.</p>
<p>Once your application has become a large, complex monolith, <strong>your development organization is probably in a world of pain</strong>. Any attempts at agile development and delivery will flounder. One major problem is that the application is overwhelmingly complex. It’s simply too large for any single developer to fully understand. As a result, fixing bugs and implementing new features correctly becomes difficult and time consuming. What’s more, this tends to be a downwards spiral. If the codebase is difficult to understand, then changes won’t be made correctly. You will end up with a monstrous, incomprehensible big ball of mud.</p>
<p><strong>The sheer size of the application will also slow down development</strong>. The larger the application, the longer the start‑up time is. For example, in a recent survey some developers reported start‑up times as long as 12 minutes. I’ve also heard anecdotes of applications taking as long as 40 minutes to start up. If developers regularly have to restart the application server, then a large part of their day will be spent waiting around and their productivity will suffer.</p>
<p>Another problem with a large, complex monolithic application is that <strong>it is an obstacle to continuous deployment</strong>. Today, the state of the art for SaaS applications is to push changes into production many times a day. This is extremely difficult to do with a complex monolith since you must redeploy the entire application in order to update any one part of it. The lengthy start‑up times that I mentioned earlier won’t help either. Also, since the impact of a change is usually not very well understood, it is likely that you have to do extensive manual testing. Consequently, continuous deployment is next to impossible to do.</p>
<p><strong>Monolithic applications can also be difficult to scale when different modules have conflicting resource requirements</strong>. For example, one module might implement CPU‑intensive image processing logic and would ideally be deployed in Amazon EC2 Compute Optimized instances. Another module might be an in‑memory database and best suited for EC2 Memory‑optimized instances. However, because these modules are deployed together you have to compromise on the choice of hardware.</p>
<p><strong>Another problem with monolithic applications is reliability</strong>. Because all modules are running within the same process, a bug in any module, such as a memory leak, can potentially bring down the entire process. Moreover, since all instances of the application are identical, that bug will impact the availability of the entire application.</p>
<p>Last but not least, <strong>monolithic applications make it extremely difficult to adopt new frameworks and languages</strong>. For example, let’s imagine that you have 2 million lines of code written using the XYZ framework. It would be extremely expensive (in both time and cost) to rewrite the entire application to use the newer ABC framework, even if that framework was considerably better. As a result, there is a huge barrier to adopting new technologies. You are stuck with whatever technology choices you made at the start of the project.</p>
<p>To summarize: you have a successful business‑critical application that has grown into a monstrous monolith that very few, if any, developers understand. It is written using obsolete, unproductive technology that makes hiring talented developers difficult. The application is difficult to scale and is unreliable. As a result, agile development and delivery of applications is impossible.</p>
<p>So what can you do about it?</p>
<h3 id="Microservices-–-Tackling-the-Complexity"><a href="#Microservices-–-Tackling-the-Complexity" class="headerlink" title="Microservices – Tackling the Complexity"></a>Microservices – Tackling the Complexity</h3><p>Many organizations, such as Amazon, eBay, and Netflix, have solved this problem by adopting what is now known as the Microservices Architecture pattern. Instead of building a single monstrous, monolithic application, the idea is to <strong>split your application into set of smaller, interconnected services</strong>.</p>
<p>A service typically implements a set of distinct features or functionality, such as order management, customer management, etc. <strong>Each microservice is a mini‑application that has its own hexagonal architecture consisting of business logic along with various adapters</strong>. Some microservices would expose an API that’s consumed by other microservices or by the application’s clients. Other microservices might implement a web UI. At runtime, each instance is often a cloud VM or a Docker container.</p>
<p>For example, a possible decomposition of the system described earlier is shown in the following diagram:</p>
<p><img src="/upload/images/26.png"></p>
<p><strong>Each functional area of the application is now implemented by its own microservice</strong>. Moreover, the web application is split into a set of simpler web applications (such as one for passengers and one for drivers in our taxi‑hailing example). This makes it easier to deploy distinct experiences for specific users, devices, or specialized use cases.</p>
<p><strong>Each backend service exposes a REST API and most services consume APIs provided by other services</strong>. For example, Driver Management uses the Notification server to tell an available driver about a potential trip. The UI services invoke the other services in order to render web pages. Services might also use asynchronous, message‑based communication. Inter‑service communication will be covered in more detail later in this series.</p>
<p><strong>Some REST APIs are also exposed to the mobile apps used by the drivers and passengers</strong>. The apps don’t, however, have direct access to the backend services. Instead, communication is mediated by an intermediary known as an <strong>API Gateway</strong>. The API Gateway is responsible for tasks such as load balancing, caching, access control, API metering, and monitoring, and can be implemented effectively using NGINX. Later articles in the series will cover the API Gateway.</p>
<p><img src="/upload/images/27.png"></p>
<p>The Microservices Architecture pattern corresponds to the Y‑axis scaling of the Scale Cube, which is a 3D model of scalability from the excellent book <em>The Art of Scalability</em>. The other two scaling axes are X‑axis scaling, which consists of running multiple identical copies of the application behind a load balancer, and Z‑axis scaling (or data partitioning), where an attribute of the request (for example, the primary key of a row or identity of a customer) is used to route the request to a particular server.</p>
<p>Applications typically use the three types of scaling together. Y‑axis scaling decomposes the application into microservices as shown above in the first figure in this section. At runtime, X‑axis scaling runs multiple instances of each service behind a load balancer for throughput and availability. Some applications might also use Z‑axis scaling to partition the services. The following diagram shows how the Trip Management service might be deployed with Docker running on Amazon EC2.</p>
<p><img src="/upload/images/28.png"></p>
<p>At runtime, the Trip Management service consists of multiple service instances. Each service instance is a Docker container. In order to be highly available, the containers are running on multiple Cloud VMs. In front of the service instances is a load balancer such as NGINX that distributes requests across the instances. The load balancer might also handle other concerns such as caching, access control, API metering, and monitoring.</p>
<p>The Microservices Architecture pattern significantly impacts the relationship between the application and the database. Rather than sharing a single database schema with other services, <strong>each service has its own database schema</strong>. On the one hand, this approach is at odds with the idea of an enterprise‑wide data model. Also, it often results in duplication of some data. However, having a database schema per service is essential if you want to benefit from microservices, because it ensures loose coupling. The following diagram shows the database architecture for the example application.</p>
<p><img src="/upload/images/29.png"></p>
<p>Each of the services has its own database. Moreover, a service can use a type of database that is best suited to its needs, the so‑called polyglot persistence architecture. For example, Driver Management, which finds drivers close to a potential passenger, must use a database that supports efficient geo‑queries.</p>
<p>On the surface, the Microservices Architecture pattern is similar to SOA. With both approaches, the architecture consists of a set of services. However, one way to think about the Microservices Architecture pattern is that it’s SOA without the commercialization and perceived baggage of web service specifications (WS‑*) and an Enterprise Service Bus (ESB). Microservice‑based applications favor simpler, lightweight protocols such as REST, rather than WS‑*. They also very much avoid using ESBs and instead implement ESB‑like functionality in the microservices themselves. The Microservices Architecture pattern also rejects other parts of SOA, such as the concept of a canonical schema.</p>
<h3 id="The-Benefits-of-Microservices"><a href="#The-Benefits-of-Microservices" class="headerlink" title="The Benefits of Microservices"></a>The Benefits of Microservices</h3><p>The Microservices Architecture pattern has a number of important benefits. <strong>First, it tackles the problem of complexity</strong>. It decomposes what would otherwise be a monstrous monolithic application into a set of services. While the total amount of functionality is unchanged, the application has been broken up into manageable chunks or services. Each service has a well‑defined boundary in the form of an RPC‑ or message‑driven API. The Microservices Architecture pattern enforces a level of modularity that in practice is extremely difficult to achieve with a monolithic code base. Consequently, individual services are much faster to develop, and much easier to understand and maintain.</p>
<p><strong>Second, this architecture enables each service to be developed independently by a team that is focused on that service</strong>. The developers are free to choose whatever technologies make sense, provided that the service honors the API contract. Of course, most organizations would want to avoid complete anarchy and limit technology options. However, this freedom means that developers are no longer obligated to use the possibly obsolete technologies that existed at the start of a new project. When writing a new service, they have the option of using current technology. Moreover, since services are relatively small it becomes feasible to rewrite an old service using current technology.</p>
<p><strong>Third, the Microservices Architecture pattern enables each microservice to be deployed independently</strong>. Developers never need to coordinate the deployment of changes that are local to their service. These kinds of changes can be deployed as soon as they have been tested. The UI team can, for example, perform A/B testing and rapidly iterate on UI changes. The Microservices Architecture pattern makes continuous deployment possible.</p>
<p><strong>Finally, the Microservices Architecture pattern enables each service to be scaled independently</strong>. You can deploy just the number of instances of each service that satisfy its capacity and availability constraints. Moreover, you can use the hardware that best matches a service’s resource requirements. For example, you can deploy a CPU‑intensive image processing service on EC2 Compute Optimized instances and deploy an in‑memory database service on EC2 Memory‑optimized instances.</p>
<h3 id="The-Drawbacks-of-Microservices"><a href="#The-Drawbacks-of-Microservices" class="headerlink" title="The Drawbacks of Microservices"></a>The Drawbacks of Microservices</h3><p>As Fred Brooks wrote almost 30 years ago, there are no silver bullets. Like every other technology, the Microservices architecture has drawbacks. <strong>One drawback is the name itself. The term <em>microservice</em> places excessive emphasis on service size</strong>. In fact, there are some developers who advocate for building extremely fine‑grained 10–100 LOC services. While small services are preferable, it’s important to remember that they are a means to an end and not the primary goal. The goal of microservices is to sufficiently decompose the application in order to facilitate agile application development and deployment.</p>
<p><strong>Another major drawback of microservices is the complexity that arises from the fact that a microservices application is a distributed system</strong>. Developers need to choose and implement an inter‑process communication mechanism based on either messaging or RPC. Moreover, they must also write code to handle partial failure since the destination of a request might be slow or unavailable. While none of this is rocket science, it’s much more complex than in a monolithic application where modules invoke one another via language‑level method/procedure calls.</p>
<p><strong>Another challenge with microservices is the partitioned database architecture</strong>. Business transactions that update multiple business entities are fairly common. These kinds of transactions are trivial to implement in a monolithic application because there is a single database. In a microservices‑based application, however, you need to update multiple databases owned by different services. Using distributed transactions is usually not an option, and not only because of the CAP theorem. They simply are not supported by many of today’s highly scalable NoSQL databases and messaging brokers. You end up having to use an eventual consistency based approach, which is more challenging for developers.</p>
<p><strong>Testing a microservices application is also much more complex</strong>. For example, with a modern framework such as Spring Boot it is trivial to write a test class that starts up a monolithic web application and tests its REST API. In contrast, a similar test class for a service would need to launch that service and any services that it depends upon (or at least configure stubs for those services). Once again, this is not rocket science but it’s important to not underestimate the complexity of doing this.</p>
<p><strong>Another major challenge with the Microservices Architecture pattern is implementing changes that span multiple services</strong>. For example, let’s imagine that you are implementing a story that requires changes to services A, B, and C, where A depends upon B and B depends upon C. In a monolithic application you could simply change the corresponding modules, integrate the changes, and deploy them in one go. In contrast, in a Microservices Architecture pattern you need to carefully plan and coordinate the rollout of changes to each of the services. For example, you would need to update service C, followed by service B, and then finally service A. Fortunately, most changes typically impact only one service and multi‑service changes that require coordination are relatively rare.</p>
<p><strong>Deploying a microservices‑based application is also much more complex</strong>. A monolithic application is simply deployed on a set of identical servers behind a traditional load balancer. Each application instance is configured with the locations (host and ports) of infrastructure services such as the database and a message broker. In contrast, a microservice application typically consists of a large number of services. For example, Hailo has 160 different services and Netflix has over 600 according to Adrian Cockcroft <em>[Editor – Hailo has been acquired by MyTaxi.]</em>. Each service will have multiple runtime instances. That’s many more moving parts that need to be configured, deployed, scaled, and monitored. In addition, you will also need to implement a service discovery mechanism (discussed in a later post) that enables a service to discover the locations (hosts and ports) of any other services it needs to communicate with. Traditional trouble ticket‑based and manual approaches to operations cannot scale to this level of complexity. Consequently, successfully deploying a microservices application requires greater control of deployment methods by developers, and a high level of automation.</p>
<p>One approach to automation is to use an off‑the‑shelf PaaS such as Cloud Foundry. A PaaS provides developers with an easy way to deploy and manage their microservices. It insulates them from concerns such as procuring and configuring IT resources. At the same time, the systems and network professionals who configure the PaaS can ensure compliance with best practices and with company policies. Another way to automate the deployment of microservices is to develop what is essentially your own PaaS. One typical starting point is to use a clustering solution, such as Kubernetes, in conjunction with a technology such as Docker. Later in this series we will look at how software‑based application delivery approaches like NGINX, which easily handles caching, access control, API metering, and monitoring at the microservice level, can help solve this problem.</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Building complex applications is inherently difficult. A Monolithic architecture only makes sense for simple, lightweight applications. You will end up in a world of pain if you use it for complex applications. <strong>The Microservices architecture pattern is the better choice for complex, evolving applications despite the drawbacks and implementation challenges</strong>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/21/2018-05-19-introduction-to-microservices/" data-id="cklf7tsvo008oz8t4fb49ei3f" data-title="Introduction to Microservices" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Introduction-to-Microservices/" rel="tag">Introduction to Microservices</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Microservice/">Microservice</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Microservice/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E6%9C%8D%E5%8A%A1%E5%99%A8/">Web服务器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%8D%93/">安卓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-Service/" rel="tag">Android Service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bash/" rel="tag">Bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binlog/" rel="tag">Binlog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Browser-Caching/" rel="tag">Browser Caching</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPU/" rel="tag">CPU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cobar/" rel="tag">Cobar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECS/" rel="tag">ECS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Email/" rel="tag">Email</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Emoji/" rel="tag">Emoji</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GTID/" rel="tag">GTID</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Goaccess/" rel="tag">Goaccess</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gzip/" rel="tag">Gzip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hibernate/" rel="tag">Hibernate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Introduction-to-Microservices/" rel="tag">Introduction to Microservices</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/" rel="tag">JDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JUnit/" rel="tag">JUnit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Mail/" rel="tag">Java Mail</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaMail/" rel="tag">JavaMail</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jedis/" rel="tag">Jedis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Marathon/" rel="tag">Marathon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mesos/" rel="tag">Mesos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mockito/" rel="tag">Mockito</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Moint/" rel="tag">Moint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mongo/" rel="tag">Mongo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyCAT/" rel="tag">MyCAT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ORM/" rel="tag">ORM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/" rel="tag">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Performance/" rel="tag">Performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PowerMock/" rel="tag">PowerMock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SMTP/" rel="tag">SMTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Script/" rel="tag">Script</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/" rel="tag">Spring Cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Data-JPA/" rel="tag">Spring Data JPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Modules/" rel="tag">Spring Modules</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Telnet/" rel="tag">Telnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tuning/" rel="tag">Tuning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/USB/" rel="tag">USB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/" rel="tag">Vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Volumes/" rel="tag">Volumes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/" rel="tag">Zabbix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/" rel="tag">Zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apk/" rel="tag">apk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/emoji/" rel="tag">emoji</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/enca/" rel="tag">enca</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysqldump/" rel="tag">mysqldump</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swap/" rel="tag">swap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/utf8mb4/" rel="tag">utf8mb4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" rel="tag">主从复制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" rel="tag">分布式锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" rel="tag">分库分表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" rel="tag">单元测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%8D%93/" rel="tag">安卓</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%8F%E5%8F%B7%E7%94%9F%E6%88%90%E5%99%A8/" rel="tag">序号生成器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1/" rel="tag">微信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%B5%E5%AD%90%E4%B9%A6/" rel="tag">电子书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%91%E6%8E%A7/" rel="tag">监控</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AD%BE%E5%90%8D/" rel="tag">签名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" rel="tag">读写分离</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" rel="tag">阿里云</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Android-Service/" style="font-size: 10px;">Android Service</a> <a href="/tags/Bash/" style="font-size: 10px;">Bash</a> <a href="/tags/Binlog/" style="font-size: 10px;">Binlog</a> <a href="/tags/Browser-Caching/" style="font-size: 10px;">Browser Caching</a> <a href="/tags/CPU/" style="font-size: 10px;">CPU</a> <a href="/tags/Cobar/" style="font-size: 10px;">Cobar</a> <a href="/tags/Docker/" style="font-size: 11.67px;">Docker</a> <a href="/tags/ECS/" style="font-size: 10px;">ECS</a> <a href="/tags/Email/" style="font-size: 10px;">Email</a> <a href="/tags/Emoji/" style="font-size: 10px;">Emoji</a> <a href="/tags/GTID/" style="font-size: 11.67px;">GTID</a> <a href="/tags/Goaccess/" style="font-size: 10px;">Goaccess</a> <a href="/tags/Gzip/" style="font-size: 10px;">Gzip</a> <a href="/tags/Hibernate/" style="font-size: 10px;">Hibernate</a> <a href="/tags/Introduction-to-Microservices/" style="font-size: 10px;">Introduction to Microservices</a> <a href="/tags/JDK/" style="font-size: 11.67px;">JDK</a> <a href="/tags/JUnit/" style="font-size: 10px;">JUnit</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 11.67px;">Java</a> <a href="/tags/Java-Mail/" style="font-size: 10px;">Java Mail</a> <a href="/tags/JavaMail/" style="font-size: 10px;">JavaMail</a> <a href="/tags/Jedis/" style="font-size: 10px;">Jedis</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Marathon/" style="font-size: 10px;">Marathon</a> <a href="/tags/Mesos/" style="font-size: 10px;">Mesos</a> <a href="/tags/Mockito/" style="font-size: 10px;">Mockito</a> <a href="/tags/Moint/" style="font-size: 10px;">Moint</a> <a href="/tags/Mongo/" style="font-size: 10px;">Mongo</a> <a href="/tags/MyCAT/" style="font-size: 11.67px;">MyCAT</a> <a href="/tags/MySQL/" style="font-size: 20px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Nodejs/" style="font-size: 10px;">Nodejs</a> <a href="/tags/ORM/" style="font-size: 10px;">ORM</a> <a href="/tags/Oracle/" style="font-size: 10px;">Oracle</a> <a href="/tags/Performance/" style="font-size: 11.67px;">Performance</a> <a href="/tags/PowerMock/" style="font-size: 10px;">PowerMock</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/SMTP/" style="font-size: 10px;">SMTP</a> <a href="/tags/Script/" style="font-size: 10px;">Script</a> <a href="/tags/Shell/" style="font-size: 11.67px;">Shell</a> <a href="/tags/Spring/" style="font-size: 16.67px;">Spring</a> <a href="/tags/Spring-Cloud/" style="font-size: 11.67px;">Spring Cloud</a> <a href="/tags/Spring-Data-JPA/" style="font-size: 10px;">Spring Data JPA</a> <a href="/tags/Spring-Modules/" style="font-size: 10px;">Spring Modules</a> <a href="/tags/Telnet/" style="font-size: 10px;">Telnet</a> <a href="/tags/Tuning/" style="font-size: 10px;">Tuning</a> <a href="/tags/USB/" style="font-size: 10px;">USB</a> <a href="/tags/Ubuntu/" style="font-size: 11.67px;">Ubuntu</a> <a href="/tags/Vim/" style="font-size: 10px;">Vim</a> <a href="/tags/Volumes/" style="font-size: 10px;">Volumes</a> <a href="/tags/Zabbix/" style="font-size: 11.67px;">Zabbix</a> <a href="/tags/Zookeeper/" style="font-size: 10px;">Zookeeper</a> <a href="/tags/apk/" style="font-size: 10px;">apk</a> <a href="/tags/emoji/" style="font-size: 10px;">emoji</a> <a href="/tags/enca/" style="font-size: 10px;">enca</a> <a href="/tags/mysqldump/" style="font-size: 11.67px;">mysqldump</a> <a href="/tags/swap/" style="font-size: 10px;">swap</a> <a href="/tags/utf8mb4/" style="font-size: 11.67px;">utf8mb4</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 10px;">中间件</a> <a href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" style="font-size: 10px;">主从复制</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 10px;">分布式锁</a> <a href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" style="font-size: 10px;">分库分表</a> <a href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">单元测试</a> <a href="/tags/%E5%AE%89%E5%8D%93/" style="font-size: 13.33px;">安卓</a> <a href="/tags/%E5%BA%8F%E5%8F%B7%E7%94%9F%E6%88%90%E5%99%A8/" style="font-size: 10px;">序号生成器</a> <a href="/tags/%E5%BE%AE%E4%BF%A1/" style="font-size: 10px;">微信</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 11.67px;">微服务</a> <a href="/tags/%E7%94%B5%E5%AD%90%E4%B9%A6/" style="font-size: 10px;">电子书</a> <a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 15px;">监控</a> <a href="/tags/%E7%AD%BE%E5%90%8D/" style="font-size: 10px;">签名</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 11.67px;">编码</a> <a href="/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/" style="font-size: 10px;">读写分离</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 18.33px;">转载</a> <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91/" style="font-size: 10px;">阿里云</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/02/21/2016-08-24-import-data-into-mycat/">将现有数据库的数据导入MyCAT</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-06-15-login-smtp-with-telnet/">利用telnet进行SMTP的验证</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-06-27-monitor-mysql-with-zabbix/">使用Zabbix监控MySQL服务器</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-07-19-mongo-queries/">Mongo常用命令</a>
          </li>
        
          <li>
            <a href="/2021/02/21/2016-07-19-vim-commands/">Vim常用命令</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>