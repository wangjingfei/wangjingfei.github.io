---
layout: post
title: 通过Merlin版AC88U路由器看IPTV
date: 2021-07-02
tags: ["旅行", "自驾", "新疆"]
categories: 旅行
description: 新疆自驾游地图：完整高清版
---

参考：
http://www.360doc.com/content/18/0721/21/56810834_772226545.shtml

dhcp-option-force=125,00:00:00:00:1d:02:06:48:47:57:2d:43:54:03:07:48:47:32:32:30:47:53:0a:02:20:00:0b:02:00:55:0d:02:00:2e

```bash
#!/bin/sh
CONFIG=$1
source /usr/sbin/helper.sh

# 通过 pc_append把dhcp相关的设置append到 /tmp/etc/dnsmasq.conf 文件里
# 这样IPTV就能获取到VLAN的IP了
pc_append "dhcp-option-force=125,00:00:00:00:1d:02:06:48:47:57:2d:43:54:03:07:48:47:32:32:30:47:53:0a:02:20:00:0b:02:00:55:0d:02:00:2e" /tmp/etc/dnsmasq.conf
```
robocfg vlan 51 ports "0t 1t 2t 3t 4t 8t" vlan 85 ports "0t 1t 2t 3t 4t 8t"

[教程] 上海电信完美解决4K IPTV一劳永逸增强板
  [复制链接]
yangyoung007
2

主题
277

帖子
408

积分
中级魔法师


精华
0
门户文章
0
魔力币
354
魔法值
0
注册时间
2016-4-6
发消息
 发表于 2016-4-27 13:48:02 | 显示全部楼层 |阅读模式
本帖最后由 yangyoung007 于 2019-3-28 13:53 编辑

由于之前方法是零时添加dnsmasq的方法，所以一旦启用S*S或者执行相关S*S操作后都会失效包括之前有帖子在s*s目录添加dnsmasq的一键脚本，只要是修改s*s账户或者s*s服务重置的时候，都会重写dnsmasq造成失效只要让路由再次重启才行，现在完美解决了。此方法不区分koolshare改版固件是7.0或者以下还是7.1或者以上的版本，都可以通用  
前人栽树后人乘凉再次由衷感谢4楼中所提到的帖子所给的启发。----------20170104修正。。
但是前人挖坑后人遭殃，偶然件发现了新问题重新抓包测试，并翻阅了相关文献进行修复。------20170106补
增加原生ASUS固件的修改方法。。。。。改版有$$、无$$三种版本都全了，，原生安装$$的按照改版$$完成就行了。------20170123.。

切记请不要在iptv和路由之间添加设备，，如已经添加设备的请先去掉，待iptv能正常使用后在添加，方便判断问题在哪里，
 如遇图中情况，请先检查自己的网络，没有公网地址的是不可能有电信专网地址的，本贴是转门解决专网问题的。。一般没公网是iptv盒子获取不到ip造成的
请以文字描述的为主图片只是参考大概操作，请把帖子看完在错误
超级小白操作法见四楼结尾处！！！！！！！！！！只要二步




最新申请了上海电信50m2年宽带套餐送了4k机顶盒一枚，但是由于之前那个电信小工比较2b，把我iptv退了，后来又重新申请，结果就变成了一个非主流的4k盒子不是上面常用的烽火和中兴的，而是兆能z82.连万能的淘宝都找不到的上古神器。光猫是现在号称配置最强的悦me系列不过是贝尔的，此帖就此开始了。
原料：兆能z82 4k iptv     一台
         上海贝尔E-140W-P 一台
         华硕ac66u             一台
         乐视x43s               一台（有情客串）

软件工具准备

securecrt可以用putty或者xshell等等


看了论坛里的资料有点晕，所以准备整理简化下给需要的小白使用，续待。。。。由于平时不在家更新较慢。欢迎拍砖指教。

由于intel网卡不能直接抓取vlan包，所以进行修改
进入注册表进入如下目录
HKEY_LOCAL_MACHINE\SYSTEM\ControlSet0001\Control\Class\{4D36E972-E325-11CE-BFC1-08002bE10318}
然后从0000开始000x，这里是0007网卡比较多窗口右边寻找一个DriverDesc的键，值得内容为Intel(R) XXXXXXXX
然后再这个目录里新建一个DWORD，名字叫MonitorMode，数值为1，然后重启就能进行抓包了

抓包开始，
在命令提示符里输入ipconfig /release  ipconfig /renew
释放ip，获取ip

如图我们抓到了dhcp的offer包，从路由发完客户端的包，里面有个option 125 这个就是关键


点一下125，出现125的所有内容                                          


可以看到上图这个字段是对应光猫的型号可以去除

option 60得内容

如果实在不会的提供一个简单方法下载dhcptest ，打开相应的应用有32位和64位那个版本，
按下d会自动抓包显示。




--------------------------------------------------以上是抓包教程----------------------------------------------------
以下是光猫设置


连接模式只留下internet和other，把tr069删除，然后按照图设置，设置成bridge模式。服务模式改成按图，切记不要选有tr069的，否则就删掉重来，
在绑定端口哪里，把勾都取消，然后在数据绑定的地方所有端口的vlan1都绑上85.这样不管你路由插那个口都可以用了，然后保存

在说一遍是数据绑定不是端口绑定看清楚，端口绑定是不能绑定四个口的，我们这里不需要端口绑定的，统统取消只要数据绑定，仔细看图后在回帖问，谢谢

由于取消了端口绑定老的iptv也应该可以直接使用了，如果不能使用可能需要脱去不是iptv的tag包，脱去会变成只能给iptv用的口，就和之前的itv口一样（未经测试，欢迎测试后告诉我）


iptv业务和dhcp默认就是这样的不用修改如果不是请按图设置，至于为什么要打开光猫的dhcp，是为以后维护方便

在路由的外部网络(WAN)里面打开启用 V*P*N + DHCP 连接，这样路由就可以收到来自光猫的dhcp，变成192.168.1.2.而光猫的地址
是192.168.1.1.以后不用在插拔网线了，直接在电脑打192.168.1.1就能进入光猫调试。记得在内部网络(LAN)---》内网地址设置的
ip地址改成非192.168.1.1地址否则会和光猫地址冲突，如果非要192.168.1.1的网段，请把光猫改成其他网段。这里不
在介绍了。如果把光猫改成192.168.1.2-254，虽然是可以用的，但是不推荐，因为有2个dhcp的服务器，容易造成dhcp错误。
（新版ASUS固件380.还需要打开Spoof LAN TTL value才可以访问光猫，没有这个选项的就不用选了）

==============补充修复=================================

以上是光猫抓得只有8个option包

以上是路由抓得只有12个option包
经过对比，路由比光猫少option 60.。（经过测试有些iptv需要这个有些不需要），但通过查找option得文献得知，60和125都是
给设备做认证用得，主流都是用option 43和60、125一般都不用了
路由比光猫多了option 58 59 15 28 这四个，通过查找option得文献得知
15是路由器域名、28是网段广播地址、58、59是在dhcp到期前提前续租可以增加租约而不改ip（这个其实是一个很好得功能）。
一般只有中兴和烽火会用到15、28其中的一个华为会用到60，其他盒子都125
所以对dhcp包进行二次在修改。一个是实用型，一个是光猫型






dhcptest.rar

434.82 KB, 下载次数: 3241

dhcp工具

4k-start简.pdf

71 Bytes, 下载次数: 1594

4k-start全.pdf

109 Bytes, 下载次数: 2311

dns光猫.pdf

246 Bytes, 下载次数: 2375

dns实用.pdf

202 Bytes, 下载次数: 1400

wan-start.pdf

206 Bytes, 下载次数: 1748

评分
4
查看全部评分


deljp


kaipublue


zykcnro


admin

回复
举报

yangyoung007
2

主题
277

帖子
408

积分
中级魔法师


精华
0
门户文章
0
魔力币
354
魔法值
0
注册时间
2016-4-6
发消息
  楼主| 发表于 2016-4-27 13:48:15 | 显示全部楼层
本帖最后由 yangyoung007 于 2019-3-28 13:51 编辑

我们使用putty登陆路由器
然后收入命令robocfg show

可以看到默认的情况是 有vlan1 和vlan2 接口是0 、1、2、3、4、8，其中0是wan口 1到4是lan口 8是cpu口
当然有些路由刷了ASUS固件后端口号都乱了我们怎么办呢（主要出现在非华硕路由身上），别急。看到图片左边的 off mac：xx：xx：xx吗
这里显示的就是对应端口插入设备的mac地址，比如0号口显示的mac是光猫的地址，然后光猫正好插在wan口，那么0就是wan口
如果没有插入的口就是显示00：00：00，同理我们也能找到相应的lan口，比如2口插的是iptv，出现的是iptv的mac地址，那么lan2口就是2号。这样你想用口看下有地址的就有对应关系了。这里可能会问8是什么，8就是cpu端口，只要mac地址显示的是路由背后的mac地址的就是cpu端口，需要cpu参与的必须填入8，
iptv这种可以硬件直接转发的不用填8
以下是要修改的脚本
4k-start 内容
#!/bin/sh
robocfg vlan 51 ports "0t 1t 2t 3t 4t 5t 6t 7t" vlan 85 ports "0t 1t 2t 3t 4t 5t 6t 7t"
dns 内容
dhcp-option-force=lan,125,00:00:00:00:10:02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55
dhcp-option=lan,60,00:00:01:00:02:03:43:50:45:03:0e:45:38:20:47:50:4f:4e:20:52:4f:55:54:45:52:04:03:31:2E:30
dhcp-option=lan,15
dhcp-option=lan,28



以上脚本已经生成文件上传了，名字叫4k-start简.pdf、4k-start全.pdf、dns实用.pdf、dns光猫.pdf，自己把.pdf删除使用winscp上传到相应目录下就行了，
以下内容是重点请仔细阅读
4k-start简.pdf、4k-start全.pdf这2个文件2选1就行了，这个脚本是在开机的时候划分相应vlan用的，区别就是“4k-start全”所有lan口都可以用iptv，支持8口路由，“4k-start简”只有lan口4可以用iptv，如果有其他需求自己修改。把这个文件改名为4k-star上传到/jffs/scripts下权限设置成0755

dns实用.pdf、dns光猫.pdf这2个文件也是2选1就行了，这个文件就是添加iptv需要的验证信息用的，区别就是“dns实用.pdf”只有二条信息多数设备用这个就行了，“dns光猫.pdf”有四条信息，完美全模拟光猫状态，可以实用任何盒子。把这个文件改名为dns.conf上传到/jffs/configs/dnsmasq.d下权限设置成0644或者0755（其实只要只读就行了）修改方法在往下看。对于没有dnsmasq.d这个文件的用户请直接看下面的原生ASUS固件部分
dns实用.pdf不行的可以试试看dns光猫.pdf这个


登陆的时候一定要选scp协议否则会登陆不上的


修改内容的时候直接在winscp双击打开文件修改就行了


修改文件权限最傻瓜的方法，用winscp登录你的路由器，找到你要修改权限的文件，右键---属性，然后看上图
接下来：权限那里按照图样打√，或者“八进制表示”那里直接填写0755，√会自动打上，然后确定。
然后看看图的右上角，权限是不是rwxr-xr-x，是就OK了
其中红色圈哪里是选择目录的，先选root，然后就能看到jffs了在点进去，绿色是路径位置的，
使用教程不正常的请先看下自己的vlan有几个只要保留vlan1和vlan2就行了多余的要删除。。放好dns后请先抓包，如果只能抓到53的包，请先重新刷一次固件和格式化jjfs分区。删除vlan的名字是robocfg vlans reset 后面根要使用的vlan和端口如
robocfg vlans reset vlan 1 ports “1 2 3 4 8t” vlan 2 ports "0 8u"
自己路由是什么就照抄就行了。。这个都不会的话直接到四楼尾部点传送门到一键脚本设置iptv的帖子去吧。

最后几部步见证奇迹的时刻

开机自动启动划分vlan，点击tools--》Script--》类型选择wan-start、脚本配置/jffs/scripts/4k-start。然后点加号添加到下方，然后重启
就能观看4k的iptv了。而且不会受到s*s的影响不管你怎么折腾s*s，之前的办法是零时生效的，只要s*s一刷新就会失效
对于没有tools--》Script。。。请直接看下面的原生ASUS固件部分

原生ASUS固件
原生ASUS固件的设备在tools里面会没有Script。可以有以下二中方法

1、要进入/jffs/scripts/ 里面没有任何文件的，直接放入4k-start文件设置成0755，并把文件名字修改成wan-start就会自己会开机后自动加载（最新版380ASUS固件，需要把名字改成services-start，才会生效），（没有安装过s*s都会是空白目录，如果
之前安装过s*s的不成功请使用2号方案）

2、要进入/jffs/scripts/里面有wan-start文件的,打开里面的wan-start文件，在文件的最后添加4k-start里的命令
robocfg vlan 51 ports "0t 4t" vlan 85 ports "0t 4t" 或者 robocfg vlan 51 ports "0t 1t 2t 3t 4t 5t 6t 7t" vlan 85 ports "0t 1t 2t 3t 4t 5t 6t 7t"
直接保存，然后重启路由器。

原生ASUS固件的设备会没有/jffs/configs/dnsmasq.d这个地方，解决方法如下

1、要进入/jffs/configs/里面没有任何文件的，直接放入dns文件设置成0644或者0755，并把文件名字修改成dnsmasq.conf.add



有些设备可能因为增加了额外的dhcp-option会出现网页需要刷新2次才能出现的问题（本身网站也有点问题不是每个网站都会），现在有解决办法，
点击 内部网络(LAN)--》DHCP服务器--》Hide DHCP/RA queries选择改成是 、租约时间修改的短一点定时刷新。


检测是否成功的方法
命令1：robocfg show 检查iptv需要的vlan85 和vlan51 是否在vlan2下面有，然后里面的端口是否对应，主要是vlan1和vlan2里的端口，2个vlan重复的端口
不需要填入，这样你所有端口都可以使用，或者你就指定需要看iptv的端口，
命令2：service restart_dnsmasq 这条命令是重新刷新dhcp的。可以不重启就能监测，你放的dns是否正确，命令输入后，直接运行帖子提供的dhcptest工具进行检测，，这个工具更具你系统是32还是64位进行相应选择。打开后按d抓包检测，如果只有一个53的话，说明你的文件有问题，也不用重启了，省得重启进不去路由要强制复位。。直到能抓到60和125的包为止，就ok了，
有人发现还是不成啊，这个时候可以进行iptv自检，然后看相关错误的提示，一个是端口错误一个是验证错误，iptv的错误代码，0094就是端口命令1里面的错误，。。0095就是验证命令2里面的错误，定位错误后，仔细查看里面的内容，比如端口不含iptv插的端口，option里面的字符错误，，如果还是没找到错误的可以联系我，我也不是一直有空，基本都是工作日有空，或者你就等我那一天晚上有空时间不定，最好还是自己搞，需要搞的留下自己qq。。因回复的人较多难免会有遗留。如果遗留了请再次回帖。。。。。20170120 完结


至此就可以进行完美iptv使用体验了，最后一点，请在系统管理中的系统里，把Format JFFS partition at next boot改成否，如果为是的话下次重启后就白弄了，要重新在做一次。Enable JFFS custom scripts and configs一定要为是，否则脚本无法生效














回复 支持 4 反对 0
举报

yangyoung007
2

主题
277

帖子
408

积分
中级魔法师


精华
0
门户文章
0
魔力币
354
魔法值
0
注册时间
2016-4-6
发消息
  楼主| 发表于 2016-4-27 13:48:33 | 显示全部楼层
本帖最后由 yangyoung007 于 2017-1-17 21:46 编辑

dhcp-option=60,00:00:01:00:02:03:43:50:45:03:0e:45:38:20:47:50:4f:4e:20:52:4f:55:54:45:52:04:03:31:2E:30
option解释：CPE  E8 GPON ROUTER 1.0  （客户终端设备e8 gpon 路由 1.0）

dhcp-option-force=125,00:00:00:00:14:02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55:0d:02:00:2e
option解释：
125=dhcp-option 125
00:00:00:00 （enterprise number）Enterprise ID 需要替换成OTT盒子的ID这个步骤iptv盒子自动完成。
14 '{data-len1}' （20bytes option－data）
02:06:48:47:57:2d:43:54 (subcode-2 0x4847572d4354=HGW-CT)
0a:02:20:00  (subcode-10 0x2000 untag)
0b:02:00:55  (subcode-11 0x0055=85 iptv vlanid)
0d:02:00:2e  (subcode-13 0x002e=46 voice vlanid)
通用（实测然并卵。。所以不用了）
dhcp-option-force=vi-encap:0,2,"HGW-CT"
以下是各设备抓包情况

中兴F420：
dhcp-option-force=
125,00:00:00:00:1a:02:06:48:47:57:2d:43:54:03:04:5a:58:48:4e:0a:02:20:00:0b:02:00:55:0d:02:00:2e

中兴F450G：
dhcp-option-force=
125,00:00:00:00:16:02:06:48:47:57:2d:43:54:03:04:5a:58:48:4e:0b:02:00:55:0a:02:20:00

贝尔RG2010-CA：
dhcp-option-force=
125,00:00:00:00:14:02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55:0d:02:00:2e

中兴F460：
dhcp-option-force=
125,00:00:00:00:14:02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55:0d:02:00:2e

烽火HG220G
dhcp-option-force=
125,00:00:00:00:1b:02:06:48:47:57:2d:43:54:03:05:48:47:32:32:31:0a:02:20:00:0b:02:00:55:0d:02:00:2e

烽火HG220GS
dhcp-option-force=
125,00:00:00:00:1d:02:06:48:47:57:2d:43:54:03:07:48:47:32:32:30:47:53:0a:02:20:00:0b:02:00:55:0d:02:00:2e

华勤HGU421N v3
dhcp-option-force=
125,00:00:00:00:20:02:06:48:47:57:2D:43:54:03:0A:48:47:55:34:32:31:4E:20:76:33:0A:02:20:00:0B:02:00:55:0D:02:20:00

贝尔E-140W-P(白色悦me)
dhcp-option-force=
125,00:00:00:00:1a:02:06:48:47:57:2d:43:54:03:08:45:2d:31:34:30:57:2d:50:0b:02:00:55:0a:02:20:00
以上是各种设备抓包结果合计。

去除厂家信息+voice vlanid+修改dhcp-option字长为以下内容
dhcp-option-force=125,00:00:00:00:10:02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55
（最短代码测试通过！！！）

其实就是dhcp-option125+盒子可添加Enterprise ID+dhcp-option数据长度+HGW-CT+untag+iptv vlanid，就完了，其他2个一个是设备厂家名字一个是语音通道都不是重点（没有用iptv打电话吧，不排除以后有iptv视频电话的可能）
感谢 kimkid 提供测试的结果精简后的成果结果。
force=125,00:00:00:00:14:02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55:0d:02:00:2e
其中的14就是dhcp-option其实也可以修改这个是报出内容长度只要大于报文内容都行默认不建议修改以免过段丢数据，抓包抓出来是什么就什么吧。
1a（十六进制）=26个（十进制），同理，16=22个，14=20个，20=32个，1b=27个，1d=29个.,十进制转十六进制
14=02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55:0d:02:00:2e   其中：：中间字符这样就算一个

dhcp-option-force=lan,125,00:00:00:00:10:02:06:48:47:57:2d:43:54:0a:02:20:00:0b:02:00:55
dhcp-option=lan,15
dhcp-option=lan,28
dhcp-option=lan,60,00:00:01:00:02:03:43:50:45:03:0e:45:38:20:47:50:4f:4e:20:52:4f:55:54:45:52:04:03:31:2E:30

其中 dhcp-option=lan,15和dhcp-option=lan,28是针对烽火中兴光猫的，如果其他光猫不能用可以加上试试看、dhcp-option=lan,60是针对华为盒子其他盒子不用，
如果都不行，请自行抓包，抓包方法看上面的教程。








回复 支持 2 反对 0
举报

yangyoung007
2

主题
277

帖子
408

积分
中级魔法师


精华
0
门户文章
0
魔力币
354
魔法值
0
注册时间
2016-4-6
发消息
  楼主| 发表于 2016-4-27 13:48:51 | 显示全部楼层
本帖最后由 yangyoung007 于 2017-1-23 16:50 编辑

感谢以下参考帖 ：

ttp://koolshare.cn/thread-21659-1-1.html 悦me光猫E-140W-P替换华为8245,修改mac地址,成功上网并观看iTV
ttps://wwwchiphell.com/thread-1357194-1-1.html 上海电信光猫桥接自己路由实现IPTV小红或者4K正常功能配置
ttps://wwwchiphell.com/thread-1421026-1-1.html 你们想要的上海电信光猫桥接＋4K IPTV配置流程
ttps://wwwchiphell.com/thread-1356203-1-1.html 中兴ZXHN F450G 桥接模式和4K IPTV共存的办法
ttps://wwwchiphell.com/thread-939443-1-1.html 请教一下，关于上海电信光纤ott+iptv
ttp://koolshare.cn/thread-37102-1-1.html 上海电信完美解决4K IPTV桥接教程 4/16增加华为盒子支持
ttp://koolshare.cn/thread-34659-1-1.html 上海电信4K IPTV 烽火HG680-J 成功实现光猫桥接后正常使用
ttp://koolshare.cn/thread-25919-1-1.html 上海的有IPTV 的用户,请看过来!
ttp://koolshare.cn/thread-36278-1-1.html 上海电信IPTV在ASUS固件中实现讨论
ttp://koolshare.cn/thread-32834-1-1.html 请教asus-ASUS固件中修改VLAN和端口配置，实现4K IPTV数据传输
ttps://wwwchiphell.com/thread-1515345-1-1.html ASUS固件搞定上海电信4k iptv的option125
ttp://koolshare.cn/thread-45810-1-1.html dnsmasq 更加便捷添加iptv规则的方法，附带修正的125Option


------------------------------超级小白教程------------------------

仔细阅读文字内容，不要看着图片内容做重要的事情说三边
仔细阅读文字内容，不要看着图片内容做重要的事情说三边
仔细阅读文字内容，不要看着图片内容做重要的事情说三边

下载dns光猫.pdf 和wan-start.pdf  二个文件 dns光猫.pdf 改为dns.conf 放到/jffs/configs/dnsmasq.d下权限设置成0644,如果/jffs/configs/下没有
dnsmasq.d的目录，直接把dns光猫.pdf 改为dnsmasq.conf.add放到/jffs/configs/下权限设置成0644
wan-start.pdf改为wan-start 放到/jffs/scripts下权限设置成0755

然后重启完成。

如果这样还看不懂你不是小白是得了懒癌。。。工具操作方法上面都有。原理也在上面，包括diy和监测故障方法。

一代懒癌解药------传送门https://koolshare.cn/thread-37102-1-1.html

再懒再不行的话，就别瞎折腾了。别搞了。。。。。。。小白问题不再回复

感谢好心人diskerjtr 研制的最新二代懒癌解药------传送门 https://koolshare.cn/thread-80206-1-1.html

一代不行的可以试试二代，，推荐使用二代，，但不能保证100%可用，，如不行自己更具帖子修改下就ok。。。
